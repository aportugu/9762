---
title: "Axi-cel vs Liso-cel Analysis"
author: "aportugu Portuguese"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  distill::distill_article:
    code_folding: true
    toc: true
    toc_float: true
    self_contained: true
---

# Open libraries

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(gtsummary)
library(dplyr)
library(tidyverse)
library(haven)
library(survival)
library(survminer)
library(lubridate)
library(readxl)
library(janitor)
library(rms)
library(ggplot2)
library(tidycmprsk)
library(ggsurvfit)
library(caret)
library(MatchIt)
library(forester)
library(hrbrthemes)
library(WeightIt)
library(MatchIt)
library(cobalt)
library(survey)
library(ggsignif)

library(marginaleffects)
library(swimplot)
library(RColorBrewer)
```

# Read in data

## Read in tracking spreadsheet

```{r, echo=FALSE, warning=FALSE, message=FALSE}
db = read_excel(path = "Dataset 1.27.24.xlsx")

db <- db %>%
  filter(CAR.T.Product.Type == "Breyanzi" | CAR.T.Product.Type == "Yescarta") %>% # Include both Breyanzi and Yescarta
  filter(Acalabrutinib ==0) %>% # Remove patients treated on FH10418 RG1006269 acalabrutinib + yescarta
  filter(NKTR == 0) %>% # Remove patients treated on FH10802 RG1122036 NKTR-255 + breyanzi
  filter(Anakinra == 0) %>% # Remove patients treated on FH10373 RG1006866 Breyanzi + Anakinra
  filter(Disease != "BL" & Disease != "FL") %>% # Remove BL and FL
  filter(Infused == 1) %>% # Only include patients who received a CAR-T product
  mutate(
    Best.CR = ifelse(Best.response=="CR","1","0"),
    Best.PR = ifelse(Best.response=="PR","1","0"),
    Best.PD = ifelse(Best.response=="PD","1","0"),
    CRS.2.to.4 = ifelse(CRS.grade >=2,"1","0"),
    ICANS.2.to.4 = ifelse(ICANS.grade >=2, "1","0"),
    CRS.grade = factor(CRS.grade, levels = c("0","1","2","3","4")),
    ICANS.grade = factor(ICANS.grade, levels = c("0","1","2","3","4")),
    DOB = ymd(DOB),
    Leuka.date = ymd(Leuka.date),
    LD.date = ymd(LD.date),
    Infusion.Date = ymd(Infusion.Date),
    CRS.date = ymd(CRS.date),
    ICANS.date = ymd(ICANS.date),
    Initial.response.date = ymd(Initial.response.date),
    Date.of.relapse = ymd(Date.of.relapse),
    Date.of.death.or.last.contact = ymd(Date.of.death.or.last.contact),
    CRS.day = as.numeric(ifelse(CRS.grade !=0, CRS.date - Infusion.Date,"")),
    ICANS.day = as.numeric(ifelse(ICANS.grade !=0, ICANS.date - Infusion.Date,"")),
    CRS.ICANS.diff = as.numeric(ifelse(CRS.grade != 0 & ICANS.grade !=0, ICANS.date - CRS.date,"")),
    Days.to.DLC2 = Date.of.death.or.last.contact - Infusion.Date,
    Days.to.relapse2 = Date.of.relapse - Infusion.Date,
    Days.to.response = Initial.response.date - Infusion.Date,
    Vein.to.vein.time = Infusion.Date - Leuka.date,
    Bulky = ifelse(Largest.lesion >=5, "1","0")
    #Best.response = factor(Best.response, levels = c("CR","PR","SD","Mixed","PD","")),
    #Initial.response = factor(Initial.response, levels = c("CR","PR","SD","Mixed","PD",""))
  )

db$Best.CR <- as.factor(db$Best.CR)
db$Best.PR <- as.factor(db$Best.PR)
db$Best.PD <- as.factor(db$Best.PD)
```

## Read in demographic data and join with master dataset

```{r, echo=FALSE, warning=FALSE, message=FALSE}
demographics = read_excel(path = "/Users/aportugu/Desktop/CD19 project/EMR data/demographics/2023.12.13.demographics.xlsx")

dataset <- 
  left_join(
    x = db,
    y = select(demographics, "ArrivalDate", "uwid"),
    by = "uwid"
  )

dataset <- dataset %>%
  mutate(
    ArrivalDate = ymd(ArrivalDate),
    Arrival.to.vein.time = Infusion.Date - ArrivalDate
  )
```

## Read in product order data and join with master dataset

```{r, echo=FALSE, warning=FALSE, message=FALSE}
Order = read_excel(path = "/Users/aportugu/Desktop/CD19 project/EMR data/Order date/Order date.xlsx")

dataset <- 
  left_join(
    x = dataset,
    y = select(Order, "Order.date", "uwid"),
    by = "uwid"
  )

dataset <- dataset %>%
  mutate(
    Order.date = ymd(Order.date),
    Order.to.vein.time = Infusion.Date - Order.date
  )
```

## Read in admissions data and join with master dataset

```{r, echo=FALSE, warning=FALSE, message=FALSE}
admissions = read_excel(path = "/Users/aportugu/Desktop/CD19 project/EMR data/admissions/2023.12.13.Admissions.xlsx")

inpatient.duration.df <- admissions %>% # Data frame for all admissions between days 0 and 30
  filter(admitDay %in% (0:30) & PatientClass == "Inpatient") %>%
  group_by(uwid) %>%
  summarise(inpatient.duration = sum(days), admissions = n())

elective.admission.df <- admissions %>% # Data frame for elective admissions only
  filter(admitDay == 0 & PatientClass == "Inpatient") %>% # Inpatient admission on day 0
  group_by(uwid) %>%
  summarise(elective.duration = sum(days)) %>%
  mutate(elective.admission = 1)

dataset <- # Join all admission data
  left_join(
    x = dataset,
    y = inpatient.duration.df,
    by = "uwid",
  )

dataset <- # Join elective admission data
  left_join(
    x = dataset,
    y = elective.admission.df,
    by = "uwid"
  )

dataset <- dataset %>%
  replace_na(list(inpatient.duration = 0, admissions = 0, elective.duration = 0, elective.admission = 0)) # Get rid of NA values
```

## Read in CBC data

```{r, echo=FALSE, warning=FALSE, message=FALSE}
CBC = read_excel(path = "/Users/aportugu/Desktop/CD19 project/EMR data/labs/2023.12.13.hems.xlsx")

CBC$date = ymd(CBC$date)

CBC.df <- CBC %>% # Data frame for CBCs between days 0 and 30
  filter(anc != "" & day >=0 & day <=30) %>%
  group_by(uwid) %>%
  summarise(CBC.count = n(), WBC.min = min(wbc, na.rm=TRUE) / 1000, Plt.min = min(TotPlateletCnt, na.rm=TRUE) / 1000, Hgb.min = min(HgbAmt, na.rm=TRUE), ANC.min = min(anc, na.rm=TRUE) / 1000, ALC.min = min(lym, na.rm=TRUE) / 1000 )

CBC.30.df <- CBC %>% # Data frame for CBCs between days 0 and 30
  filter(anc != "" & day >=25 & day <=30) %>%
  group_by(uwid) %>%
  slice_max(day, with_ties = FALSE) %>%
  summarise(CBC.count = n(), WBC.30 = max(wbc, na.rm=TRUE) / 1000, Plt.30 = max(TotPlateletCnt, na.rm=TRUE) / 1000, Hgb.30 = max(HgbAmt, na.rm=TRUE), ANC.30 = max(anc, na.rm=TRUE) / 1000, ALC.30 = min(lym, na.rm=TRUE) / 1000 )
  
WBC.nadir.df <- CBC %>%
  filter(wbc != "" & day >=0 & day <=30) %>%
  group_by(uwid) %>%
  slice_min(wbc, with_ties = FALSE) %>%
  transmute(WBC_day_nadir = day)%>%
  select(WBC_day_nadir, uwid)

dataset <- # Join CBC data
  left_join(
    x = dataset,
    y = CBC.df,
    by = "uwid"
  )

dataset <- # Join ANC day nadir
  left_join(
    x = dataset,
    y = WBC.nadir.df,
    by = "uwid"
  )

dataset <- # Join ANC day nadir
  left_join(
    x = dataset,
    y = CBC.30.df,
    by = "uwid"
  )

neutropenic.df <- CBC %>%
  filter(anc != "" & anc <500 & day >=0 & day <=30) %>%
  group_by(uwid) %>%
  summarise(
    neutropenic.days = n()
  )

dataset <- # Join neutropenic days info
  left_join(
    x = dataset,
    y = neutropenic.df,
    by = "uwid"
  ) %>%
  mutate(
    neutropenic.days = ifelse(is.na(neutropenic.days),0,neutropenic.days)
  )


CBC.d0.df <- CBC %>% ## Data frame for day 0
  filter(day == 0) %>%
  group_by(uwid) %>%
  summarise(ANC.d0 = mean(anc, na.rm=TRUE) / 1000, ALC.d0 = mean (lym, na.rm=TRUE) / 1000)

dataset <-
  left_join(
    x = dataset,
    y = CBC.d0.df,
    by = "uwid"
  ) %>%
  mutate(
    ANC.d0 = ifelse(ANC.d0 == "NaN", NA, ANC.d0),
    ALC.d0 = ifelse(ALC.d0 == "NaN", NA, ANC.d0)
  )
```

## Read in other lab data

```{r, echo=FALSE, warning=FALSE, message=FALSE}
labs = read_excel(path = "/Users/aportugu/Desktop/CD19 project/EMR data/labs/2023.12.13.labs.xlsx")

labs$date = ymd(labs$date)

labs.df <- labs %>% # Data frame for labs between days 0 and 30
  filter(day >=0 & day <=30) %>%
  group_by(uwid) %>%
  summarise(labs.count = n() , ALT.max = max(ALT_u_l, na.rm=TRUE), AST.max = max(AST_u_l, na.rm=TRUE), cre.min = min(CRE_mg_dl, na.rm=TRUE), cre.max = max(CRE_mg_dl, na.rm=TRUE), CRP.max = max(CRP_mg_l, na.rm=TRUE), ddimer.max = max(d_dimer, na.rm=TRUE), ferritin.max = max(ferritin_ng_ml, na.rm=TRUE), fibrinogen.min = min(fibrinogen_mg_dl, na.rm=TRUE), IL6.max = max(IL6_pg_ml, na.rm=TRUE), LDH.max = max(LD_u_l, na.rm=TRUE), LDH.min = min(LD_u_l, na.rm=TRUE), trop.max = max(troponin_ng_ml, na.rm=TRUE) ) 

labs.d3.df <- labs %>% ## Data frame for day 3
  filter(day == 3) %>%
  group_by(uwid) %>%
  summarise(ferritin.d3 = mean(ferritin_ng_ml, na.rm=TRUE), LDH.d3 = mean(LD_u_l, na.rm=TRUE), IL6.d3 = max(IL6_pg_ml, na.rm=TRUE),  CRP.d3 = max(CRP_mg_l, na.rm=TRUE))

labs.d0.df <- labs %>% ## Data frame for day 0
  filter(day == 0) %>%
  group_by(uwid) %>%
  summarise(ferritin.d0 = mean(ferritin_ng_ml, na.rm=TRUE), LDH.d0 = mean(LD_u_l, na.rm=TRUE), IL6.d0 = max(IL6_pg_ml, na.rm=TRUE) )

labs.df[sapply(labs.df, is.infinite)] <- NA ## Change any -inf values to NA
labs.d3.df[sapply(labs.d3.df, is.infinite)] <- NA ## Change any -inf values to NA
labs.d0.df[sapply(labs.d0.df, is.infinite)] <- NA ## Change any -inf values to NA

dataset <-
  left_join(
    x = dataset,
    y = labs.df,
    by = "uwid"
  )

dataset <- # Join ANC day nadir
  left_join(
    x = dataset,
    y = labs.d3.df,
    by = "uwid"
  )

dataset <- # Join ANC day nadir
  left_join(
    x = dataset,
    y = labs.d0.df,
    by = "uwid"
  )

```

## Read in blood culture data

```{r, echo=FALSE, warning=FALSE, message=FALSE}
blood.culture = read_excel(path = "/Users/aportugu/Desktop/CD19 project/EMR data/id/2023.12.13.ID_ALL.xlsx")

blood.culture$date = ymd(blood.culture$date)

Pos.BCx <- blood.culture %>%
  select(uwid, bact, organism, date, day) %>%
  group_by(uwid) %>%
  filter(bact == "1" & day >=0) %>%
  distinct() %>%
  slice_min(day) %>%
  transmute(
    uwid,
    Pos.BCx = 1,
    BCx.day = day,
    BCx.date = date,
    BCx.organism = organism,
  )

Pos.CMV <- blood.culture %>%
  select(uwid, viral, organism, date, day, value) %>%
  group_by(uwid) %>%
  filter(organism == "CMV" & day >=0) %>%
  distinct() %>%
  summarise(CMV.first.day = min(day, na.rm = TRUE), CMV.last.day = max(day, na.rm = TRUE), CMV.peak.level = max(value, na.rm = TRUE)) %>%
  mutate(
    CMV = 1
  )

Pos.CMV[sapply(Pos.CMV, is.infinite)] <- NA ## Change any -inf values to NA

dataset <- # Join BCx data
  left_join(
    x = dataset,
    y = Pos.BCx,
    by = "uwid"
  )

dataset <- # Join CMV data
  left_join(
    x = dataset,
    y = Pos.CMV,
    by = "uwid"
  )

dataset <- dataset %>%
  mutate(
    Pos.BCx = ifelse( is.na(Pos.BCx) ,0,Pos.BCx),
    CMV = ifelse( is.na(CMV), 0, CMV ),
    CMV.peak.level = ifelse( is.na(CMV.peak.level), 0, CMV.peak.level)
  )

```

## Determine the baseline pre-LD lab values

```{r, echo=FALSE, warning=FALSE, message=FALSE}

avg = 1

days = 14

CBC.with.LD.date <- # join the LD dates to the CBC dataframe
  left_join(
    x = CBC,
    y = dataset %>% select(uwid, LD.date),
    by = "uwid"
  )

## CBC
preLD.CBC.df <- CBC.with.LD.date %>%
  filter(LD.date >= date & LD.date - date <days & !is.na(wbc) ) %>%
  group_by(uwid) %>%
  slice_min(LD.date - date, n=avg) %>%
  summarise(WBC.preLD = mean(wbc, na.rm=TRUE) / 1000, Plt.preLD = mean(TotPlateletCnt, na.rm=TRUE) / 1000, Hgb.preLD = mean(HgbAmt, na.rm=TRUE))

dataset <- # join pre-LD CBC lab values
  left_join(
    x = dataset,
    y = preLD.CBC.df,
    by = "uwid"
  )

## Differential (ALC and ANC)
preLD.ALC.ANC.df <- CBC.with.LD.date %>%
  filter(LD.date >= date & LD.date - date <days & !is.na(anc) ) %>%
  group_by(uwid) %>%
  slice_min(LD.date - date, n=avg) %>%
  summarise(ANC.preLD = mean(anc, na.rm=TRUE) / 1000, ALC.preLD = mean (lym, na.rm=TRUE) / 1000)

dataset <- # join pre-LD CBC lab values
  left_join(
    x = dataset,
    y = preLD.ALC.ANC.df,
    by = "uwid"
  )



labs.with.LD.date <- # join the LD dates to the labs dataframe
  left_join(
    x = labs,
    y = dataset %>% select(uwid, LD.date),
    by = "uwid"
  )


## LDH
preLD.LDH.df <- labs.with.LD.date %>%
  filter(LD.date >= date & LD.date - date <days & !is.na(LD_u_l) ) %>% 
  group_by(uwid) %>%
  slice_min(LD.date - date, n=avg, na_rm = TRUE) %>%
  summarise(LDH.preLD = mean(LD_u_l, na.rm=TRUE))

dataset <- # join pre-LD lab values
  left_join(
    x = dataset,
    y = preLD.LDH.df,
    by = "uwid"
  )

dataset <- dataset %>%
  mutate(
    High.LDH = ifelse(LDH.preLD >=210,1,0),
    LDH.status = factor( case_when(
      LDH.preLD <210 ~ 0,
      LDH.preLD >=210 & LDH.preLD <=420 ~ 1,
      LDH.preLD >420 ~ 2), 
      levels = c(0,1,2) )
  )



## Renal function
preLD.Cr.df <- labs.with.LD.date %>%
  filter(LD.date >= date & LD.date - date <days & !is.na(CRE_mg_dl) ) %>%
  group_by(uwid) %>%
  slice_min(LD.date - date, n=avg, na_rm = TRUE) %>%
  summarise(cre.preLD = mean(CRE_mg_dl, na.rm=TRUE))

dataset <- # join pre-LD lab values
  left_join(
    x = dataset,
    y = preLD.Cr.df,
    by = "uwid"
  )


## Ferritin
preLD.ferritin.df <- labs.with.LD.date %>%
  filter(LD.date >= date & LD.date - date <days & !is.na(ferritin_ng_ml) ) %>%
  group_by(uwid) %>%
  slice_min(LD.date - date, n=avg, na_rm = TRUE) %>%
  summarise(ferritin.preLD = mean(ferritin_ng_ml, na.rm=TRUE))

dataset <- # join pre-LD lab values
  left_join(
    x = dataset,
    y = preLD.ferritin.df,
    by = "uwid"
  )


## CRP
preLD.CRP.df <- labs.with.LD.date %>%
  filter(LD.date >= date & LD.date - date <days & !is.na(CRP_mg_l) ) %>% 
  group_by(uwid) %>%
  slice_min(LD.date - date, n=avg, na_rm = TRUE) %>%
  summarise(CRP.preLD = mean(CRP_mg_l, na.rm=TRUE))

dataset <- # join pre-LD lab values
  left_join(
    x = dataset,
    y = preLD.CRP.df,
    by = "uwid"
  )

```

## Read in BP data and determine pre-LD baseline

```{r, echo=FALSE, warning=FALSE, message=FALSE}
BP = read_excel(path = "/Users/aportugu/Desktop/CD19 project/EMR data/vs/2023.12.13.BP.xlsx")

BP$date = ymd(BP$date)

BP.post.df <- BP %>% # Data frame for labs between days 0 and 30
  filter(day >=0 & day <=30) %>%
  group_by(uwid) %>%
  summarise( BP.count = n() , SBP.max = max(SBP, na.rm=TRUE), DBP.max = max(DBP, na.rm=TRUE), SBP.min = min(SBP, na.rm=TRUE), DBP.min = min(DBP, na.rm=TRUE) ) 

dataset <- # post-infusion values
  left_join(
    x = dataset,
    y = BP.post.df,
    by = "uwid"
  )


BP.with.LD.date <- # join the LD dates to the BP dataframe
  left_join(
    x = BP,
    y = dataset %>% select(uwid, LD.date),
    by = "uwid"
  )

preLD.BP.df <- BP.with.LD.date %>%
  filter(LD.date >= date & LD.date - date <10) %>% ## Within 14 days prior to LD
  group_by(uwid) %>%
  slice_min(LD.date - date, n=3) %>%
  summarise(SBP.preLD = mean(SBP, na.rm=TRUE), DBP.preLD = mean(DBP, na.rm=TRUE) )

dataset <- # join pre-LD BP lab values
  left_join(
    x = dataset,
    y = preLD.BP.df,
    by = "uwid"
  ) %>%
  mutate(
    MAP.preLD = DBP.preLD + (SBP.preLD - DBP.preLD)/3,
    MAP.min = DBP.min + (SBP.min - DBP.min)/3
  )
```

## Read in tocilizumab data

```{r, echo=FALSE, warning=FALSE, message=FALSE}
toci = read_excel(path = "/Users/aportugu/Desktop/CD19 project/EMR data/meds/2023.12.13.tocilizumab.xlsx")
toci$date = ymd(toci$date)

toci.df <- toci %>%
  select(uwid, date, day, Dose) %>%
  group_by(uwid) %>%
  filter(day >=0) %>%
  summarise(toci.first.day = min(day, na.rm=TRUE), toci.first.date = min(date, na.rm=TRUE), toci.last.day = max(day, na.rm=TRUE), toci.last.date = max(date, na.rm=TRUE), toci.doses = n())

dataset <- # join pre-LD CBC lab values
  left_join(
    x = dataset,
    y = toci.df,
    by = "uwid"
  ) %>%
  mutate(
    toci.doses = ifelse(is.na(toci.doses),0,toci.doses) # Set NA values to 0
  )
```

## Read in dexamethasone data

```{r, echo=FALSE, warning=FALSE, message=FALSE}
dex = read_excel(path = "/Users/aportugu/Desktop/CD19 project/EMR data/meds/2023.12.13.dexamethasone.xlsx")
dex$date = ymd(dex$date)

dex.df <- dex %>%
  select(uwid, date, day, Dose, AdministrationRoute) %>%
  group_by(uwid) %>%
  filter(day >=0 & AdministrationRoute != "Oral" & AdministrationRoute != "PO" & AdministrationRoute != "EYE-Left" & AdministrationRoute != "EYE-Right") %>%
  summarise(dex.first.day = min(day, na.rm=TRUE), dex.first.date = min(date, na.rm=TRUE), dex.last.day = max(day, na.rm=TRUE), dex.last.date = max(date, na.rm=TRUE), dex.doses = n())

dataset <- # join pre-LD CBC lab values
  left_join(
    x = dataset,
    y = dex.df,
    by = "uwid"
  ) %>%
  mutate(
    dex.doses = ifelse(is.na(dex.doses),0,dex.doses) # Set NA values to 0
  )
```

## Read in cefepime data

```{r, echo=FALSE, warning=FALSE, message=FALSE}
cefepime = read_excel(path = "/Users/aportugu/Desktop/CD19 project/EMR data/meds/2023.12.13.cefepime.xlsx")
cefepime$date = ymd(cefepime$date)

cefepime.df <- cefepime %>%
  select(uwid, date, day, Dose) %>%
  group_by(uwid) %>%
  filter(day >=0) %>%
  summarise(cefepime.first.day = min(day, na.rm=TRUE), cefepime.first.date = min(date, na.rm=TRUE), cefepime.last.day = max(day, na.rm=TRUE), cefepime.last.date = max(date, na.rm=TRUE), cefepime.doses = n())

dataset <- # join pre-LD CBC lab values
  left_join(
    x = dataset,
    y = cefepime.df,
    by = "uwid"
  ) %>%
  mutate(
    cefepime.doses = ifelse(is.na(cefepime.doses),0,cefepime.doses) # Set NA values to 0
  )
```

## Read in vancomycin data

```{r, echo=FALSE, warning=FALSE, message=FALSE}
vancomycin = read_excel(path = "/Users/aportugu/Desktop/CD19 project/EMR data/meds/2023.12.13.vancomycin.xlsx")
vancomycin$date = ymd(vancomycin$date)

vancomycin.df <- vancomycin %>%
  select(uwid, date, day, Dose) %>%
  group_by(uwid) %>%
  filter(day >=0) %>%
  summarise(vancomycin.first.day = min(day, na.rm=TRUE), vancomycin.first.date = min(date, na.rm=TRUE), vancomycin.last.day = max(day, na.rm=TRUE), vancomycin.last.date = max(date, na.rm=TRUE), vancomycin.doses = n())

dataset <- # join pre-LD CBC lab values
  left_join(
    x = dataset,
    y = vancomycin.df,
    by = "uwid"
  ) %>%
  mutate(
    vancomycin.doses = ifelse(is.na(vancomycin.doses),0,vancomycin.doses) # Set NA values to 0
  )
```

## Read in norepinephrine data

```{r, echo=FALSE, warning=FALSE, message=FALSE}
norepinephrine = read_excel(path = "/Users/aportugu/Desktop/CD19 project/EMR data/meds/2023.12.13.norepinephrine.xlsx")
norepinephrine$date = ymd(norepinephrine$date)

norepinephrine.df <- norepinephrine %>%
  select(uwid, date, day, Dose) %>%
  group_by(uwid) %>%
  filter(day >=0) %>%
  summarise(norepinephrine.first.day = min(day, na.rm=TRUE), norepinephrine.first.date = min(date, na.rm=TRUE), norepinephrine.last.day = max(day, na.rm=TRUE), norepinephrine.last.date = max(date, na.rm=TRUE), norepinephrine.doses = n())

dataset <- # join pre-LD CBC lab values
  left_join(
    x = dataset,
    y = norepinephrine.df,
    by = "uwid"
  ) %>%
  mutate(
    norepinephrine.doses = ifelse(is.na(norepinephrine.doses),0,norepinephrine.doses) # Set NA values to 0
  )
```

## Read in temp data

```{r, echo=FALSE, warning=FALSE, message=FALSE}
temperature = read_excel(path = "/Users/aportugu/Desktop/CD19 project/EMR data/vs/2023.12.13.temperature.xlsx")
temperature$date = ymd(temperature$date)

fever.df <- temperature %>%
  select(uwid, date, day, temp_C) %>%
  group_by(uwid) %>%
  filter(day >=0 & temp_C >=38) %>%
  summarise(fever.first.day = min(day, na.rm=TRUE), fever.first.date = min(date, na.rm=TRUE), fever.last.day = max(day, na.rm=TRUE), fever.last.date = max(date, na.rm=TRUE), fever.days = n_distinct(day))

dataset <- # join pre-LD CBC lab values
  left_join(
    x = dataset,
    y = fever.df,
    by = "uwid"
  )
```

## Read in ICE score data

```{r, echo=FALSE, warning=FALSE, message=FALSE}
ICE = read_excel(path = "/Users/aportugu/Desktop/CD19 project/EMR data/vs/2023.12.13.ICEscores.xlsx")
ICE$date = ymd(ICE$date)

ICE.df <- ICE %>%
  select(uwid, date, day, ICE.SCORE, ICE.ATTENTION, ICE.FOLLOW.COMMANDS, ICE.NAME.OBJECTS, ICE.ORIENTATION, ICE.WRITING) %>%
  group_by(uwid) %>%
  filter(day >=0) %>%
  summarise(ICE.min = min(ICE.SCORE, na.rm=TRUE), ICE.attention.min = min(ICE.ATTENTION, na.rm=TRUE), ICE.follow.commands.min = min(ICE.FOLLOW.COMMANDS, na.rm=TRUE), ICE.name.objects.min = min(ICE.NAME.OBJECTS, na.rm=TRUE), ICE.orientation.min = min(ICE.ORIENTATION, na.rm=TRUE), ICE.writing.min = min(ICE.WRITING, na.rm=TRUE))

dataset <- # join pre-LD CBC lab values
  left_join(
    x = dataset,
    y = ICE.df,
    by = "uwid"
  )

ICE.less.than.10.df <- ICE %>%
  select(uwid, date, day, ICE.SCORE, ICE.ATTENTION, ICE.FOLLOW.COMMANDS, ICE.NAME.OBJECTS, ICE.ORIENTATION, ICE.WRITING) %>%
  group_by(uwid) %>%
  filter(day >=0 & ICE.SCORE <10) %>%
  summarise(ICE.less.than.10 = n_distinct(day))

dataset <- # join pre-LD CBC lab values
  left_join(
    x = dataset,
    y = ICE.less.than.10.df,
    by = "uwid"
  )
```

## All BP data points

```{r}
BPdata = filter(BP, day >=-15 ) %>%
  select(day, SBP, DBP, time, uwid) %>%
  mutate(
    time.percent = sapply( strsplit(time,":"),
                           function(x) {
                             x <- as.numeric(x)
                             x[1]/24
                           }
    ),
    day = ifelse(day>=0, day + time.percent, day - time.percent),
    MAP = SBP/3 + DBP * 2/3
  )

BPdata <- # join pre-LD CBC lab values
  left_join(
    x = BPdata,
    y = dataset %>%
      select(CAR.T.Product.Type, uwid, Study.No, CRS.grade, ICANS.grade),
    by = "uwid"
  )
```

## All ANC data points

```{r}
CBCdata = filter(CBC, day >=-15 ) %>%
  select(day, ancx, lymx, HgbAmt, TotPlateletCnt, time, uwid) %>%
  mutate(
    time.percent = sapply( strsplit(time,":"),
                           function(x) {
                             x <- as.numeric(x)
                             x[1]/24
                           }
    ),
    day = ifelse(day>=0, day + time.percent, day - time.percent),
  )

CBCdata <-
  left_join(
    x = CBCdata,
    y = dataset %>%
      select(CAR.T.Product.Type, uwid, Study.No),
    by = "uwid"
  )
```

# Propensity scores

## Regression analysis for treatment allocation

```{r}
variables <- c("CAR.T.Product.Type", "Age", "Second.line", "LDH.preLD", "ALC.preLD", "ASCT", "Largest.lesion", "tDLBCL", "ECOG.status", "Extranodal", "Bridging.response.category")

data1 <- dataset %>% 
  drop_na(LDH.preLD, ALC.preLD, Bridging.response.category, ECOG) %>%
  mutate(
    Bulky = ifelse(Largest.lesion >=5,1,0),
    ECOG.status = ifelse(ECOG >=2,1,0),
    ALC.low = ifelse(ALC.preLD <=1,1,0),
    CAR.T.Product.Type = recode(CAR.T.Product.Type, "Breyanzi" = 1, "Yescarta" = 0),
    Bridging.response.category = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD", "3"="Unknown response"), levels = c("No bridging","CR/PR","SD/PD", "Unknown response")),
  )

uv_tab <- tbl_uvregression(
    data1[c(variables)],
    method = glm,
    y = CAR.T.Product.Type,
    method.args = list(family = binomial),
    exponentiate = TRUE
  ) %>%
  sort_p()


mv_tab<-glm(CAR.T.Product.Type ~ Age + Second.line + LDH.preLD + ALC.preLD + ASCT + Largest.lesion + tDLBCL + ECOG.status + Extranodal + Bridging.response.category, data=data1, family=binomial) %>%
  tbl_regression(exponentiate=TRUE)

tbl_merge(list(uv_tab, mv_tab), tab_spanner = c("**Univariate**", "**Multivariable**"))
```

## IPTW
```{r, warning=FALSE}
IPTW.data <- dataset %>% 
  #drop_na(LDH.preLD, ALC.preLD, Bridging.response.category, ECOG) %>%
  mutate(
    Age.65 = ifelse(Age >=65,1,0),
    Male.sex = ifelse(Sex == "M",1,0),
    Bulky = ifelse(Largest.lesion >=5,1,0),
    ECOG.status = ifelse(ECOG >=2,1,0)
  )

## Use the WeightIt function to generate propensity scores and weights
W.out <- weightit(CAR.T.Product.Type ~ Age + Second.line + ASCT + Largest.lesion + tDLBCL + ECOG.status + Extranodal, 
                  data=IPTW.data, 
                  method = "glm", 
                  estimand = "ATE",
                  stabilize = TRUE)
summary = summary(W.out)

bal.tab(W.out, stats = c("m", "v"), thresholds = c(m=0.25), binary = "std")

love.plot(W.out,
          binary = "std",
          line = TRUE, 
          abs = TRUE,
          thresholds = c(m=0.25),
          var.order = "unadjusted",
            var.names = c(
              Age = "Age",
              prop.score = "Distance",
              Male.sex = "Male sex",
              Second.line = "Second line",
              LDH.preLD = "LDH pre-LD",
              ALC.preLD = "ALC pre-LD",
              Bridging = "Bridging",
              ASCT = "Prior ASCT",
              Largest.lesion = "Largest lesion",
              Bridging.response.category = "Bridging response",
              tDLBCL = "tDLBCL vs other",
              ECOG.status = "ECOG\u22652"
          ))

IPTW.data$weights <- W.out$weights * (summary$effective.sample.size$Breyanzi[2] + summary$effective.sample.size$Yescarta[2])/sum(W.out$weights) # Attach normalized weights to a dataset

IPTW.data$ps <- W.out$ps


```

## PSM

```{r}
PSM.data <- dataset %>% 
  #drop_na(LDH.preLD, ALC.preLD, Bridging.response.category, ECOG) %>%
  mutate(
    Age.65 = ifelse(Age >=65,1,0),
    Male.sex = ifelse(Sex == "M",1,0),
    Bulky = ifelse(Largest.lesion >=5,1,0),
    ECOG.status = ifelse(ECOG >=2,1,0),
    Bridging.response.category = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD", "3"="Unknown response"), levels = c("No bridging","CR/PR","SD/PD", "Unknown response")),
    ALC.low = ifelse(ALC.preLD <=1,1,0),
    CAR.T.Product.Type = ifelse(CAR.T.Product.Type == "Breyanzi",1,0)
  )


m.out <- matchit(CAR.T.Product.Type ~ Age + Second.line + ASCT + Largest.lesion + tDLBCL + ECOG.status + Extranodal, data=PSM.data, method = "full", distance = "glm", link = "logit") # Full matching


bal.tab(m.out, stats = c("m", "v"), thresholds = c(m=0.25), binary = "std")


m.out_NN <- matchit(CAR.T.Product.Type ~ Age + Second.line + ASCT + Largest.lesion + tDLBCL + ECOG.status + Extranodal, data=PSM.data, method = "nearest", distance = "glm", link = "logit") # Nearest neighbor matching for comparison


love.plot(m.out, stats = c("m"), abs = TRUE,
          binary = "std",
          drop.distance = FALSE, 
          weights = list(nn = m.out_NN),
          var.order = "unadjusted",
          line = TRUE, 
          thresholds = c(m=0.25, ks = 0.05),
          sample.names = c("Original", "Full Matching", "Nearest Neighbor Matching"),
          position = "bottom",
          var.names = c(
            prop.score = "Distance",
            Bridging = "Bridging",
            LDH.preLD = "LDH pre-LD",
            LDH.status = "LDH status",
            ALC.preLD = "ALC pre-LD",
            Age.62 = "Age \u226562",
            Male.sex = "Male sex",
            Second.line = "Second line",
            ASCT = "Prior ASCT",
            Largest.lesion = "Largest lesion",
            HCT.CI = "HCT-CI",
            ECOG.status = "ECOG \u22652",
            Bridging.response.category = "Bridging response",
            tDLBCL = "tDLBCL vs other"

          )
          )

# Create a dataset with PSM weights using full matching
m.data <- match.data(m.out) %>%
  mutate(
    CAR.T.Product.Type = ifelse(CAR.T.Product.Type == 1, "Breyanzi","Yescarta")
  )

m.data_NN <- match.data(m.out_NN)
```

## Scatterplot of weights

```{r}
ggplot(IPTW.data %>% mutate(Product = CAR.T.Product.Type, Product = recode(Product, "Breyanzi"="Liso-cel","Yescarta"="Axi-cel")), aes(x=ps, y = weights, color = Product)) + 
  geom_point(shape = 16) +
  theme_classic() + 
  labs(x = "Propensity score", y = "Weights") # Add a legend label

ggplot(m.data, aes(x=distance, y = weights, color = CAR.T.Product.Type)) + 
  geom_point(shape = 16) +
  theme_minimal() + 
  ggtitle("PSM") +
  labs(x = "Propensity score", y = "Weights") # Add a legend label
```

# TABLES

## Baseline characteristics

```{r, warning=FALSE, message=FALSE}
theme_gtsummary_compact()

dataset %>%
  transmute(
    #"Age \u226565 years" = ifelse(Age >=65,1,0),
    "Age (years)" = Age,
    "Male sex" = ifelse(Sex == "M", "Yes","No"),
    "ECOG PS" = factor( recode(ECOG, "0"="0-1","1"="0-1","2"="\u22652","3"="\u22652","4"="\u22652"), levels = c("0-1", "\u22652") ),
    "HCT-CI" = HCT.CI,
    "TRANSCEND eligible" = TRANSCEND,
    "Second line" = Second.line,
    "Prior ASCT" = ASCT,
    #"Received bridging" = Bridging,
    "Bridging response category" = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD", "3" = "Unknown response"), levels = c("No bridging","CR/PR","SD/PD", "Unknown response")),
    "Disease subtype" = Disease,
    "LDH" = LDH.preLD,
    "ALC" = ALC.preLD,
    #"Elevated LDH (\u2265210 U/L)" = ifelse(LDH.preLD >=210,"Yes","No"),
    #"LDH status" = factor(recode(LDH.status, "0" = "\u2264ULN", "1" = "[ULN; 2x ULN]", "2"=">2x ULN"), levels = c("\u2264ULN", "[ULN; 2x ULN]", ">2x ULN") ),
    "Largest lesion (cm)" = Largest.lesion,
    #"Bulky (\u22655 cm)" = ifelse(Bulky == 1, "Yes","No"),
    "Extranodal" = ifelse(Extranodal == 1, "Yes","No"),
    "Out-of-spec" = ifelse(EAP == 1,"Yes","No"),
    "Product" = factor(recode(CAR.T.Product.Type, "Breyanzi"= "Liso-cel", "Yescarta" = "Axi-cel"), levels = c("Liso-cel","Axi-cel"))
  ) %>%
  tbl_summary(
    missing = "ifany",
    #sort = all_categorical() ~ "frequency",
    type = c("HCT-CI" = "continuous", "ECOG" = "continuous"),
    #type = c("HCT-CI" = "continuous", "ECOG" = "continuous", "Max CRS grade" = "continuous", "Max ICANS grade" = "continuous", "Total inpatient duration (days)" = "continuous", "Days with fever" ~ "continuous"),
    statistic = list(
      all_continuous() ~ "{median} ({p25}, {p75})",
      all_categorical() ~ "{n} ({p}%)",
      "Age (years)" ~"{median} ({min} to {max})"
      #"Total inpatient duration (days)" ~ "{median} ({min} to {max})"
      #"HCT-CI" ~ "{median} ({min} to {max})"
    )
  ) %>%
  bold_labels

dataset %>%
  transmute(
    #"Age \u226565 years" = ifelse(Age >=65,1,0),
    "Age (years)" = Age,
    "Male sex" = ifelse(Sex == "M", "Yes","No"),
    "ECOG PS" = factor( recode(ECOG, "0"="0-1","1"="0-1","2"="\u22652","3"="\u22652","4"="\u22652"), levels = c("0-1", "\u22652") ),
    "HCT-CI" = HCT.CI,
    "TRANSCEND eligible" = TRANSCEND,
    "Second line" = Second.line,
    "Prior ASCT" = ASCT,
    #"Received bridging" = Bridging,
    "Bridging response category" = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD", "3" = "Unknown response"), levels = c("No bridging","CR/PR","SD/PD", "Unknown response")),
    "Disease subtype" = Disease,
    "LDH" = LDH.preLD,
    "ALC" = ALC.preLD,
    #"Elevated LDH (\u2265210 U/L)" = ifelse(LDH.preLD >=210,"Yes","No"),
    #"LDH status" = factor(recode(LDH.status, "0" = "\u2264ULN", "1" = "[ULN; 2x ULN]", "2"=">2x ULN"), levels = c("\u2264ULN", "[ULN; 2x ULN]", ">2x ULN") ),
    "Largest lesion (cm)" = Largest.lesion,
    #"Bulky (\u22655 cm)" = ifelse(Bulky == 1, "Yes","No"),
    "Extranodal" = ifelse(Extranodal == 1, "Yes","No"),
    "Out-of-specification" = ifelse(EAP == 1,"Yes","No"),
    "Product" = factor(recode(CAR.T.Product.Type, "Breyanzi"= "Liso-cel", "Yescarta" = "Axi-cel"), levels = c("Liso-cel","Axi-cel"))
  ) %>%
  tbl_summary(
    by = "Product",
    missing = "ifany",
    #sort = all_categorical() ~ "frequency",
    type = c("HCT-CI" = "continuous", "ECOG" = "continuous"),
    statistic = list(
      all_continuous() ~ "{median} ({p25}, {p75})",
      all_categorical() ~ "{n} ({p}%)",
      "Age (years)" ~"{median} ({min} to {max})"
    )
  ) %>%
  modify_spanning_header(all_stat_cols() ~ "**CAR-T Treatment**") %>%
  modify_header(all_stat_cols() ~ "**{level}**<br>N = {n} ({style_percent(p)}%)") %>%
  bold_labels %>%
  add_p() %>%
  add_stat_label()
```

## IPTW weighted data table
```{r}
theme_gtsummary_compact()
data1 = IPTW.data %>%
  mutate(
    "Age (years)" = Age,
    Male.sex = ifelse(Sex == "M", "Yes","No"),
    ECOG = factor( recode(ECOG, "0"="0-1","1"="0-1","2"="\u22652","3"="\u22652","4"="\u22652"), levels = c("0-1", "\u22652") ),
    Bridging = factor(recode(Bridging.response.category, "0"="No bridging","1"="CR/PR","2"="SD/PD","3"="Unknown response"), levels = c("No bridging","CR/PR","SD/PD", "Unknown response")),
    Product = factor(recode(CAR.T.Product.Type, "Breyanzi"= "Liso-cel", "Yescarta" = "Axi-cel"), levels = c("Liso-cel","Axi-cel")),
  )

  survey::svydesign(
    id = ~0,
    weights = ~weights,
    data = data1,
    fpc = NULL
  ) %>%
  tbl_svysummary(
    by = Product,
    missing = "ifany",
    statistic = list(
      all_continuous() ~ "{median} ({p25}, {p75})",
      all_categorical() ~ "{n} ({p}%)"),
    include = c(Age, Male.sex, ECOG, HCT.CI, TRANSCEND, Second.line, ASCT, Disease, LDH.preLD, ALC.preLD, Largest.lesion, Extranodal, Bridging, EAP),
    label = list(
      Male.sex ~ "Male sex",
      HCT.CI ~ "HCT-CI",
      Second.line ~ "Second line",
      LDH.preLD ~ "LDH",
      ALC.preLD ~ "ALC",
      Largest.lesion ~ "Largest lesion (cm)",
      Bridging ~ "Bridging response category"
    ),
  ) %>%
  add_p() %>%
    bold_labels()#%>%
  #sort_p()

```



## Reasons ineligible for TRANSCEND

```{r}
data <- dataset %>%
  distinct() %>%
  filter(TRANSCEND == 0 & !is.na(Rationale.category) ) %>%
  count(Rationale.category) %>%
  mutate(
    pct = prop.table(n) * 100
    )

data %>%
  ggplot() +
  aes(x = "", y = pct, fill = reorder(Rationale.category, -pct)) +
  geom_col(position = 'stack', width = 1) +
  coord_polar("y") +
  xlab(NULL) +
  ylab(NULL) +
  theme_void() +
  scale_fill_brewer(palette = "Pastel2") +
  geom_text(aes(x = 1.3, label = paste0(sprintf("%1.f", pct), "%", "\u000A", "n=", n)), position = position_stack(vjust = 0.5), size = 5) +
  theme(axis.text.x = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 16),
        legend.title = element_text(size = 16)) +  # Set legend title font size and make it bold
  labs(fill = paste0("Primary reason (N = ", tally(filter(dataset, TRANSCEND==0))$n, ")" ) )
```

## Time to product infusion

```{r, warning=FALSE, message=FALSE}
theme_gtsummary_compact()

dataset %>%
  #filter(Largest.lesion !=0) %>% #only include measurable disease
  filter(Infused == 1) %>%
  transmute(
    "Product" = factor(recode(CAR.T.Product.Type, "Breyanzi"= "Liso-cel", "Yescarta" = "Axi-cel"), levels = c("Liso-cel","Axi-cel")),
    "Vein-to-vein time (days)" = Vein.to.vein.time,
    "Arrival-to-infusion time (days)" = Arrival.to.vein.time,
    "Order-to-infusion time (days)" = Order.to.vein.time,
    #"Total inpatient duration (days)" = inpatient.duration,
  ) %>%
  tbl_summary(
    by = "Product",
    missing = "no",
    statistic = list(
      all_continuous() ~ "{median} ({p25}, {p75})",
      all_categorical() ~ "{n} ({p}%)"
    )
  ) %>%
  bold_labels %>%
  add_p() %>%
  add_stat_label()
```

## Pre-LD lab values

```{r, warning=FALSE, message=FALSE}
theme_gtsummary_compact()

dataset %>%
  filter(LD == 1) %>%
  transmute(
    "Pre-LD WBC (10\U00B3/\U00B5L)" = WBC.preLD,
    "Pre-LD Plt (10\U00B3/\U00B5L)" = Plt.preLD,
    "Pre-LD Hgb (g/dL)" = Hgb.preLD,
    "Pre-LD ANC (10\U00B3/\U00B5L)" = ANC.preLD,
    "ALC pre-LD (10\U00B3/\U00B5L)" = ALC.preLD,
    "Pre-LD ferritin (ng/mL)" = ferritin.preLD,
    "Pre-LD cre (mg/dL)" = cre.preLD,
    "LDH pre-LD (U/L)" = LDH.preLD,
    "Product" = CAR.T.Product.Type,
  ) %>%
  tbl_summary(
    by = "Product",
    missing = "no",
    #sort = all_categorical() ~ "frequency",
    statistic = list(
      all_continuous() ~ "{median} ({p25}, {p75})",
      all_categorical() ~ "{n} ({p}%)"
    )
  ) %>%
  bold_labels %>%
  add_p() %>%
  sort_p() %>%
  add_stat_label()

```

## Admission characteristics

```{r, warning=FALSE, message=FALSE}
theme_gtsummary_compact()

dataset %>%
  filter(Infused == 1) %>%
  transmute(
    "Product" = CAR.T.Product.Type,
    "Vein-to-vein time (days)" = Vein.to.vein.time,
    "Order-to-vein time (days)" = Order.to.vein.time,
    "Arrival-to-vein time (days)" = Arrival.to.vein.time,
    "# of admissions" = admissions,
    '2+ admissions' = ifelse(admissions>=2, 1, 0),
    "Elective admission" = recode(elective.admission, "1" = "Yes", "0" = "No"),
    "Total inpatient duration (days)" = inpatient.duration,
    "Elective duration (days)" = elective.duration,
    "Non-elective duration (days)" = inpatient.duration - elective.duration,
  ) %>%
  tbl_summary(
    by = "Product",
    missing = "no",
    #sort = all_categorical() ~ "frequency",
    type = c("Elective duration (days)" ~ "continuous"),
    statistic = list(
      all_continuous() ~ "{median} ({p25}, {p75})",
      all_categorical() ~ "{n} ({p}%)",
      "Elective duration (days)" ~ "{median} ({min} to {max})",
      "Non-elective duration (days)" ~ "{median} ({min} to {max})",
      "Total inpatient duration (days)" ~ "{median} ({min} to {max})"
    )
  ) %>%
  bold_labels %>%
  add_p() %>%
  add_stat_label()
```

## Vein-to-vein histogram

```{r, warning=FALSE}
Median_breyanzi_vv = signif(median(as.numeric(filter(dataset, CAR.T.Product.Type == "Breyanzi")$Vein.to.vein.time)), 2)
Median_yescarta_vv = signif(median(as.numeric(filter(dataset, CAR.T.Product.Type == "Yescarta")$Vein.to.vein.time)), 2)

histogram_vv <- dataset %>%
  mutate(CAR.T.Product.Type = recode(CAR.T.Product.Type,"Breyanzi" = "Liso-cel","Yescarta" = "Axi-cel")) %>%
  ggplot( aes(x=as.numeric(Vein.to.vein.time), fill=CAR.T.Product.Type) )  +
    geom_histogram( color="#e9ecef", alpha=0.6, position = 'identity', binwidth=7) +
    scale_fill_manual(values = c("#69b3a2", "#404080"), guide = "none") +  # Remove the legend
    theme_classic() +
    labs(fill="") + 
  geom_vline(aes(xintercept = Median_yescarta_vv),
             linetype = "dashed", color = "#69b3a2", linewidth = 0.75)+ 
  geom_vline(aes(xintercept = Median_breyanzi_vv),
             linetype = "dashed", color = "#404080", linewidth = 0.75) +
  xlim(10, 70)+
  xlab("Vein-to-vein time (days)") + 
  ylab("Number of patients") + 
  annotate("text", label=Median_yescarta_vv, x = Median_yescarta_vv +3, y = 61, color = "#69b3a2") + 
  annotate("text", label=Median_breyanzi_vv, x = Median_breyanzi_vv +3, y = 61, color = "#404080") + 
  theme(legend.position = c(0.8, 0.8)) + 
  theme(
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 16),
    legend.title = element_text(size = 16),
    legend.text = element_text(size = 14)
  ) + 
    annotate("text", x = 45, y = 55, label = sprintf("p <.001"), size = 5)
histogram_vv

```

## Age histogram

```{r, warning=FALSE}

Median_breyanzi_age = signif(median(as.numeric(filter(dataset, CAR.T.Product.Type == "Breyanzi")$Age)), 2)
Median_yescarta_age = signif(median(as.numeric(filter(dataset, CAR.T.Product.Type == "Yescarta")$Age)), 2)

histogram_age <- dataset %>%
  mutate(CAR.T.Product.Type = recode(CAR.T.Product.Type,"Breyanzi" = "Liso-cel","Yescarta" = "Axi-cel")) %>%
  ggplot( aes(x=as.numeric(Age), fill=CAR.T.Product.Type) )  +
    geom_histogram( color="#e9ecef", alpha=0.6, position = 'identity', binwidth=5) +
    scale_fill_manual(values=c("#69b3a2", "#404080")) +
    theme_classic() +
    labs(fill="") + 
  geom_vline(aes(xintercept = Median_yescarta_age),
             linetype = "dashed", color = "#69b3a2", linewidth = 0.75)+ 
  geom_vline(aes(xintercept = Median_breyanzi_age),
             linetype = "dashed", color = "#404080", linewidth = 0.75) +
  xlim(20, 90)+
  xlab("Age (years)") + 
  ylab("Number of patients") + 
  annotate("text", label=Median_yescarta_age, x = Median_yescarta_age +3, y = 22, color = "#69b3a2") + 
  annotate("text", label=Median_breyanzi_age, x = Median_breyanzi_age +3, y = 22, color = "#404080") + 
  theme(legend.position = c(0.87, 0.8)) + 
  theme(
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 16),
    legend.title = element_text(size = 16),
    legend.text = element_text(size = 12)
  ) + 
    annotate("text", x = 50, y = 20, label = sprintf("p <.001"), size = 5)
histogram_age
```

## Combined histogram
```{r}
ggarrange(histogram_vv, histogram_age, ncol = 2, labels = c("A", "B"))
```


## Table for response

```{r, warning=FALSE, message=FALSE}
theme_gtsummary_compact()

data1 <- dataset %>%
  mutate(
    CAR.T.Product.Type = recode(CAR.T.Product.Type, "Breyanzi" = "Liso-cel","Yescarta" = "Axi-cel")
  )

tbl1 <- data1 %>%
  filter(Infused == 1) %>%
  filter(Response.evaluable ==1) %>% #only include measurable disease
  transmute(
    "Product" = CAR.T.Product.Type,
    "Initial response" = Initial.response,
    "Best response" = Best.response,
    "Progressive disease" = recode(Best.PD,"0"="No","1"="Yes"),
    "ORR" = ifelse(Best.response == "CR" | Best.response == "PR",1,0)
  ) %>%
  tbl_summary(
    by = "Product",
    missing = "no",
    #sort = all_categorical() ~ "frequency",
    statistic = list(
      all_continuous() ~ "{median} ({p25}, {p75})",
      all_categorical() ~ "{n} ({p}%)"
    )
  ) %>%
  bold_labels %>%
  add_p() %>%
  add_stat_label()

tbl2 <- data1 %>%
  filter(Infused == 1) %>%
  transmute(
    "Product" = CAR.T.Product.Type,
    "Initial response" = Initial.response,
    "Best response" = Best.response,
    "Progressive disease" = recode(Best.PD,"0"="No","1"="Yes"),
    "ORR" = ifelse(Best.response == "CR" | Best.response == "PR",1,0)
  ) %>%
  tbl_summary(
    by = "Product",
    missing = "no",
    #sort = all_categorical() ~ "frequency",
    statistic = list(
      all_continuous() ~ "{median} ({p25}, {p75})",
      all_categorical() ~ "{n} ({p}%)"
    )
  ) %>%
  bold_labels %>%
  add_p() %>%
  add_stat_label()

tbl_merge(
  tbls = list(tbl1, tbl2),                          # combine
  tab_spanner = c("**Response evaluable**", "**All patients**")) # set header names
```

## IPTW weighted response table
```{r}
theme_gtsummary_compact()
data1 = IPTW.data %>%
  transmute(
    "Product" = recode(CAR.T.Product.Type, "Breyanzi"="Liso-cel","Yescarta"="Axi-cel"),
    "Initial response" = Initial.response,
    "Best response" = Best.response,
    "Progressive disease" = as.factor( recode(Best.PD,"0"="No","1"="Yes") ),
    "ORR" = ifelse(Best.response == "CR" | Best.response == "PR",1,0),
    weights,
    Response.evaluable
  )


tbl1<-  survey::svydesign(
    id = ~0,
    weights = ~weights,
    data = filter(data1, Response.evaluable==1), # Only include measurable disease
    fpc = NULL
  ) %>%
  tbl_svysummary(
    by = Product,
    missing = "ifany",
    statistic = list(
      all_continuous() ~ "{median} ({p25}, {p75})",
      all_categorical() ~ "{n} ({p}%)"),
    include = c("Initial response", "Best response", "Progressive disease", "ORR")
  ) %>%
  bold_labels() %>%
  add_p()

tbl2<-  survey::svydesign(
    id = ~0,
    weights = ~weights,
    data = data1, # Include response evaluable and all patients
    fpc = NULL
  ) %>%
  tbl_svysummary(
    by = Product,
    missing = "ifany",
    statistic = list(
      all_continuous() ~ "{median} ({p25}, {p75})",
      all_categorical() ~ "{n} ({p}%)"),
    include = c("Initial response", "Best response", "Progressive disease", "ORR")
  ) %>%
  bold_labels() %>%
  add_p()
  
  
tbl_merge(
  tbls = list(tbl1, tbl2),                          # combine
  tab_spanner = c("**Response evaluable**", "**All patients**")) # set header names
```

## Table for toxicity
```{r, warning=FALSE, message=FALSE}
theme_gtsummary_compact()

dataset %>%
  filter(Infused == 1) %>%
  transmute(
    "Product" = CAR.T.Product.Type,
    #"Max CRS grade" = CRS.grade,
    "CRS any grade" = ifelse( CRS.grade != 0, 1, 0),
    "CRS grade 3-4" = ifelse( CRS.grade ==3 | CRS.grade == 4, 1, 0),
    "Time to CRS (days)" = CRS.day,
    #"Max ICANS grade" = ICANS.grade,
    "ICANS any grade" = ifelse( ICANS.grade != 0,1,0),
    "ICANS grade 3-4" = ifelse( ICANS.grade ==3 | ICANS.grade == 4,1,0),
    "Days with fever" = fever.days,
    "Fever 1st day" = fever.first.day,
    "Time to ICANS (days)" = ICANS.day,
    "Toci doses" = toci.doses,
    "Received toci" = ifelse(toci.doses !=0,1,0),
    "Dex doses" = dex.doses,
    "Received dex" = ifelse(dex.doses !=0,1,0),
    "ICE score min" = ICE.min
  ) %>%
  tbl_summary(
    by = "Product",
    missing = "no",
    #sort = all_categorical() ~ "frequency",
    statistic = list(
      all_continuous() ~ "{median} ({p25}, {p75})",
      all_categorical() ~ "{n} ({p}%)"
      #"Time to ICANS (days)" ~ "{median} ({min}, {max})"
    ),
    type = list("Toci doses" ~ "continuous", "ICE score min" ~ "continuous", "Dex doses" ~ "continuous", "Time to ICANS (days)" ~ "continuous")
  ) %>%
  bold_labels %>%
  add_p() %>%
  add_stat_label()
```

## IPTW weighted toxicity table
```{r}
theme_gtsummary_compact()
data1 = IPTW.data %>%
  transmute(
    "Product" = recode(CAR.T.Product.Type, "Breyanzi"="Liso-cel","Yescarta"="Axi-cel"),
    #"Max CRS grade" = CRS.grade,
    "CRS any grade" = ifelse( CRS.grade != 0, 1, 0),
    "CRS grade 3-4" = ifelse( CRS.grade ==3 | CRS.grade == 4, 1, 0),
    "Time to CRS (days)" = CRS.day,
    #"Max ICANS grade" = ICANS.grade,
    "ICANS any grade" = ifelse( ICANS.grade != 0,1,0),
    "ICANS grade 3-4" = ifelse( ICANS.grade ==3 | ICANS.grade == 4,1,0),
    "Days with fever" = fever.days,
    "Fever 1st day" = fever.first.day,
    "Time to ICANS (days)" = ICANS.day,
    "Toci doses" = as.numeric(toci.doses),
    "Received toci" = ifelse(toci.doses !=0,1,0),
    "Dex doses" = as.numeric(dex.doses),
    "Received dex" = ifelse(dex.doses !=0,1,0),
    "ICE score min" = ICE.min,
    weights
  )


survey::svydesign(
    id = ~0,
    weights = ~weights,
    data = data1,
    fpc = NULL
  ) %>%
  tbl_svysummary(
    by = Product,
    missing = "no",
    statistic = list(
      all_continuous() ~ "{median} ({p25}, {p75})",
      all_categorical() ~ "{n} ({p}%)"),
    include = c("CRS any grade","CRS grade 3-4","ICANS any grade","ICANS grade 3-4")
  ) %>%
  bold_labels %>%
  add_p()

```

## Table for ID complications

```{r, warning=FALSE, message=FALSE}
theme_gtsummary_compact()

dataset %>%
  transmute(
    "Product" = CAR.T.Product.Type,
    "Positive BCx" = Pos.BCx,
    "Positive CMV" = CMV,
    "CMV level detectable" = ifelse(CMV.peak.level >0, 1, 0),
    "CMV duration" = CMV.last.day - CMV.first.day,
    "Cefepime doses" = cefepime.doses,
    "Received cefepime" = ifelse(cefepime.doses >=1,1,0),
    "Vancomycin doses" = vancomycin.doses
  ) %>%
  tbl_summary(
    by = "Product",
    missing = "no",
    #sort = all_categorical() ~ "frequency",
    statistic = list(
      all_continuous() ~ "{median} ({p25}, {p75})",
      all_categorical() ~ "{n} ({p}%)"
    )
  ) %>%
  bold_labels %>%
  add_p() %>%
  add_stat_label() %>%
  sort_p()
```

## Table for post-infusion cytopenias

```{r, warning=FALSE, message=FALSE}
theme_gtsummary_compact()

data1 <- dataset %>%
  mutate(
    CAR.T.Product.Type = recode(CAR.T.Product.Type,"Breyanzi"="Liso-cel","Yescarta"="Axi-cel")
  )

data1 %>%
  filter(Infused == 1) %>%
  transmute(
    "Product" = CAR.T.Product.Type,
    "WBC min (10\U00B3/\U00B5L)" = WBC.min,
    "WBC nadir day" = WBC_day_nadir,
    "ANC min (10\U00B3/\U00B5L)" = ANC.min,
    "ANC <500 (cells/\U00B5L)" = ifelse(ANC.min <0.5, "Yes","No"),
    "Hgb min (g/dL)" = Hgb.min,
    "Plt min (10\U00B3/\U00B5L)" = Plt.min,
    "Neutropenic time (days)" = neutropenic.days
  ) %>%
  tbl_summary(
    by = "Product",
    missing = "no",
    #sort = all_categorical() ~ "frequency",
    statistic = list(
      all_continuous() ~ "{median} ({p25}, {p75})",
      all_categorical() ~ "{n} ({p}%)"
    )
  ) %>%
  bold_labels %>%
  add_p() %>%
  add_stat_label() %>%
  sort_p()
```

## Table for day 30 counts

```{r, warning=FALSE, message=FALSE}
theme_gtsummary_compact()

data1 <- dataset %>%
  mutate(
    CAR.T.Product.Type = recode(CAR.T.Product.Type,"Breyanzi"="Liso-cel","Yescarta"="Axi-cel")
  )

data1 %>%
  transmute(
    "Product" = CAR.T.Product.Type,
    "WBC d30 (10\U00B3/\U00B5L)" = WBC.30,
    "ANC d30 (10\U00B3/\U00B5L)" = ANC.30,
    "ALC d30 (10\U00B3/\U00B5L)" = ALC.30,
    "ANC <500 (cells/\U00B5L)" = ifelse(ANC.30 <0.5, "Yes","No"),
    "Hgb d30 (g/dL)" = Hgb.30,
    "Plt d30 (10\U00B3/\U00B5L)" = Plt.30,
  ) %>%
  tbl_summary(
    by = "Product",
    missing = "no",
    #sort = all_categorical() ~ "frequency",
    statistic = list(
      all_continuous() ~ "{median} ({p25}, {p75})",
      all_categorical() ~ "{n} ({p}%)"
    )
  ) %>%
  bold_labels %>%
  add_p() %>%
  add_stat_label() %>%
  sort_p()
```

## Table for post-infusion inflammatory markers and other labs

```{r, warning=FALSE, message=FALSE}
theme_gtsummary_compact()

dataset %>%
  mutate(
    CAR.T.Product.Type = recode(CAR.T.Product.Type,"Breyanzi"="Liso-cel","Yescarta"="Axi-cel")
  ) %>%
  transmute(
    "Product" = CAR.T.Product.Type,
    "ALT max (U/L)" = ALT.max,
    "AST max (U/L)" = AST.max,
    "CRP max (mg/L)" = CRP.max,
    "D-dimer max (mg/L)" = ddimer.max,
    "Ferritin max (ng/mL)" = ferritin.max,
    "IL6 max (pg/mL)" = IL6.max,
    "LDH max (U/L)" = LDH.max
  ) %>%
  tbl_summary(
    by = "Product",
    missing = "no",
    #sort = all_categorical() ~ "frequency",
    statistic = list(
      all_continuous() ~ "{median} ({p25}, {p75})",
      all_categorical() ~ "{n} ({p}%)"
    )
  ) %>%
  bold_labels %>%
  add_p() %>%
  add_stat_label() %>%
  sort_p()
```

## Table for post-infusion inflammatory markers and other labs, stratified by product and CRS

```{r, warning=FALSE, message=FALSE}
theme_gtsummary_compact()

dataset %>%
  mutate(
    CAR.T.Product.Type = recode(CAR.T.Product.Type, "Breyanzi" = "Liso-cel", "Yescarta" = "Axi-cel")
  ) %>%
  transmute(
    "ALT max (U/L)" = ALT.max,
    "AST max (U/L)" = AST.max,
    "CRP max (mg/L)" = CRP.max,
    "D-dimer max (mg/L)" = ddimer.max,
    "Ferritin max (ng/mL)" = ferritin.max,
    "IL6 max (pg/mL)" = IL6.max,
    "LDH max (U/L)" = LDH.max,
    CRS.grade = recode(CRS.grade, "0" = "0", "1" = "1-2", "2" = "1-2", "3" = "3+", "4" = "3+")
  ) %>%
  tbl_summary(
    by = CRS.grade,
    missing = "no",
    statistic = list(
      all_continuous() ~ "{median} ({p25}, {p75})",
      all_categorical() ~ "{n} ({p}%)"
    )
  ) %>%
  modify_spanning_header(all_stat_cols() ~ "**CRS grade**") %>%
  modify_header(all_stat_cols() ~ "**{level}**<br>N = {n} ({style_percent(p)}%)") %>%
  bold_labels() %>%
  add_p() %>%
  add_stat_label()

dataset %>%
  mutate(
    CAR.T.Product.Type = recode(CAR.T.Product.Type, "Breyanzi" = "Liso-cel", "Yescarta" = "Axi-cel")
  ) %>%
  transmute(
    "ALT max (U/L)" = ALT.max,
    "AST max (U/L)" = AST.max,
    "CRP max (mg/L)" = CRP.max,
    "D-dimer max (mg/L)" = ddimer.max,
    "Ferritin max (ng/mL)" = ferritin.max,
    "IL6 max (pg/mL)" = IL6.max,
    "LDH max (U/L)" = LDH.max,
    ICANS.grade = recode(ICANS.grade, "0" = "0", "1" = "1-2", "2" = "1-2", "3" = "3+", "4" = "3+")
  ) %>%
  tbl_summary(
    by = ICANS.grade,
    missing = "no",
    statistic = list(
      all_continuous() ~ "{median} ({p25}, {p75})",
      all_categorical() ~ "{n} ({p}%)"
    )
  ) %>%
  modify_spanning_header(all_stat_cols() ~ "**ICANS grade**") %>%
  modify_header(all_stat_cols() ~ "**{level}**<br>N = {n} ({style_percent(p)}%)") %>%
  bold_labels() %>%
  add_p() %>%
  add_stat_label()

```

## Table for cardiac/BP results

```{r, warning=FALSE, message=FALSE}
theme_gtsummary_compact()

dataset %>%
  mutate(
    CAR.T.Product.Type = recode(CAR.T.Product.Type,"Breyanzi"="Liso-cel","Yescarta"="Axi-cel")
  ) %>%
  transmute(
    "Product" = CAR.T.Product.Type,
    "Pre-LD SBP (mmHg)" = SBP.preLD,
    "Pre-LD DBP (mmHg)" = DBP.preLD,
    "Pre-LD MAP (mmHg)" = MAP.preLD,
    "Max SBP drop (mmHg)" = SBP.preLD - SBP.min,
    "Max DBP drop (mmHg)" = DBP.preLD - DBP.min,
    "Max MAP drop (mmHg)" = MAP.preLD - MAP.min,
    "Positive troponin (\u22650.03 ng/mL)" = ifelse(!is.na(trop.max) & trop.max >=0.03,1,0) 
  ) %>%
  tbl_summary(
    by = "Product",
    missing = "no",
    #sort = all_categorical() ~ "frequency",
    statistic = list(
      all_continuous() ~ "{median} ({p25}, {p75})",
      all_categorical() ~ "{n} ({p}%)"
    )
  ) %>%
  bold_labels %>%
  add_p() %>%
  add_stat_label() %>%
  sort_p()
```

# STACKED BAR GRAPH

## Stacked bar graph of toxicity for liso-cel and axi-cel

```{r, warning=FALSE, message=FALSE}
combined_data <- rbind(
  dataset %>%
    count(CAR.T.Product.Type, CRS.grade) %>%
    group_by(CAR.T.Product.Type) %>%
    mutate(
      total = sum(n[CRS.grade != 0]),
      pct = prop.table(n) * 100,
      total_pct = sum(pct[CRS.grade != 0]),
      Grade = factor(CRS.grade, levels = c(0, 4, 3, 2, 1)),
      CAR.T.Product.Type = recode(CAR.T.Product.Type, "Breyanzi" = "Liso-cel", "Yescarta" = "Axi-cel"),
      Category = "CRS"
    ),
  dataset %>%
    count(CAR.T.Product.Type, ICANS.grade) %>%
    group_by(CAR.T.Product.Type) %>%
    mutate(
      total = sum(n[ICANS.grade != 0]),
      pct = prop.table(n) * 100,
      total_pct = sum(pct[ICANS.grade != 0]),
      Grade = factor(ICANS.grade, levels = c(0, 4, 3, 2, 1)),
      CAR.T.Product.Type = recode(CAR.T.Product.Type, "Breyanzi" = "Liso-cel", "Yescarta" = "Axi-cel"),
      Category = "ICANS"
    )
)

ggplot(combined_data) +
  aes(x = CAR.T.Product.Type, y = pct, fill = Grade) +
  geom_bar(stat = "identity", position = "stack", data = . %>% filter(Grade != 0)) +
    geom_text(aes(label = paste0(sprintf("%1.1f", pct), "% (",n,")")), 
            data = . %>% filter(Grade != 0),
            position = position_stack(vjust = 0.5)) + 
  geom_text( aes(label = paste0(sprintf("%1.1f", total_pct), "% (",total,")"), x = CAR.T.Product.Type, y = total_pct + 7, vjust = 0), 
             data = . %>% filter(Grade != 0),
             color = "#104a8e") +
  #geom_text(aes(label = paste0(sprintf("%1.1f", pct), "% (", n, ")")), position = position_dodge(width = 0.9), vjust = 0.5) +
  #geom_text(aes(label = paste0(sprintf("%1.1f", total_pct), "% (", total, ")"), y = total_pct + 7), color = "#104a8e") +
  facet_wrap(~Category, scales = "free_y") +
  ylab("Proportion of patients (%)") +
  xlab(NULL) +
  #ggtitle("Comparison of CRS and ICANS grades") +
  theme_classic()+
  scale_fill_brewer(palette = "Pastel1") +
  scale_y_continuous(breaks = seq(0, 100, by = 20), limits = c(0, 100)) +
  theme(
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 16),
    legend.title = element_text(size = 16),
    legend.text = element_text(size = 14),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

# COMPETING RISK ANALYSIS

## Cumulative incidence of death

```{r}
theme_gtsummary_compact()

data1 <- filter(dataset, Infused == 1) %>%
  select(Days.to.DLC, Alive.RM.NRM, CAR.T.Product.Type, Age, Largest.lesion, ALC.preLD, HCT.CI, LDH.preLD) %>%
  mutate(
   Alive.RM.NRM = as.factor(recode(Alive.RM.NRM,"0"="Alive","1"="Death from cancer","2"="Death from other causes")),
   CAR.T.Product.Type = factor(recode(CAR.T.Product.Type, "Breyanzi" = "Liso-cel", "Yescarta" = "Axi-cel"), levels = c("Liso-cel","Axi-cel") ),
   Months.to.DLC = Days.to.DLC/30
  )

cum <- tidycmprsk::cuminc(Surv( Months.to.DLC , Alive.RM.NRM) ~ CAR.T.Product.Type, data1, rho=0, conf.level=0.95)

cum %>%
  ggcuminc(
   #risk.table=TRUE,
   theme = theme_classic(),
   outcome = c("Death from cancer","Death from other causes")
  ) +
  labs(
    x = "Time (months)",
    y = "Probability of death"
  ) +
  ylim(0,1) +
  scale_x_continuous(breaks = seq(0, 36, by = 6), limits=c(0, 36)) +
  #add_confidence_interval() + 
  add_risktable(
    size = 5,
    risktable_stats = c("n.risk"),
    risktable_height = 0.2,
    stats_label = c("Number at risk"),
    theme = theme_risktable_default(axis.text.y.size = 14, plot.title.size = 14)
  )+ 
  add_pvalue() + 
  theme(
    legend.position =  c(0.22, 0.8),
    text = element_text(size = 16)  # Set text size to 16
  )


cum %>%
  tbl_cuminc(
    times = c(12),
    outcomes = c("Death from cancer","Death from other causes"),
    label_header = c("**{time}-month cuminc**")
  ) %>%
  add_p()

uv_tab<-crr(Surv(Days.to.DLC, Alive.RM.NRM) ~ CAR.T.Product.Type, data = data1) %>%
  tbl_regression(exp = TRUE)

mv_tab<-crr(Surv(Days.to.DLC, Alive.RM.NRM) ~ CAR.T.Product.Type + Age + Largest.lesion + ALC.preLD + LDH.preLD, data = data1) %>%
  tbl_regression(exp = TRUE)


tbl_merge(
  tbls = list(uv_tab, mv_tab),                          # combine
  tab_spanner = c("**Univariate**", "**Multivariable**")) # set header names
```

# KAPLAN-MEIER ANALYSIS

## Calculate length of follow-up

```{r}
library(prodlim)
library(haven)

data1 = dataset %>%
  mutate(
    Reverse_death = ifelse(Death == 1, 0,1)
  )

#quantile(prodlim(Hist(time = Days.to.DLC/30, Death )~1, data = data1, reverse = TRUE ) )

reverse_km_OS <- survfit(Surv(Days.to.DLC/30, Reverse_death) ~ 1, data1)
reverse_km_OS

reverse_km_OS_breyanzi <- survfit(Surv(Days.to.DLC/30, Reverse_death) ~ 1, filter(data1, CAR.T.Product.Type == "Breyanzi") )
reverse_km_OS_breyanzi

reverse_km_OS_yescarta <- survfit(Surv(Days.to.DLC/30, Reverse_death) ~ 1, filter(data1, CAR.T.Product.Type == "Yescarta") )
reverse_km_OS_yescarta
```

## KM for OS, whole cohort
```{r, warning=FALSE, message=FALSE}
data1 = filter(dataset, Infused == 1)

km_OS <- survfit(Surv(Days.to.DLC/30, Death) ~ 1, data1)
km_OS

#autoplot(km_Regain)
OS_plot <- ggsurvplot(km_OS,
           pval=FALSE,
           conf.int = TRUE,
           risk.table = TRUE, # Add risk table
           fontsize = 6,
           risk.table.col = "strata", # Change risk table color by groups
           tables.height = 0.25,
           tables.theme = theme_cleantable(),
           xlab="Time (months)", ylab = "Overall survival",
           xlim = c(0,36), break.x.by = c(180/30),
           ylim = c(0,1), break.y.by = c(0.25),
           legend = "none",
           surv.scale="percent",
           font.main = c(16, "plain", "black"),
           font.x = c(16, "plain", "black"),
           font.y = c(16, "plain", "black"),
           font.caption = c(16, "plain", "black"),
           font.tickslab = c(16, "plain", "black")
) 

OS_plot
```

## KM for OS, whole cohort
```{r, warning=FALSE, message=FALSE}
data1 = filter(dataset, Infused == 1)

km_PFS <- survfit(Surv(Days.to.relapse.death.or.DLC/30, Relapse.or.death) ~ 1, data1)
km_PFS




#autoplot(km_Regain)
PFS_plot <- ggsurvplot(km_PFS,
           pval=FALSE,
           conf.int = TRUE,
           risk.table = TRUE, # Add risk table
           fontsize = 6,
           risk.table.col = "strata", # Change risk table color by groups
           tables.height = 0.25,
           tables.theme = theme_cleantable(),
           xlab="Time (months)", ylab = "Progression-free survival",
           xlim = c(0,36), break.x.by = c(180/30),
           ylim = c(0,1), break.y.by = c(0.25),
           legend = "none",
           surv.scale="percent",
           font.main = c(16, "plain", "black"),
           font.x = c(16, "plain", "black"),
           font.y = c(16, "plain", "black"),
           font.caption = c(16, "plain", "black"),
           font.tickslab = c(16, "plain", "black")
) 

PFS_plot
```

## Create KM for OS

```{r, warning=FALSE, message=FALSE}
data1 = filter(dataset, Infused == 1) %>%
  mutate(
    Reverse_death = ifelse(Death == 1, 0,1)
  )

km_OS <- survfit(Surv(Days.to.DLC/30, Death) ~ CAR.T.Product.Type, data1)
km_OS

med_OS <- surv_median(km_OS)

p.logrank <- survdiff(Surv(Days.to.DLC/30, Death) ~ CAR.T.Product.Type, data1)$pvalue


oneYr <- summary(km_OS,times=c(12))
oneYr
oneYr$surv[1]- oneYr$surv[2] # Difference in survival at 1 yr for Breyanzi vs Yescarta

print("Difference in survival: ")
diffSE <- sqrt(oneYr$std.err[2]^2 + oneYr$std.err[1]^2) # calculate the standard error

#Calculate the 95% CI for the difference
print("95% CI: ")
oneYr$surv[1] - oneYr$surv[2] - 1.96 * diffSE
oneYr$surv[1] - oneYr$surv[2] + 1.96 * diffSE

zStat <- (oneYr$surv[1] - oneYr$surv[2])/diffSE # calculate the c-test statistic

print("p-value: ")
p = 2 * pnorm(abs(zStat), lower.tail = FALSE) # calculate a two-sided p-value


#autoplot(km_Regain)
OS_plot <- ggsurvplot(km_OS,
           pval=FALSE,
           conf.int = TRUE,
           risk.table = TRUE, # Add risk table
           fontsize = 6,
           risk.table.col = "strata", # Change risk table color by groups
           tables.height = 0.25,
           tables.theme = theme_cleantable(),
           xlab="Time (months)", ylab = "Overall survival",
           xlim = c(0,36), break.x.by = c(180/30),
           ylim = c(0,1), break.y.by = c(0.25),
           legend.labs = c("Liso-cel","Axi-cel"),
           legend = "none",
           surv.scale="percent",
           font.main = c(16, "plain", "black"),
           font.x = c(16, "plain", "black"),
           font.y = c(16, "plain", "black"),
           font.caption = c(16, "plain", "black"),
           font.tickslab = c(16, "plain", "black")
) 

OS_plot$plot <- OS_plot$plot + 
  geom_vline(xintercept = 12, linetype = "dashed", color = "steelblue") +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "black") +
  annotate("text", x = 12.5, y = 0.83, label = paste("Liso-cel vs axi-cel: 1-year OS\n", signif(oneYr$surv[1]*100, 2), "% vs ", signif(oneYr$surv[2]*100, 2), "%, p =", signif(p,2)), color = "steelblue", hjust = 0, vjust = -0.5, size = 3) +
  annotate("text", x = 13, y = 0, label = paste("Liso-cel vs axi-cel,\nmedian OS:\n", signif(med_OS$median[1], 2), "vs", signif(med_OS$median[2], 2), "months, p =", signif(p.logrank,2)), color = "black", hjust = 0, vjust = -0.5, size = 3, fontface = "bold")


OS_plot
```

## Create KM for PFS, stratified by product
```{r, warning=FALSE, message=FALSE}

data1 <- filter(dataset, Infused == 1) #%>%
  #filter(Best.response == "CR" | Best.response == "PR") ## To view DOR instead of PFS

km_RFS <- survfit(Surv(Days.to.relapse.death.or.DLC/30, Relapse.or.death) ~ CAR.T.Product.Type, data = data1 )
km_RFS

med_RFS <- surv_median(km_RFS)

p.logrank <- survdiff(Surv(Days.to.relapse.death.or.DLC/30, Relapse.or.death) ~ CAR.T.Product.Type, data1)$pvalue


oneYr <- summary(km_RFS,times=c(12))
oneYr
oneYr$surv[1]- oneYr$surv[2] # Difference in survival at 1 yr for Breyanzi vs Yescarta

print("Difference in survival: ")
diffSE <- sqrt(oneYr$std.err[2]^2 + oneYr$std.err[1]^2) # calculate the standard error

#Calculate the 95% CI for the difference
print("95% CI: ")
oneYr$surv[1] - oneYr$surv[2] - 1.96 * diffSE
oneYr$surv[1] - oneYr$surv[2] + 1.96 * diffSE

zStat <- (oneYr$surv[1] - oneYr$surv[2])/diffSE # calculate the c-test statistic

print("p-value: ")
p = 2 * pnorm(abs(zStat), lower.tail = FALSE) # calculate a two-sided p-value


#autoplot(km_Regain)
RFS_plot <- ggsurvplot(km_RFS,
           pval=FALSE,
           conf.int = TRUE,
           risk.table = TRUE, # Add risk table
           fontsize = 6,
           risk.table.col = "strata", # Change risk table color by groups
           tables.height = 0.25,
           tables.theme = theme_cleantable(),
           xlab="Time (months)", ylab = "Progression-free survival",
           xlim = c(0,36), break.x.by = c(180/30),
           ylim = c(0,1), break.y.by = c(0.25),
           legend.labs = c("Liso-cel","Axi-cel"),
           legend = "none",
           surv.scale="percent",
           font.main = c(16, "plain", "black"),
           font.x = c(16, "plain", "black"),
           font.y = c(16, "plain", "black"),
           font.caption = c(16, "plain", "black"),
           font.tickslab = c(16, "plain", "black")
) 

RFS_plot$plot <- RFS_plot$plot + 
  geom_vline(xintercept = 12, linetype = "dashed", color = "steelblue") +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "black") +
  annotate("text", x = 12.5, y = 0.83, label = paste("Liso-cel vs axi-cel: 1-year PFS\n", signif(oneYr$surv[1]*100, 2), "% vs ", signif(oneYr$surv[2]*100, 2), "%, p =", signif(p,2)), color = "steelblue", hjust = 0, vjust = -0.5, size = 3) +
  annotate("text", x = 13, y = .5, label = paste("Liso-cel vs axi-cel,\nmedian PFS:\n", signif(med_RFS$median[1], 2), "vs", signif(med_RFS$median[2], 2), "months, p =", signif(p.logrank,2)), color = "black", hjust = 0, vjust = -0.5, size = 3, fontface = "bold")


RFS_plot
```


## Create KM for DOR, stratified by product
```{r, warning=FALSE, message=FALSE}

data1 <- filter(dataset, Infused == 1) %>%
  filter(Best.response == "CR" | Best.response == "PR") ## To view DOR instead of PFS

km_DOR <- survfit(Surv( (Days.to.relapse.death.or.DLC-Days.to.response)/30, Relapse.or.death) ~ CAR.T.Product.Type, data = data1 )
km_DOR

med_DOR <- surv_median(km_DOR)

p.logrank <- survdiff(Surv( (Days.to.relapse.death.or.DLC-Days.to.response)/30, Relapse.or.death) ~ CAR.T.Product.Type, data1)$pvalue


oneYr <- summary(km_DOR,times=c(12))
oneYr
oneYr$surv[1]- oneYr$surv[2] # Difference in survival at 1 yr for Breyanzi vs Yescarta

print("Difference in survival: ")
diffSE <- sqrt(oneYr$std.err[2]^2 + oneYr$std.err[1]^2) # calculate the standard error

#Calculate the 95% CI for the difference
print("95% CI: ")
oneYr$surv[1] - oneYr$surv[2] - 1.96 * diffSE
oneYr$surv[1] - oneYr$surv[2] + 1.96 * diffSE

zStat <- (oneYr$surv[1] - oneYr$surv[2])/diffSE # calculate the c-test statistic

print("p-value: ")
p = 2 * pnorm(abs(zStat), lower.tail = FALSE) # calculate a two-sided p-value


#autoplot(km_Regain)
DOR_plot <- ggsurvplot(km_DOR,
           pval=FALSE,
           conf.int = TRUE,
           risk.table = TRUE, # Add risk table
           fontsize = 6,
           risk.table.col = "strata", # Change risk table color by groups
           tables.height = 0.25,
           tables.theme = theme_cleantable(),
           xlab="Time (months)", ylab = "Progression-free survival",
           xlim = c(0,36), break.x.by = c(180/30),
           ylim = c(0,1), break.y.by = c(0.25),
           legend.labs = c("Liso-cel","Axi-cel"),
           legend = "none",
           surv.scale="percent",
           font.main = c(16, "plain", "black"),
           font.x = c(16, "plain", "black"),
           font.y = c(16, "plain", "black"),
           font.caption = c(16, "plain", "black"),
           font.tickslab = c(16, "plain", "black")
) 

DOR_plot$plot <- DOR_plot$plot + 
  geom_vline(xintercept = 12, linetype = "dashed", color = "steelblue") +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "black") +
  annotate("text", x = 12.5, y = 0.83, label = paste("Liso-cel vs axi-cel: 1-year DOR\n", signif(oneYr$surv[1]*100, 2), "% vs ", signif(oneYr$surv[2]*100, 2), "%, p =", signif(p,2)), color = "steelblue", hjust = 0, vjust = -0.5, size = 3) +
  annotate("text", x = 13, y = .5, label = paste("Liso-cel vs axi-cel,\nmedian DOR:\n", signif(med_DOR$median[1], 2), "vs", signif(med_DOR$median[2], 2), "months, p =", signif(p.logrank,2)), color = "black", hjust = 0, vjust = -0.5, size = 3, fontface = "bold")


DOR_plot
```

## Combined KM with OS and PFS
```{r}

splots <- list()
splots[[1]] = OS_plot
splots[[2]] = RFS_plot
arrange_ggsurvplots(splots, print = TRUE,
  ncol = 2, nrow = 1, risk.table.height = 0.25)
```

## Create KM for OS stratified by best response
```{r, warning=FALSE, message=FALSE}
km_OS <- survfit(Surv(Days.to.DLC/30, Death) ~ Best.response, data = filter(dataset, Infused == 1 & Best.response != "SD"))
km_OS
#autoplot(km_Regain)

OS_plot <- ggsurvplot(km_OS,
           pval=TRUE,
           conf.int = TRUE,
           risk.table = TRUE, # Add risk table
           fontsize = 6,
           risk.table.col = "strata", # Change risk table color by groups
           tables.height = 0.3,
           tables.theme = theme_cleantable(),
           #surv.median.line = "hv", # Specify median survival
           #ggtheme = theme_bw(), # Change ggplot2 theme
           #palette = c("#E7B800", "#2E9FDF"),
           xlab="Time (months)", ylab = "Overall survival",
           xlim = c(0,72), break.x.by = c(12),
           ylim = c(0,1), break.y.by = c(0.25),
           legend.labs = c("CR","PD", "PR"),
           legend = "none",
           surv.scale="percent",
           font.main = c(16, "plain", "black"),
           font.x = c(16, "plain", "black"),
           font.y = c(16, "plain", "black"),
           font.caption = c(16, "plain", "black"),
           font.tickslab = c(16, "plain", "black")
)
OS_plot
```

## Create KM for OS stratified by Bulky disease (\>=5cm) status
```{r, warning=FALSE, message=FALSE}
km_OS <- survfit(Surv(Days.to.DLC/30, Death) ~ Bulky, data = filter(dataset, Infused == 1 | Best.response != "") )
km_OS
#autoplot(km_Regain)
OS_plot <- ggsurvplot(km_OS,
           pval=TRUE,
           conf.int = TRUE,
           risk.table = TRUE, # Add risk table
           fontsize = 6,
           risk.table.col = "strata", # Change risk table color by groups
           tables.height = 0.25,
           tables.theme = theme_cleantable(),
           xlab="Time (months)", ylab = "Overall survival",
           xlim = c(0,72), break.x.by = c(12),
           ylim = c(0,1), break.y.by = c(0.25),
           legend.labs = c("Non-bulky","Bulky"),
           legend = "none",
           surv.scale="percent",
           font.main = c(16, "plain", "black"),
           font.x = c(16, "plain", "black"),
           font.y = c(16, "plain", "black"),
           font.caption = c(16, "plain", "black"),
           font.tickslab = c(16, "plain", "black")
)
OS_plot
```

## Create KM for OS stratified by Breyanzi out-of-spec (EAP) status
```{r, warning=FALSE, message=FALSE}
km_OS <- survfit(Surv(Days.to.DLC, Death) ~ EAP, data = filter(dataset, CAR.T.Product.Type == "Breyanzi") )
km_OS

OS_plot <- ggsurvplot(km_OS,
           pval=TRUE,
           conf.int = TRUE,
           risk.table = TRUE, # Add risk table
           fontsize = 6,
           risk.table.col = "strata", # Change risk table color by groups
           tables.height = 0.25,
           tables.theme = theme_cleantable(),
           xlab="Time (days)", ylab = "Overall survival",
           xlim = c(0,1080), break.x.by = c(180),
           ylim = c(0,1), break.y.by = c(0.25),
           legend.labs = c("In-spec", "Out-of-spec"),
           legend = "none",
           surv.scale="percent",
           font.main = c(16, "plain", "black"),
           font.x = c(16, "plain", "black"),
           font.y = c(16, "plain", "black"),
           font.caption = c(16, "plain", "black"),
           font.tickslab = c(16, "plain", "black")
)
OS_plot
```

## Create KM for OS stratified by LDH status (\<210 vs \>=210 U/L)
```{r, warning=FALSE, message=FALSE}
data1 = filter(dataset, Infused == 1)

km_OS <- survfit(Surv(Days.to.DLC/30, Death) ~ High.LDH, data1)
km_OS

#autoplot(km_Regain)


OS_plot <- ggsurvplot(km_OS,
           pval=TRUE,
           conf.int = TRUE,
           risk.table = TRUE, # Add risk table
           fontsize = 6,
           risk.table.col = "strata", # Change risk table color by groups
           tables.height = 0.25,
           tables.theme = theme_cleantable(),
           #surv.median.line = "hv", # Specify median survival
           #ggtheme = theme_bw(), # Change ggplot2 theme
           #palette = c("#E7B800", "#2E9FDF"),
           xlab="Time (months)", ylab = "Overall survival",
           xlim = c(0,72), break.x.by = c(12),
           ylim = c(0,1), break.y.by = c(0.25),
           legend.labs = c("LDH <210 U/L", "LDH \u2265210 U/L"),
           legend = "none",
           surv.scale="percent",
           font.main = c(16, "plain", "black"),
           font.x = c(16, "plain", "black"),
           font.y = c(16, "plain", "black"),
           font.caption = c(16, "plain", "black"),
           font.tickslab = c(16, "plain", "black")
)
OS_plot
```

## Create KM for OS stratified by HCT-CI status (\>=3 vs \<3)
```{r, warning=FALSE, message=FALSE}

data1 = filter(dataset, Infused == 1) %>%
  mutate(
    High.HCT.CI = ifelse(HCT.CI >=3,1,0) )

km_OS <- survfit(Surv(Days.to.DLC/30, Death) ~ High.HCT.CI, data1 )
km_OS


OS_plot <- ggsurvplot(km_OS,
           pval=TRUE,
           conf.int = TRUE,
           risk.table = TRUE, # Add risk table
           fontsize = 6,
           risk.table.col = "strata", # Change risk table color by groups
           tables.height = 0.25,
           tables.theme = theme_cleantable(),
           #surv.median.line = "hv", # Specify median survival
           #ggtheme = theme_bw(), # Change ggplot2 theme
           #palette = c("#E7B800", "#2E9FDF"),
           xlab="Time (months)", ylab = "Overall survival",
           xlim = c(0,72), break.x.by = c(12),
           ylim = c(0,1), break.y.by = c(0.25),
           legend.labs = c("HCT <3", "HCT \u22653"),
           legend = "none",
           surv.scale="percent",
           font.main = c(16, "plain", "black"),
           font.x = c(16, "plain", "black"),
           font.y = c(16, "plain", "black"),
           font.caption = c(16, "plain", "black"),
           font.tickslab = c(16, "plain", "black")
)
OS_plot
```

## Create KM for OS stratified by bridging response category
```{r, warning=FALSE, message=FALSE}

data1 = dataset %>%
  mutate(
    Bridging.response.category = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD"), levels = c("No bridging","CR/PR","SD/PD"))
    )

km_OS <- survfit(Surv(Days.to.DLC/30, Death) ~ Bridging.response.category, data1 )
km_OS

OS_plot <- ggsurvplot(km_OS,
           pval=TRUE,
           conf.int = TRUE,
           risk.table = TRUE, # Add risk table
           fontsize = 6,
           risk.table.col = "strata", # Change risk table color by groups
           tables.height = 0.25,
           tables.theme = theme_cleantable(),
           #surv.median.line = "hv", # Specify median survival
           #ggtheme = theme_bw(), # Change ggplot2 theme
           #palette = c("#E7B800", "#2E9FDF"),
           xlab="Time (months)", ylab = "Overall survival",
           xlim = c(0,72), break.x.by = c(12),
           ylim = c(0,1), break.y.by = c(0.25),
           legend.labs = c("No bridging","CR/PR","SD/PD"),
           legend = "none",
           surv.scale="percent",
           font.main = c(16, "plain", "black"),
           font.x = c(16, "plain", "black"),
           font.y = c(16, "plain", "black"),
           font.caption = c(16, "plain", "black"),
           font.tickslab = c(16, "plain", "black")
)
OS_plot
```

## Create KM for PFS stratified by best response
```{r, warning=FALSE, message=FALSE}
km_PFS <- survfit(Surv(Days.to.relapse.death.or.DLC/30, Relapse.or.death) ~ Best.response, data = filter(dataset, Infused == 1 & Best.response != "SD"& Best.response != "PD") )
km_PFS
#autoplot(km_Regain)

PFS_plot <- ggsurvplot(km_PFS,
           pval=TRUE,
           conf.int = TRUE,
           risk.table = TRUE, # Add risk table
           fontsize = 6,
           risk.table.col = "strata", # Change risk table color by groups
           tables.height = 0.25,
           tables.theme = theme_cleantable(),
           #surv.median.line = "hv", # Specify median survival
           #ggtheme = theme_bw(), # Change ggplot2 theme
           #palette = c("#E7B800", "#2E9FDF"),
           xlab="Time (months)", ylab = "Progression-free survival",
           xlim = c(0,72), break.x.by = c(12),
           ylim = c(0,1), break.y.by = c(0.25),
           legend.labs = c("CR", "PR"),
           legend = "none",
           surv.scale="percent",
           font.main = c(16, "plain", "black"),
           font.x = c(16, "plain", "black"),
           font.y = c(16, "plain", "black"),
           font.caption = c(16, "plain", "black"),
           font.tickslab = c(16, "plain", "black")
)
PFS_plot
```

## Create KM for PFS stratified by Bulky disease (\>=5cm) status
```{r, warning=FALSE, message=FALSE}
km_PFS <- survfit(Surv(Days.to.relapse.death.or.DLC/30, Relapse.or.death) ~ Bulky, data = filter(dataset, Infused == 1 | Best.response != "") )
km_PFS
#autoplot(km_Regain)
PFS_plot <- ggsurvplot(km_PFS,
           pval=TRUE,
           conf.int = TRUE,
           risk.table = TRUE, # Add risk table
           fontsize = 6,
           risk.table.col = "strata", # Change risk table color by groups
           tables.height = 0.25,
           tables.theme = theme_cleantable(),
           xlab="Time (months)", ylab = "Progression-free survival",
           xlim = c(0,72), break.x.by = c(12),
           ylim = c(0,1), break.y.by = c(0.25),
           legend.labs = c("Non-bulky","Bulky"),
           legend = "none",
           surv.scale="percent",
           font.main = c(16, "plain", "black"),
           font.x = c(16, "plain", "black"),
           font.y = c(16, "plain", "black"),
           font.caption = c(16, "plain", "black"),
           font.tickslab = c(16, "plain", "black")
)
PFS_plot
```

## Create KM for PFS stratified by Breyanzi out-of-spec (EAP) status
```{r, warning=FALSE, message=FALSE}
km_PFS <- survfit(Surv(Days.to.DLC/30, Relapse.or.death) ~ EAP, data = filter(dataset, CAR.T.Product.Type == "Breyanzi") )
km_PFS

PFS_plot <- ggsurvplot(km_PFS,
           pval=TRUE,
           conf.int = TRUE,
           risk.table = TRUE, # Add risk table
           fontsize = 6,
           risk.table.col = "strata", # Change risk table color by groups
           tables.height = 0.25,
           tables.theme = theme_cleantable(),
           xlab="Time (months)", ylab = "Progression-free survival",
           xlim = c(0,72), break.x.by = c(12),
           ylim = c(0,1), break.y.by = c(0.25),
           legend.labs = c("In-spec", "Out-of-spec"),
           legend = "none",
           surv.scale="percent",
           font.main = c(16, "plain", "black"),
           font.x = c(16, "plain", "black"),
           font.y = c(16, "plain", "black"),
           font.caption = c(16, "plain", "black"),
           font.tickslab = c(16, "plain", "black")
)
PFS_plot
```

## Create KM for PFS stratified by LDH status (\<210 vs \>=210 U/L)
```{r, warning=FALSE, message=FALSE}
data1 = filter(dataset, Infused == 1)

km_PFS <- survfit(Surv(Days.to.relapse.death.or.DLC/30, Relapse.or.death) ~ High.LDH, data1)
km_PFS

#autoplot(km_Regain)


PFS_plot <- ggsurvplot(km_PFS,
           pval=TRUE,
           conf.int = TRUE,
           risk.table = TRUE, # Add risk table
           fontsize = 6,
           risk.table.col = "strata", # Change risk table color by groups
           tables.height = 0.25,
           tables.theme = theme_cleantable(),
           #surv.median.line = "hv", # Specify median survival
           #ggtheme = theme_bw(), # Change ggplot2 theme
           #palette = c("#E7B800", "#2E9FDF"),
           xlab="Time (months)", ylab = "Progression-free survival",
           xlim = c(0,72), break.x.by = c(12),
           ylim = c(0,1), break.y.by = c(0.25),
           legend.labs = c("LDH <210 U/L", "LDH \u2265210 U/L"),
           legend = "none",
           surv.scale="percent",
           font.main = c(16, "plain", "black"),
           font.x = c(16, "plain", "black"),
           font.y = c(16, "plain", "black"),
           font.caption = c(16, "plain", "black"),
           font.tickslab = c(16, "plain", "black")
)
PFS_plot
```

## Create KM for PFS stratified by HCT-CI status (\>=3 vs \<3)
```{r, warning=FALSE, message=FALSE}

data1 = filter(dataset, Infused == 1) %>%
  mutate(
    High.HCT.CI = ifelse(HCT.CI >=3,1,0) )

km_PFS <- survfit(Surv(Days.to.relapse.death.or.DLC/30, Relapse.or.death) ~ High.HCT.CI, data1 )
km_PFS


PFS_plot <- ggsurvplot(km_PFS,
           pval=TRUE,
           conf.int = TRUE,
           risk.table = TRUE, # Add risk table
           fontsize = 6,
           risk.table.col = "strata", # Change risk table color by groups
           tables.height = 0.25,
           tables.theme = theme_cleantable(),
           #surv.median.line = "hv", # Specify median survival
           #ggtheme = theme_bw(), # Change ggplot2 theme
           #palette = c("#E7B800", "#2E9FDF"),
           xlab="Time (months)", ylab = "Progression-free survival",
           xlim = c(0,72), break.x.by = c(12),
           ylim = c(0,1), break.y.by = c(0.25),
           legend.labs = c("HCT <3", "HCT \u22653"),
           legend = "none",
           surv.scale="percent",
           font.main = c(16, "plain", "black"),
           font.x = c(16, "plain", "black"),
           font.y = c(16, "plain", "black"),
           font.caption = c(16, "plain", "black"),
           font.tickslab = c(16, "plain", "black")
)
PFS_plot
```

## Create KM for PFS stratified by bridging response category
```{r, warning=FALSE, message=FALSE}

data1 = dataset %>%
  mutate(
    Bridging.response.category = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD"), levels = c("No bridging","CR/PR","SD/PD"))
    )

km_PFS <- survfit(Surv(Days.to.relapse.death.or.DLC/30, Relapse.or.death) ~ Bridging.response.category, data1 )
km_PFS

PFS_plot <- ggsurvplot(km_PFS,
           pval=TRUE,
           conf.int = TRUE,
           risk.table = TRUE, # Add risk table
           fontsize = 6,
           risk.table.col = "strata", # Change risk table color by groups
           tables.height = 0.3,
           tables.theme = theme_cleantable(),
           #surv.median.line = "hv", # Specify median survival
           #ggtheme = theme_bw(), # Change ggplot2 theme
           #palette = c("#E7B800", "#2E9FDF"),
           xlab="Time (months)", ylab = "Progression-free survival",
           xlim = c(0,72), break.x.by = c(12),
           ylim = c(0,1), break.y.by = c(0.25),
           legend.labs = c("No bridging","CR/PR","SD/PD"),
           legend = "none",
           surv.scale="percent",
           font.main = c(16, "plain", "black"),
           font.x = c(16, "plain", "black"),
           font.y = c(16, "plain", "black"),
           font.caption = c(16, "plain", "black"),
           font.tickslab = c(16, "plain", "black")
)
PFS_plot
```


# WEIGHTED KM PLOTS

## Create weighted KM for OS

```{r, warning=FALSE, message=FALSE}
data1 = IPTW.data

km_OS <- survfit(Surv(Days.to.DLC/30, Death) ~ CAR.T.Product.Type, data1, weights=weights)
km_OS

med_OS <- surv_median(km_OS)

p.logrank <- survdiff(Surv(Days.to.DLC/30, Death) ~ CAR.T.Product.Type, data1)$pvalue


oneYr <- summary(km_OS,times=c(12))
oneYr
oneYr$surv[1]- oneYr$surv[2] # Difference in survival at 1 yr for Breyanzi vs Yescarta

print("Difference in survival: ")
diffSE <- sqrt(oneYr$std.err[2]^2 + oneYr$std.err[1]^2) # calculate the standard error

#Calculate the 95% CI for the difference
print("95% CI: ")
oneYr$surv[1] - oneYr$surv[2] - 1.96 * diffSE
oneYr$surv[1] - oneYr$surv[2] + 1.96 * diffSE

zStat <- (oneYr$surv[1] - oneYr$surv[2])/diffSE # calculate the c-test statistic

print("p-value: ")
p = 2 * pnorm(abs(zStat), lower.tail = FALSE) # calculate a two-sided p-value


#autoplot(km_Regain)
OS_plot <- ggsurvplot(km_OS,
           pval=FALSE,
           conf.int = TRUE,
           risk.table = TRUE, # Add risk table
           fontsize = 6,
           risk.table.col = "strata", # Change risk table color by groups
           tables.height = 0.25,
           tables.theme = theme_cleantable(),
           xlab="Time (months)", ylab = "Overall survival",
           xlim = c(0,36), break.x.by = c(180/30),
           ylim = c(0,1), break.y.by = c(0.25),
           legend.labs = c("Liso-cel","Axi-cel"),
           legend = "none",
           surv.scale="percent",
           font.main = c(16, "plain", "black"),
           font.x = c(16, "plain", "black"),
           font.y = c(16, "plain", "black"),
           font.caption = c(16, "plain", "black"),
           font.tickslab = c(16, "plain", "black")
) 

OS_plot$plot <- OS_plot$plot + 
  geom_vline(xintercept = 12, linetype = "dashed", color = "steelblue") +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "black") +
  annotate("text", x = 12.5, y = 0.83, label = paste("Liso-cel vs axi-cel: 1-year OS\n", signif(oneYr$surv[1]*100, 2), "% vs ", signif(oneYr$surv[2]*100, 2), "%, p =", signif(p,2)), color = "steelblue", hjust = 0, vjust = -0.5, size = 3) +
  annotate("text", x = 13, y = 0, label = paste("Liso-cel vs axi-cel,\nmedian OS:\n", signif(med_OS$median[1], 2), "vs", signif(med_OS$median[2], 2), "months, p =", signif(p.logrank,2)), color = "black", hjust = 0, vjust = -0.5, size = 3, fontface = "bold")


OS_plot
```

## Create weighted KM for PFS, stratified by product
```{r, warning=FALSE, message=FALSE}

data1 = IPTW.data

km_RFS <- survfit(Surv(Days.to.relapse.death.or.DLC/30, Relapse.or.death) ~ CAR.T.Product.Type, data = data1, weights=weights )
km_RFS

med_RFS <- surv_median(km_RFS)

p.logrank <- survdiff(Surv(Days.to.relapse.death.or.DLC/30, Relapse.or.death) ~ CAR.T.Product.Type, data1)$pvalue


oneYr <- summary(km_RFS,times=c(12))
oneYr
oneYr$surv[1]- oneYr$surv[2] # Difference in survival at 1 yr for Breyanzi vs Yescarta

print("Difference in survival: ")
diffSE <- sqrt(oneYr$std.err[2]^2 + oneYr$std.err[1]^2) # calculate the standard error

#Calculate the 95% CI for the difference
print("95% CI: ")
oneYr$surv[1] - oneYr$surv[2] - 1.96 * diffSE
oneYr$surv[1] - oneYr$surv[2] + 1.96 * diffSE

zStat <- (oneYr$surv[1] - oneYr$surv[2])/diffSE # calculate the c-test statistic

print("p-value: ")
p = 2 * pnorm(abs(zStat), lower.tail = FALSE) # calculate a two-sided p-value


#autoplot(km_Regain)
RFS_plot <- ggsurvplot(km_RFS,
           pval=FALSE,
           conf.int = TRUE,
           risk.table = TRUE, # Add risk table
           fontsize = 6,
           risk.table.col = "strata", # Change risk table color by groups
           tables.height = 0.25,
           tables.theme = theme_cleantable(),
           xlab="Time (months)", ylab = "Progression-free survival",
           xlim = c(0,36), break.x.by = c(180/30),
           ylim = c(0,1), break.y.by = c(0.25),
           legend.labs = c("Liso-cel","Axi-cel"),
           legend = "none",
           surv.scale="percent",
           font.main = c(16, "plain", "black"),
           font.x = c(16, "plain", "black"),
           font.y = c(16, "plain", "black"),
           font.caption = c(16, "plain", "black"),
           font.tickslab = c(16, "plain", "black")
) 

RFS_plot$plot <- RFS_plot$plot + 
  geom_vline(xintercept = 12, linetype = "dashed", color = "steelblue") +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "black") +
  annotate("text", x = 12.5, y = 0.83, label = paste("Liso-cel vs axi-cel: 1-year PFS\n", signif(oneYr$surv[1]*100, 2), "% vs ", signif(oneYr$surv[2]*100, 2), "%, p =", signif(p,2)), color = "steelblue", hjust = 0, vjust = -0.5, size = 3) +
  annotate("text", x = 13, y = .55, label = paste("Liso-cel vs axi-cel,\nmedian PFS:\n", signif(med_RFS$median[1], 2), "vs", signif(med_RFS$median[2], 2), "months, p =", signif(p.logrank,2)), color = "black", hjust = 0, vjust = -0.5, size = 3, fontface = "bold")


RFS_plot
```








# REGRESSION ANALYSIS: UNWEIGHTED AND IPTW

## PFS/OS

### Cox Model - PFS
```{r, warning=FALSE, message=FALSE}
theme_gtsummary_compact()
preds <- c("Product", "LDH pre-LD", "ALC pre-LD","Largest lesion", "Age", "Male sex", "Bridging category")

data0 <- dataset %>%
  mutate(
    "Male sex" = ifelse(Sex == "M",1,0),
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    "ALC pre-LD" = ALC.preLD,
    "LDH pre-LD" = LDH.preLD/1000,
    "Largest lesion" = Largest.lesion,
    "Bridging category" = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD"), levels = c("No bridging","CR/PR","SD/PD"))
  )

data1 <- IPTW.data %>%
  mutate(
    "Male sex" = ifelse(Sex == "M",1,0),
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    "ALC pre-LD" = ALC.preLD,
    "LDH pre-LD" = LDH.preLD/1000,
    "Largest lesion" = Largest.lesion,
    "Bridging category" = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD"), levels = c("No bridging","CR/PR","SD/PD")),
  )

data2 <- m.data %>%
  mutate(
    "Male sex" = ifelse(Sex == "M",1,0),
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    "ALC pre-LD" = ALC.preLD,
    "LDH pre-LD" = LDH.preLD/1000,
    "Largest lesion" = Largest.lesion,
    "Bridging category" = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD"), levels = c("No bridging","CR/PR","SD/PD")),
  )

uv_tab <- tbl_uvregression(
  data0[c(preds)],
  method = coxph,
  y = Surv(data0$Days.to.relapse.death.or.DLC, data0$Relapse.or.death),
  exponentiate = TRUE
)

mv_tab<-coxph( Surv(Days.to.relapse.death.or.DLC, Relapse.or.death) ~ Product + `LDH pre-LD`+  `ALC pre-LD` + `Largest lesion` + Age+ `Male sex` + `Bridging category`, data0) %>% tbl_regression(exponentiate=TRUE)


uv_tab_IPTW <- tbl_uvregression(
  data1[c(preds)],
  method = coxph,
  y = Surv(data1$Days.to.relapse.death.or.DLC, data1$Relapse.or.death),
  exponentiate = TRUE,
  method.args = list(weights = data1$weights),
)

mv_tab_IPTW<-coxph( Surv(Days.to.relapse.death.or.DLC, Relapse.or.death) ~ Product + `LDH pre-LD`+  `ALC pre-LD` + `Largest lesion` + Age + `Male sex` + `Bridging category`, data1, weights=weights) %>%tbl_regression( exponentiate=TRUE)

uv_tab_PSM <- tbl_uvregression(
  data2[c(preds)],
  method = coxph,
  y = Surv(data2$Days.to.relapse.death.or.DLC, data2$Relapse.or.death),
  exponentiate = TRUE,
  method.args = list(weights = data2$weights),
)

mv_tab_PSM<-coxph( Surv(Days.to.relapse.death.or.DLC, Relapse.or.death) ~ Product + `LDH pre-LD`+  `ALC pre-LD` + `Largest lesion` + Age + `Male sex` + `Bridging category`, data2, weights=weights) %>%tbl_regression( exponentiate=TRUE)


row1 <- tbl_merge(list(uv_tab, mv_tab), tab_spanner = c("**Univariate**", "**Multivariable**"))
row2 <- tbl_merge(list(uv_tab_IPTW, mv_tab_IPTW))
row3 <- tbl_merge(list(uv_tab_PSM, mv_tab_PSM))
tbl_stack(list(row1, row2, row3), group_header = c("UNWEIGHTED ANALYSIS", "IPTW ANALYSIS", "PSM ANALYSIS"), quiet=TRUE)
```

### Cox Model - PFS forest plots
```{r, warning=FALSE, message=FALSE}
## Forest plot for MV
df_fp <- mv_tab$table_body %>%
  select(header_row, label, N_obs, N_event, estimate, conf.low, conf.high, p.value, ) %>%
  mutate(
    label = ifelse(header_row == TRUE | is.na(header_row),as.character(label), paste0("     ", as.character(label)) ),
    p.value = signif(p.value, 2),
    `HR (95% CI)` = ifelse(
      is.na(estimate),"",paste0(round(estimate, 2), " (", round(conf.low,2), " to ",round(conf.high,2), ") ")
    )
  ) %>%
  rename(Characteristic = label,
         N = N_obs,
         Events = N_event,
         `p value` = p.value)
forester(
  left_side_data = df_fp[2],
  right_side_data = df_fp[9:8],
  estimate = df_fp$estimate,
  ci_low = df_fp$conf.low,
  ci_high = df_fp$conf.high,
  estimate_col_name = "HR (95% CI)",
  xlim = c(0.1, 10),
  null_line_at = 1,
  arrows = TRUE,
  x_scale_linear = FALSE,
  arrow_labels = c("Better", "Worse"),
  font_family = "sans",
  display = TRUE,
  nudge_x = .4,
  nudge_height = .06,
  stripe_colour = "#F5F5F5",
  file_path = "/Users/aportugu/Desktop/CD19 project/ASH abstract/forest/PFS_mv_plot.png"
)

knitr::include_graphics("/Users/aportugu/Desktop/CD19 project/ASH abstract/forest/PFS_mv_plot.png")


## Forest plot for MV IPTW
df_fp <- mv_tab_IPTW$table_body %>%
  select(header_row, label, N_obs, N_event, estimate, conf.low, conf.high, p.value, ) %>%
  mutate(
    label = ifelse(header_row == TRUE | is.na(header_row),as.character(label), paste0("     ", as.character(label)) ),
    p.value = signif(p.value, 2),
    `HR (95% CI)` = ifelse(
      is.na(estimate),"",paste0(round(estimate, 2), " (", round(conf.low,2), " to ",round(conf.high,2), ") ")
    )
  ) %>%
  rename(Characteristic = label,
         N = N_obs,
         Events = N_event,
         `p value` = p.value)
forester(
  left_side_data = df_fp[2],
  right_side_data = df_fp[9:8],
  estimate = df_fp$estimate,
  ci_low = df_fp$conf.low,
  ci_high = df_fp$conf.high,
  estimate_col_name = "HR (95% CI)",
  xlim = c(0.1, 10),
  null_line_at = 1,
  arrows = TRUE,
  x_scale_linear = FALSE,
  arrow_labels = c("Better", "Worse"),
  font_family = "sans",
  display = TRUE,
  nudge_x = .4,
  nudge_height = .06,
  stripe_colour = "#F5F5F5",
  file_path = "/Users/aportugu/Desktop/CD19 project/ASH abstract/forest/PFS_mv_plot_IPTW.png"
)

knitr::include_graphics("/Users/aportugu/Desktop/CD19 project/ASH abstract/forest/PFS_mv_plot_IPTW.png")

## Forest plot for MV PSM
df_fp <- mv_tab_PSM$table_body %>%
  select(header_row, label, N_obs, N_event, estimate, conf.low, conf.high, p.value, ) %>%
  mutate(
    label = ifelse(header_row == TRUE | is.na(header_row),as.character(label), paste0("     ", as.character(label)) ),
    p.value = signif(p.value, 2),
    `HR (95% CI)` = ifelse(
      is.na(estimate),"",paste0(round(estimate, 2), " (", round(conf.low,2), " to ",round(conf.high,2), ") ")
    )
  ) %>%
  rename(Characteristic = label,
         N = N_obs,
         Events = N_event,
         `p value` = p.value)
forester(
  left_side_data = df_fp[2],
  right_side_data = df_fp[9:8],
  estimate = df_fp$estimate,
  ci_low = df_fp$conf.low,
  ci_high = df_fp$conf.high,
  estimate_col_name = "HR (95% CI)",
  xlim = c(0.1, 10),
  null_line_at = 1,
  arrows = TRUE,
  x_scale_linear = FALSE,
  arrow_labels = c("Better", "Worse"),
  font_family = "sans",
  display = TRUE,
  nudge_x = .4,
  nudge_height = .06,
  stripe_colour = "#F5F5F5",
  file_path = "/Users/aportugu/Desktop/CD19 project/ASH abstract/forest/PFS_mv_plot_PSM.png"
)

knitr::include_graphics("/Users/aportugu/Desktop/CD19 project/ASH abstract/forest/PFS_mv_plot_PSM.png")
```

### Cox Model - OS

```{r, warning=FALSE, message=FALSE}
theme_gtsummary_compact()
preds <- c("Product","LDH pre-LD", "ALC pre-LD","Largest lesion", "Age", "Male sex", "Bridging category")

data0 <- dataset %>%
  mutate(
    "Male sex" = ifelse(Sex == "M",1,0),
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    "ALC pre-LD" = ALC.preLD,
    "LDH pre-LD" = LDH.preLD/1000,
    "Largest lesion" = Largest.lesion,
    "Bridging category" = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD"), levels = c("No bridging","CR/PR","SD/PD"))
  )

data1 <- IPTW.data %>%
  mutate(
    "Male sex" = ifelse(Sex == "M",1,0),
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    "ALC pre-LD" = ALC.preLD,
    "LDH pre-LD" = LDH.preLD/1000,
    "Largest lesion" = Largest.lesion,
    "Bridging category" = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD"), levels = c("No bridging","CR/PR","SD/PD"))
  )

data2 <- m.data %>%
  mutate(
    "Male sex" = ifelse(Sex == "M",1,0),
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    "ALC pre-LD" = ALC.preLD,
    "LDH pre-LD" = LDH.preLD/1000,
    "Largest lesion" = Largest.lesion,
    "Bridging category" = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD"), levels = c("No bridging","CR/PR","SD/PD"))
  )

uv_tab <- tbl_uvregression(
  data0[c(preds)],
  method = coxph,
  y = Surv(data0$Days.to.DLC, data0$Death),
  exponentiate = TRUE
)

mv_tab<-coxph( Surv(Days.to.DLC, Death) ~ Product +`LDH pre-LD` +  `ALC pre-LD` +  `Largest lesion` + Age + `Male sex` + `Bridging category`, data0) %>% tbl_regression(exponentiate=TRUE)


uv_tab_IPTW <- tbl_uvregression(
  data1[c(preds)],
  method = coxph,
  y = Surv(data1$Days.to.DLC, data1$Death),
  exponentiate = TRUE,
  method.args = list(weights = data1$weights),
)

mv_tab_IPTW<-coxph( Surv(Days.to.DLC, Death) ~ Product +`LDH pre-LD` +  `ALC pre-LD` +  `Largest lesion` + Age + `Male sex` + `Bridging category`, data1, weights=weights) %>% tbl_regression(exponentiate=TRUE)

uv_tab_PSM <- tbl_uvregression(
  data2[c(preds)],
  method = coxph,
  y = Surv(data2$Days.to.DLC, data2$Death),
  exponentiate = TRUE,
  method.args = list(weights = data2$weights),
)

mv_tab_PSM<-coxph( Surv(Days.to.DLC, Death) ~ Product +`LDH pre-LD` +  `ALC pre-LD` +  `Largest lesion` + Age + `Male sex` + `Bridging category`, data2, weights=weights) %>% tbl_regression(exponentiate=TRUE)



row1 <- tbl_merge(list(uv_tab, mv_tab), tab_spanner = c("**Univariate**", "**Multivariable**"))
row2 <- tbl_merge(list(uv_tab_IPTW, mv_tab_IPTW))
row3 <- tbl_merge(list(uv_tab_PSM, mv_tab_PSM))
tbl_stack(list(row1, row2, row3), group_header = c("UNWEIGHTED ANALYSIS", "IPTW ANALYSIS", "PSM ANALYSIS"), quiet=TRUE)
```

### Cox Model - OS forest plots
```{r, warning=FALSE, message=FALSE}
## Forest plot for MV
df_fp <- mv_tab$table_body %>%
  select(header_row, label, N_obs, N_event, estimate, conf.low, conf.high, p.value, ) %>%
  mutate(
    label = ifelse(header_row == TRUE | is.na(header_row),as.character(label), paste0("     ", as.character(label)) ),
    p.value = signif(p.value, 2),
    `HR (95% CI)` = ifelse(
      is.na(estimate),"",paste0(round(estimate, 2), " (", round(conf.low,2), " to ",round(conf.high,2), ") ")
    )
  ) %>%
  rename(Characteristic = label,
         N = N_obs,
         Events = N_event,
         `p value` = p.value)
forester(
  left_side_data = df_fp[2],
  right_side_data = df_fp[9:8],
  estimate = df_fp$estimate,
  ci_low = df_fp$conf.low,
  ci_high = df_fp$conf.high,
  estimate_col_name = "HR (95% CI)",
  xlim = c(0.1, 10),
  null_line_at = 1,
  arrows = TRUE,
  x_scale_linear = FALSE,
  arrow_labels = c("Better", "Worse"),
  font_family = "sans",
  display = TRUE,
  nudge_x = .4,
  nudge_height = .06,
  stripe_colour = "#F5F5F5",
  file_path = "/Users/aportugu/Desktop/CD19 project/ASH abstract/forest/OS_mv_plot.png"
)

knitr::include_graphics("/Users/aportugu/Desktop/CD19 project/ASH abstract/forest/OS_mv_plot.png")


## Forest plot for MV IPTW
df_fp <- mv_tab_IPTW$table_body %>%
  select(header_row, label, N_obs, N_event, estimate, conf.low, conf.high, p.value, ) %>%
  mutate(
    label = ifelse(header_row == TRUE | is.na(header_row),as.character(label), paste0("     ", as.character(label)) ),
    p.value = signif(p.value, 2),
    `HR (95% CI)` = ifelse(
      is.na(estimate),"",paste0(round(estimate, 2), " (", round(conf.low,2), " to ",round(conf.high,2), ") ")
    )
  ) %>%
  rename(Characteristic = label,
         N = N_obs,
         Events = N_event,
         `p value` = p.value)
forester(
  left_side_data = df_fp[2],
  right_side_data = df_fp[9:8],
  estimate = df_fp$estimate,
  ci_low = df_fp$conf.low,
  ci_high = df_fp$conf.high,
  estimate_col_name = "HR (95% CI)",
  xlim = c(0.1, 10),
  null_line_at = 1,
  arrows = TRUE,
  x_scale_linear = FALSE,
  arrow_labels = c("Better", "Worse"),
  font_family = "sans",
  display = TRUE,
  nudge_x = .4,
  nudge_height = .06,
  stripe_colour = "#F5F5F5",
  file_path = "/Users/aportugu/Desktop/CD19 project/ASH abstract/forest/OS_mv_plot_IPTW.png"
)

knitr::include_graphics("/Users/aportugu/Desktop/CD19 project/ASH abstract/forest/OS_mv_plot_IPTW.png")

## Forest plot for MV PSM
df_fp <- mv_tab_PSM$table_body %>%
  select(header_row, label, N_obs, N_event, estimate, conf.low, conf.high, p.value, ) %>%
  mutate(
    label = ifelse(header_row == TRUE | is.na(header_row),as.character(label), paste0("     ", as.character(label)) ),
    p.value = signif(p.value, 2),
    `HR (95% CI)` = ifelse(
      is.na(estimate),"",paste0(round(estimate, 2), " (", round(conf.low,2), " to ",round(conf.high,2), ") ")
    )
  ) %>%
  rename(Characteristic = label,
         N = N_obs,
         Events = N_event,
         `p value` = p.value)
forester(
  left_side_data = df_fp[2],
  right_side_data = df_fp[9:8],
  estimate = df_fp$estimate,
  ci_low = df_fp$conf.low,
  ci_high = df_fp$conf.high,
  estimate_col_name = "HR (95% CI)",
  xlim = c(0.1, 10),
  null_line_at = 1,
  arrows = TRUE,
  x_scale_linear = FALSE,
  arrow_labels = c("Better", "Worse"),
  font_family = "sans",
  display = TRUE,
  nudge_x = .4,
  nudge_height = .06,
  stripe_colour = "#F5F5F5",
  file_path = "/Users/aportugu/Desktop/CD19 project/ASH abstract/forest/OS_mv_plot_PSM.png"
)

knitr::include_graphics("/Users/aportugu/Desktop/CD19 project/ASH abstract/forest/OS_mv_plot_PSM.png")
```

## Cox diagnostics

### PFS unweighted

```{r}
data1 <- dataset %>%
  mutate(
    ferritin.max = log(ferritin.max),
    IL6.max = log(IL6.max),
    LDH.min = log(LDH.min),
    Age = Age,
    `Male sex` = ifelse(Sex == "M",1,0),
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    `ALC pre-LD` = ALC.preLD,
    `LDH pre-LD` = LDH.preLD/1000,
    `High LDH pre-LD` = ifelse(LDH.preLD >=210,1,0),
    `LDH day 0` = LDH.d0/1000,
    `ALC day 0` = ALC.d0,
    `Largest lesion` = Largest.lesion
  )

res.cox <-coxph( Surv(Days.to.relapse.death.or.DLC, Relapse.or.death) ~ Product + `LDH pre-LD` + `ALC pre-LD` + `Largest lesion` + Age + `Male sex`, data1)

## Testing proportional hazards assumption
test.ph <- cox.zph(res.cox)
test.ph
```

### PFS IPTW

```{r}
data1 <- IPTW.data %>%
  mutate(
    `Male sex` = ifelse(Sex == "M",1,0),
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    `ALC pre-LD` = ALC.preLD,
    `LDH pre-LD` = LDH.preLD/1000,
    `High LDH pre-LD` = ifelse(LDH.preLD >=210,1,0),
    `LDH day 0` = LDH.d0/1000,
    `ALC day 0` = ALC.d0,
    `Largest lesion` = Largest.lesion
  )

res.cox <-coxph( Surv(Days.to.relapse.death.or.DLC, Relapse.or.death) ~ Product + `LDH pre-LD` + `ALC pre-LD` + `Largest lesion`+ Age + `Male sex`, data1, weights=weights)

## Testing proportional hazards assumption
test.ph <- cox.zph(res.cox)
test.ph
```

### PFS PSM

```{r}
data1 <- m.data %>%
  mutate(
    `Male sex` = ifelse(Sex == "M",1,0),
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    `ALC pre-LD` = ALC.preLD,
    `LDH pre-LD` = LDH.preLD/1000,
    `High LDH pre-LD` = ifelse(LDH.preLD >=210,1,0),
    `LDH day 0` = LDH.d0/1000,
    `ALC day 0` = ALC.d0,
    `Largest lesion` = Largest.lesion
  )

res.cox <-coxph( Surv(Days.to.relapse.death.or.DLC, Relapse.or.death) ~ Product + `LDH pre-LD` + `ALC pre-LD` + `Largest lesion`+ Age + `Male sex`, data1, weights=weights)

## Testing proportional hazards assumption
test.ph <- cox.zph(res.cox)
test.ph
```

### OS unweighted

```{r}
data1 <- dataset %>%
  mutate(
    ferritin.max = log(ferritin.max),
    IL6.max = log(IL6.max),
    LDH.min = log(LDH.min),
    Age = Age,
    `Male sex` = ifelse(Sex == "M",1,0),
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    `ALC pre-LD` = ALC.preLD,
    `LDH pre-LD` = LDH.preLD/1000,
    `High LDH pre-LD` = ifelse(LDH.preLD >=210,1,0),
    `LDH day 0` = LDH.d0/1000,
    `ALC day 0` = ALC.d0,
    `Largest lesion` = Largest.lesion
  )

res.cox <-coxph( Surv(Days.to.DLC, Death) ~ Product + `LDH pre-LD` + `ALC pre-LD` + `Largest lesion`+ Age + `Male sex`, data1)

## Testing proportional hazards assumption
test.ph <- cox.zph(res.cox)
test.ph
```

### OS IPTW

```{r}
data1 <- IPTW.data %>%
  mutate(
    ferritin.max = log(ferritin.max),
    IL6.max = log(IL6.max),
    LDH.min = log(LDH.min),
    Age = Age,
    `Male sex` = ifelse(Sex == "M",1,0),
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    `ALC pre-LD` = ALC.preLD,
    `LDH pre-LD` = LDH.preLD/1000,
    `High LDH pre-LD` = ifelse(LDH.preLD >=210,1,0),
    `LDH day 0` = LDH.d0/1000,
    `ALC day 0` = ALC.d0,
    `Largest lesion` = Largest.lesion
  )

res.cox <-coxph( Surv(Days.to.DLC, Death) ~ Product + `LDH pre-LD` + `ALC pre-LD` + `Largest lesion`+ Age + `Male sex`, data1, weights=weights)

## Testing proportional hazards assumption
test.ph <- cox.zph(res.cox)
test.ph
```

### OS PSM

```{r}
data1 <- m.data %>%
  mutate(
    ferritin.max = log(ferritin.max),
    IL6.max = log(IL6.max),
    LDH.min = log(LDH.min),
    Age = Age,
    `Male sex` = ifelse(Sex == "M",1,0),
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    `ALC pre-LD` = ALC.preLD,
    `LDH pre-LD` = LDH.preLD/1000,
    `High LDH pre-LD` = ifelse(LDH.preLD >=210,1,0),
    `LDH day 0` = LDH.d0/1000,
    `ALC day 0` = ALC.d0,
    `Largest lesion` = Largest.lesion
  )

res.cox <-coxph( Surv(Days.to.DLC, Death) ~ Product + `LDH pre-LD` + `ALC pre-LD` + `Largest lesion`+ Age + `Male sex`, data1, weights=weights)

## Testing proportional hazards assumption
test.ph <- cox.zph(res.cox)
test.ph
```

## Response

### Logistic Model - CR

```{r, warning=FALSE, message=FALSE}
theme_gtsummary_compact()
preds <- c("Best.CR", "Product", "LDH pre-LD","ALC pre-LD", "Largest lesion", "Age", "Male sex", "Bridging category") 

data0 <- dataset %>%
  mutate(
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    "Largest lesion" = Largest.lesion,
    "ALC pre-LD" = ALC.preLD,
    "LDH pre-LD" = LDH.preLD/1000,
    "Male sex" = ifelse(Sex == "M",1,0),
    "Bridging category" = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD"), levels = c("No bridging","CR/PR","SD/PD"))
  )

data1 <- IPTW.data %>%
  mutate(
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    "Largest lesion" = Largest.lesion,
    "ALC pre-LD" = ALC.preLD,
    "LDH pre-LD" = LDH.preLD/1000,
    "Male sex" = ifelse(Sex == "M",1,0),
    "Bridging category" = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD"), levels = c("No bridging","CR/PR","SD/PD"))
  )

data2 <- m.data %>%
  mutate(
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    "Largest lesion" = Largest.lesion,
    "ALC pre-LD" = ALC.preLD,
    "LDH pre-LD" = LDH.preLD/1000,
    "Male sex" = ifelse(Sex == "M",1,0),
    "Bridging category" = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD"), levels = c("No bridging","CR/PR","SD/PD"))
  )

uv_tab <- tbl_uvregression(
  data0[c(preds)],
  method = glm,
  y = Best.CR,
  method.args = list(family = binomial),
  exponentiate = TRUE
)


mv_tab<-glm( Best.CR ~  `LDH pre-LD` + Product + `Largest lesion` + `ALC pre-LD` + `Age` + `Male sex` + `Bridging category`, data0, family = binomial ) %>%
  tbl_regression(exponentiate=TRUE)

uv_tab_IPTW <- tbl_uvregression(
  data1[c(preds)],
  method = glm,
  y = Best.CR,
  method.args = list(family = binomial, weights = data1$weights),
  exponentiate = TRUE
)

mv_tab_IPTW<-glm( Best.CR ~  `LDH pre-LD` +Product + `Largest lesion` + `ALC pre-LD` +  `Age` + `Male sex` + `Bridging category`, data1, weights=weights, family = binomial ) %>% 
  tbl_regression(exponentiate=TRUE)


uv_tab_PSM <- tbl_uvregression(
  data2[c(preds)],
  method = glm,
  y = Best.CR,
  method.args = list(family = binomial, weights = data2$weights),
  exponentiate = TRUE
)

mv_tab_PSM<-glm( Best.CR ~  `LDH pre-LD` +Product + `Largest lesion` + `ALC pre-LD` +  `Age` + `Male sex` + `Bridging category`, data2, weights=weights, family = binomial ) %>% 
  tbl_regression(exponentiate=TRUE)

row1 <- tbl_merge(list(uv_tab, mv_tab), tab_spanner = c("**Univariate**", "**Multivariable**"))
row2 <- tbl_merge(list(uv_tab_IPTW, mv_tab_IPTW))
row3 <- tbl_merge(list(uv_tab_PSM, mv_tab_PSM))
tbl_stack(list(row1, row2, row3), group_header = c("UNWEIGHTED ANALYSIS", "IPTW ANALYSIS", "PSM ANALYSIS"), quiet=TRUE)

```

### Logistic CR forest plots

```{r, warning=FALSE, message=FALSE}
## Forest plot for MV
df_fp <- mv_tab$table_body %>%
  select(header_row, label, N_obs, N_event, estimate, conf.low, conf.high, p.value, ) %>%
  mutate(
    label = ifelse(header_row == TRUE | is.na(header_row),as.character(label), paste0("     ", as.character(label)) ),
    p.value = signif(p.value, 2),
    `OR (95% CI)` = ifelse(
      is.na(estimate),"",paste0(round(estimate, 2), " (", round(conf.low,2), " to ",round(conf.high,2), ") ")
    )
  ) %>%
  rename(Characteristic = label,
         N = N_obs,
         Events = N_event,
         `p value` = p.value)
forester(
  left_side_data = df_fp[2],
  right_side_data = df_fp[9:8],
  estimate = df_fp$estimate,
  ci_low = df_fp$conf.low,
  ci_high = df_fp$conf.high,
  estimate_col_name = "OR (95% CI)",
  xlim = c(.05, 3),
  null_line_at = 1,
  arrows = TRUE,
  x_scale_linear = FALSE,
  arrow_labels = c("Worse", "Better"),
  font_family = "sans",
  display = TRUE,
  nudge_x = .4,
  nudge_height = .06,
  stripe_colour = "#F5F5F5",
  file_path = "/Users/aportugu/Desktop/CD19 project/ASH abstract/forest/CR_mv_plot.png"
)

knitr::include_graphics("/Users/aportugu/Desktop/CD19 project/ASH abstract/forest/CR_mv_plot.png")


## Forest plot for MV IPTW
df_fp <- mv_tab_IPTW$table_body %>%
  select(header_row, label, N_obs, N_event, estimate, conf.low, conf.high, p.value, ) %>%
  mutate(
    label = ifelse(header_row == TRUE | is.na(header_row),as.character(label), paste0("     ", as.character(label)) ),
    p.value = signif(p.value, 2),
    `OR (95% CI)` = ifelse(
      is.na(estimate),"",paste0(round(estimate, 2), " (", round(conf.low,2), " to ",round(conf.high,2), ") ")
    )
  ) %>%
  rename(Characteristic = label,
         N = N_obs,
         Events = N_event,
         `p value` = p.value)
forester(
  left_side_data = df_fp[2],
  right_side_data = df_fp[9:8],
  estimate = df_fp$estimate,
  ci_low = df_fp$conf.low,
  ci_high = df_fp$conf.high,
  estimate_col_name = "OR (95% CI)",
  xlim = c(.05, 3),
  null_line_at = 1,
  arrows = TRUE,
  x_scale_linear = FALSE,
  arrow_labels = c("Worse", "Better"),
  font_family = "sans",
  display = TRUE,
  nudge_x = .4,
  nudge_height = .06,
  stripe_colour = "#F5F5F5",
  file_path = "/Users/aportugu/Desktop/CD19 project/ASH abstract/forest/CR_mv_plot_IPTW.png"
)

knitr::include_graphics("/Users/aportugu/Desktop/CD19 project/ASH abstract/forest/CR_mv_plot_IPTW.png")

## Forest plot for MV PSM
df_fp <- mv_tab_PSM$table_body %>%
  select(header_row, label, N_obs, N_event, estimate, conf.low, conf.high, p.value, ) %>%
  mutate(
    label = ifelse(header_row == TRUE | is.na(header_row),as.character(label), paste0("     ", as.character(label)) ),
    p.value = signif(p.value, 2),
    `OR (95% CI)` = ifelse(
      is.na(estimate),"",paste0(round(estimate, 2), " (", round(conf.low,2), " to ",round(conf.high,2), ") ")
    )
  ) %>%
  rename(Characteristic = label,
         N = N_obs,
         Events = N_event,
         `p value` = p.value)
forester(
  left_side_data = df_fp[2],
  right_side_data = df_fp[9:8],
  estimate = df_fp$estimate,
  ci_low = df_fp$conf.low,
  ci_high = df_fp$conf.high,
  estimate_col_name = "OR (95% CI)",
  xlim = c(.05, 3),
  null_line_at = 1,
  arrows = TRUE,
  x_scale_linear = FALSE,
  arrow_labels = c("Worse", "Better"),
  font_family = "sans",
  display = TRUE,
  nudge_x = .4,
  nudge_height = .06,
  stripe_colour = "#F5F5F5",
  file_path = "/Users/aportugu/Desktop/CD19 project/ASH abstract/forest/CR_mv_plot_PSM.png"
)

knitr::include_graphics("/Users/aportugu/Desktop/CD19 project/ASH abstract/forest/CR_mv_plot_PSM.png")
```

## Toxicity

### Logistic Model - ICANS grade 1+
```{r, warning=FALSE, message=FALSE}
theme_gtsummary_compact()
preds <- c("ICANS.any","Product", "LDH pre-LD","ALC pre-LD", "Largest lesion", "Age", "Male sex", "CMV", "Bridging category") 

data0 <- dataset %>%
  mutate(
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    "Largest lesion" = Largest.lesion,
    "HCT-CI" = HCT.CI,
    "ALC pre-LD" = ALC.preLD,
    "LDH pre-LD" = LDH.preLD/1000,
    "Male sex" = ifelse(Sex == "M",1,0),
    ICANS.any=ifelse(ICANS.grade == 0,0,1),
    "Bridging category" = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD"), levels = c("No bridging","CR/PR","SD/PD"))
  )

data1 <- IPTW.data %>%
  mutate(
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    "Largest lesion" = Largest.lesion,
    "HCT-CI" = HCT.CI,
    "ALC pre-LD" = ALC.preLD,
    "LDH pre-LD" = LDH.preLD/1000,
    "Male sex" = ifelse(Sex == "M",1,0),
    ICANS.any=ifelse(ICANS.grade == 0,0,1),
    "Bridging category" = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD"), levels = c("No bridging","CR/PR","SD/PD"))
  )

data2 <- m.data %>%
  mutate(
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    "Largest lesion" = Largest.lesion,
    "HCT-CI" = HCT.CI,
    "ALC pre-LD" = ALC.preLD,
    "LDH pre-LD" = LDH.preLD/1000,
    "Male sex" = ifelse(Sex == "M",1,0),
    ICANS.any=ifelse(ICANS.grade == 0,0,1),
    "Bridging category" = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD"), levels = c("No bridging","CR/PR","SD/PD"))
  )

uv_tab <- tbl_uvregression(
  data0[c(preds)],
  method = glm,
  y = ICANS.any,
  method.args = list(family = binomial),
  exponentiate = TRUE
)


mv_tab<-glm( ICANS.any ~ Product + `Largest lesion` + `ALC pre-LD` + Age + `Male sex` + `LDH pre-LD` + `Bridging category`, data0, family = binomial ) %>%
  tbl_regression(exponentiate=TRUE) 

uv_tab_IPTW <- tbl_uvregression(
  data1[c(preds)],
  method = glm,
  y = ICANS.any,
  method.args = list(family = binomial, weights = data1$weights),
  exponentiate = TRUE
)

mv_tab_IPTW<-glm( ICANS.any ~ Product + `Largest lesion` + `ALC pre-LD` + Age + `Male sex` + `LDH pre-LD` + `Bridging category`, data1, family = binomial, weights=weights ) %>%
  tbl_regression(exponentiate=TRUE) 


uv_tab_PSM <- tbl_uvregression(
  data2[c(preds)],
  method = glm,
  y = ICANS.any,
  method.args = list(family = binomial, weights = data2$weights),
  exponentiate = TRUE
)

mv_tab_PSM<-glm( ICANS.any ~ Product + `Largest lesion` + `ALC pre-LD` + Age + `Male sex` + `LDH pre-LD` + `Bridging category`, data2, family = binomial, weights=weights ) %>%
  tbl_regression(exponentiate=TRUE) 

row1 <- tbl_merge(list(uv_tab, mv_tab), tab_spanner = c("**Univariate**", "**Multivariable**"))
row2 <- tbl_merge(list(uv_tab_IPTW, mv_tab_IPTW))
row3 <- tbl_merge(list(uv_tab_PSM, mv_tab_PSM))
tbl_stack(list(row1, row2, row3), group_header = c("UNWEIGHTED ANALYSIS", "IPTW ANALYSIS", "PSM ANALYSIS"), quiet=TRUE)
```

### Logistic Model - ICANS grade 2+
```{r, warning=FALSE, message=FALSE}
theme_gtsummary_compact()
preds <- c("ICANS2.4","Product", "LDH pre-LD","ALC pre-LD", "Largest lesion", "Age", "Male sex", "Bridging category") 

data0 <- dataset %>%
  mutate(
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    "Largest lesion" = Largest.lesion,
    "HCT-CI" = HCT.CI,
    "ALC pre-LD" = ALC.preLD,
    "LDH pre-LD" = LDH.preLD/1000,
    "Male sex" = ifelse(Sex == "M",1,0),
    ICANS2.4=ifelse(ICANS.grade == 0 | ICANS.grade == 1 ,0,1),
    "Bridging category" = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD"), levels = c("No bridging","CR/PR","SD/PD"))
  )

data1 <- IPTW.data %>%
  mutate(
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    "Largest lesion" = Largest.lesion,
    "HCT-CI" = HCT.CI,
    "ALC pre-LD" = ALC.preLD,
    "LDH pre-LD" = LDH.preLD/1000,
    "Male sex" = ifelse(Sex == "M",1,0),
    ICANS2.4=ifelse(ICANS.grade == 0 | ICANS.grade == 1 ,0,1),
    "Bridging category" = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD"), levels = c("No bridging","CR/PR","SD/PD"))
  )

data2 <- m.data %>%
  mutate(
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    "Largest lesion" = Largest.lesion,
    "HCT-CI" = HCT.CI,
    "ALC pre-LD" = ALC.preLD,
    "LDH pre-LD" = LDH.preLD/1000,
    "Male sex" = ifelse(Sex == "M",1,0),
    ICANS2.4=ifelse(ICANS.grade == 0 | ICANS.grade == 1 ,0,1),
    "Bridging category" = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD"), levels = c("No bridging","CR/PR","SD/PD"))
  )

uv_tab <- tbl_uvregression(
  data0[c(preds)],
  method = glm,
  y = ICANS2.4,
  method.args = list(family = binomial),
  exponentiate = TRUE
)


mv_tab<-glm( ICANS2.4 ~ Product + `Largest lesion` + `ALC pre-LD` + Age + `Male sex` + `LDH pre-LD` + `Bridging category`, data0, family = binomial ) %>%
  tbl_regression(exponentiate=TRUE) 

uv_tab_IPTW <- tbl_uvregression(
  data1[c(preds)],
  method = glm,
  y = ICANS2.4,
  method.args = list(family = binomial, weights = data1$weights),
  exponentiate = TRUE
)

mv_tab_IPTW<-glm( ICANS2.4 ~ Product + `Largest lesion` + `ALC pre-LD` + Age + `Male sex` + `LDH pre-LD`+ `Bridging category`, data1, family = binomial, weights=weights ) %>%
  tbl_regression(exponentiate=TRUE) 


uv_tab_PSM <- tbl_uvregression(
  data2[c(preds)],
  method = glm,
  y = ICANS2.4,
  method.args = list(family = binomial, weights = data2$weights),
  exponentiate = TRUE
)

mv_tab_PSM<-glm( ICANS2.4 ~ Product + `Largest lesion` + `ALC pre-LD` + Age + `Male sex` + `LDH pre-LD`+ `Bridging category`, data2, family = binomial, weights=weights ) %>%
  tbl_regression(exponentiate=TRUE) 

row1 <- tbl_merge(list(uv_tab, mv_tab), tab_spanner = c("**Univariate**", "**Multivariable**"))
row2 <- tbl_merge(list(uv_tab_IPTW, mv_tab_IPTW))
row3 <- tbl_merge(list(uv_tab_PSM, mv_tab_PSM))
tbl_stack(list(row1, row2, row3), group_header = c("UNWEIGHTED ANALYSIS", "IPTW ANALYSIS", "PSM ANALYSIS"), quiet=TRUE)
```

### Logistic Model - ICANS grade 3+
```{r, warning=FALSE, message=FALSE}
theme_gtsummary_compact()
preds <- c("ICANS3.4","Product", "LDH pre-LD","ALC pre-LD", "Largest lesion", "Age", "Male sex", "CMV", "Bridging category") 

data0 <- dataset %>%
  mutate(
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    "Largest lesion" = Largest.lesion,
    "HCT-CI" = HCT.CI,
    "ALC pre-LD" = ALC.preLD,
    "LDH pre-LD" = LDH.preLD/1000,
    "Male sex" = ifelse(Sex == "M",1,0),
    ICANS3.4=ifelse(ICANS.grade == 3 | ICANS.grade == 4,1,0),
    "Bridging category" = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD"), levels = c("No bridging","CR/PR","SD/PD"))
  )

data1 <- IPTW.data %>%
  mutate(
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    "Largest lesion" = Largest.lesion,
    "HCT-CI" = HCT.CI,
    "ALC pre-LD" = ALC.preLD,
    "LDH pre-LD" = LDH.preLD/1000,
    "Male sex" = ifelse(Sex == "M",1,0),
    ICANS3.4=ifelse(ICANS.grade == 3 | ICANS.grade == 4,1,0),
    "Bridging category" = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD"), levels = c("No bridging","CR/PR","SD/PD"))
  )

data2 <- m.data %>%
  mutate(
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    "Largest lesion" = Largest.lesion,
    "HCT-CI" = HCT.CI,
    "ALC pre-LD" = ALC.preLD,
    "LDH pre-LD" = LDH.preLD/1000,
    "Male sex" = ifelse(Sex == "M",1,0),
    ICANS3.4=ifelse(ICANS.grade == 3 | ICANS.grade == 4,1,0),
    "Bridging category" = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD"), levels = c("No bridging","CR/PR","SD/PD"))
  )

uv_tab <- tbl_uvregression(
  data0[c(preds)],
  method = glm,
  y = ICANS3.4,
  method.args = list(family = binomial),
  exponentiate = TRUE
)

mv_tab<-glm( ICANS3.4 ~ Product + `Largest lesion` + `ALC pre-LD` + Age + `Male sex` + `LDH pre-LD` + `Bridging category`, data0, family = binomial ) %>% tbl_regression(exponentiate=TRUE) 

uv_tab_IPTW <- tbl_uvregression(
  data1[c(preds)],
  method = glm,
  y = ICANS3.4,
  method.args = list(family = binomial, weights = data1$weights),
  exponentiate = TRUE
)

mv_tab_IPTW<-glm( ICANS3.4 ~ Product + `Largest lesion` + `ALC pre-LD` + Age + `Male sex` + `LDH pre-LD` + `Bridging category`, data1, family = binomial, weights=weights ) %>%
  tbl_regression(exponentiate=TRUE) 

uv_tab_PSM <- tbl_uvregression(
  data2[c(preds)],
  method = glm,
  y = ICANS3.4,
  method.args = list(family = binomial, weights = data2$weights),
  exponentiate = TRUE
)

mv_tab_PSM<-glm( ICANS3.4 ~ Product + `Largest lesion` + `ALC pre-LD` + Age + `Male sex` + `LDH pre-LD` + `Bridging category`, data2, family = binomial, weights=weights ) %>%
  tbl_regression(exponentiate=TRUE) 

row1 <- tbl_merge(list(uv_tab, mv_tab), tab_spanner = c("**Univariate**", "**Multivariable**"))
row2 <- tbl_merge(list(uv_tab_IPTW, mv_tab_IPTW))
row3 <- tbl_merge(list(uv_tab_PSM, mv_tab_PSM))
tbl_stack(list(row1, row2, row3), group_header = c("UNWEIGHTED ANALYSIS", "IPTW ANALYSIS", "PSM ANALYSIS"), quiet=TRUE)
```

### Logistic Model - CRS grade 1+
```{r, warning=FALSE, message=FALSE}
theme_gtsummary_compact()
preds <- c("CRS.any","Product", "LDH pre-LD","ALC pre-LD", "Largest lesion", "Age", "Male sex", "CMV", "Bridging category") 

data0 <- dataset %>%
  mutate(
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    "Largest lesion" = Largest.lesion,
    "HCT-CI" = HCT.CI,
    "ALC pre-LD" = ALC.preLD,
    "LDH pre-LD" = LDH.preLD/1000,
    "Male sex" = ifelse(Sex == "M",1,0),
    CRS.any=ifelse(CRS.grade == 0,0,1),
    "Bridging category" = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD"), levels = c("No bridging","CR/PR","SD/PD"))
  )

data1 <- IPTW.data %>%
  mutate(
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    "Largest lesion" = Largest.lesion,
    "HCT-CI" = HCT.CI,
    "ALC pre-LD" = ALC.preLD,
    "LDH pre-LD" = LDH.preLD/1000,
    "Male sex" = ifelse(Sex == "M",1,0),
    CRS.any=ifelse(CRS.grade == 0,0,1),
    "Bridging category" = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD"), levels = c("No bridging","CR/PR","SD/PD"))
  )

data2 <- m.data %>%
  mutate(
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    "Largest lesion" = Largest.lesion,
    "HCT-CI" = HCT.CI,
    "ALC pre-LD" = ALC.preLD,
    "LDH pre-LD" = LDH.preLD/1000,
    "Male sex" = ifelse(Sex == "M",1,0),
    CRS.any=ifelse(CRS.grade == 0,0,1),
    "Bridging category" = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD"), levels = c("No bridging","CR/PR","SD/PD"))
  )

uv_tab <- tbl_uvregression(
  data0[c(preds)],
  method = glm,
  y = CRS.any,
  method.args = list(family = binomial),
  exponentiate = TRUE
)

mv_tab<-glm( CRS.any ~ Product + `Largest lesion` + `ALC pre-LD` + Age + `Male sex` + `LDH pre-LD` + `Bridging category`, data0, family = binomial ) %>% tbl_regression(exponentiate=TRUE) 

uv_tab_IPTW <- tbl_uvregression(
  data1[c(preds)],
  method = glm,
  y = CRS.any,
  method.args = list(family = binomial, weights = data1$weights),
  exponentiate = TRUE
)

mv_tab_IPTW<-glm( CRS.any ~ Product + `Largest lesion` + `ALC pre-LD` + Age + `Male sex` + `LDH pre-LD` + `Bridging category`, data1, family = binomial, weights=weights ) %>%
  tbl_regression(exponentiate=TRUE) 

uv_tab_PSM <- tbl_uvregression(
  data2[c(preds)],
  method = glm,
  y = CRS.any,
  method.args = list(family = binomial, weights = data2$weights),
  exponentiate = TRUE
)

mv_tab_PSM<-glm( CRS.any ~ Product + `Largest lesion` + `ALC pre-LD` + Age + `Male sex` + `LDH pre-LD` + `Bridging category`, data2, family = binomial, weights=weights ) %>%
  tbl_regression(exponentiate=TRUE) 

row1 <- tbl_merge(list(uv_tab, mv_tab), tab_spanner = c("**Univariate**", "**Multivariable**"))
row2 <- tbl_merge(list(uv_tab_IPTW, mv_tab_IPTW))
row3 <- tbl_merge(list(uv_tab_PSM, mv_tab_PSM))
tbl_stack(list(row1, row2, row3), group_header = c("UNWEIGHTED ANALYSIS", "IPTW ANALYSIS", "PSM ANALYSIS"), quiet=TRUE)
```

### Logistic Model - CRS grade 2+
```{r, warning=FALSE, message=FALSE}
theme_gtsummary_compact()
preds <- c("CRS2.4","Product", "LDH pre-LD","ALC pre-LD", "Largest lesion", "Age", "Male sex", "CMV", "Bridging category") 

data0 <- dataset %>%
  mutate(
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    "Largest lesion" = Largest.lesion,
    "HCT-CI" = HCT.CI,
    "ALC pre-LD" = ALC.preLD,
    "LDH pre-LD" = LDH.preLD/1000,
    "Male sex" = ifelse(Sex == "M",1,0),
    CRS2.4=ifelse(CRS.grade == 0 | CRS.grade == 1 ,0,1),
    "Bridging category" = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD"), levels = c("No bridging","CR/PR","SD/PD"))
  )

data1 <- IPTW.data %>%
  mutate(
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    "Largest lesion" = Largest.lesion,
    "HCT-CI" = HCT.CI,
    "ALC pre-LD" = ALC.preLD,
    "LDH pre-LD" = LDH.preLD/1000,
    "Male sex" = ifelse(Sex == "M",1,0),
    CRS2.4=ifelse(CRS.grade == 0 | CRS.grade == 1 ,0,1),
    "Bridging category" = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD"), levels = c("No bridging","CR/PR","SD/PD"))
  )

data2 <- m.data %>%
  mutate(
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    "Largest lesion" = Largest.lesion,
    "HCT-CI" = HCT.CI,
    "ALC pre-LD" = ALC.preLD,
    "LDH pre-LD" = LDH.preLD/1000,
    "Male sex" = ifelse(Sex == "M",1,0),
    CRS2.4=ifelse(CRS.grade == 0 | CRS.grade == 1 ,0,1),
    "Bridging category" = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD"), levels = c("No bridging","CR/PR","SD/PD"))
  )

uv_tab <- tbl_uvregression(
  data0[c(preds)],
  method = glm,
  y = CRS2.4,
  method.args = list(family = binomial),
  exponentiate = TRUE
)

mv_tab<-glm( CRS2.4 ~ Product + `Largest lesion` + `ALC pre-LD` + Age + `Male sex` + `LDH pre-LD` + `Bridging category`, data0, family = binomial ) %>% tbl_regression(exponentiate=TRUE) 

uv_tab_IPTW <- tbl_uvregression(
  data1[c(preds)],
  method = glm,
  y = CRS2.4,
  method.args = list(family = binomial, weights = data1$weights),
  exponentiate = TRUE
)

mv_tab_IPTW<-glm( CRS2.4 ~ Product + `Largest lesion` + `ALC pre-LD` + Age + `Male sex` + `LDH pre-LD` + `Bridging category`, data1, family = binomial, weights=weights ) %>%
  tbl_regression(exponentiate=TRUE) 

uv_tab_PSM <- tbl_uvregression(
  data2[c(preds)],
  method = glm,
  y = CRS2.4,
  method.args = list(family = binomial, weights = data2$weights),
  exponentiate = TRUE
)

mv_tab_PSM<-glm( CRS2.4 ~ Product + `Largest lesion` + `ALC pre-LD` + Age + `Male sex` + `LDH pre-LD` + `Bridging category`, data2, family = binomial, weights=weights ) %>%
  tbl_regression(exponentiate=TRUE) 

row1 <- tbl_merge(list(uv_tab, mv_tab), tab_spanner = c("**Univariate**", "**Multivariable**"))
row2 <- tbl_merge(list(uv_tab_IPTW, mv_tab_IPTW))
row3 <- tbl_merge(list(uv_tab_PSM, mv_tab_PSM))
tbl_stack(list(row1, row2, row3), group_header = c("UNWEIGHTED ANALYSIS", "IPTW ANALYSIS", "PSM ANALYSIS"), quiet=TRUE)
```

### Logistic Model - CRS grade 3+
```{r, warning=FALSE, message=FALSE}
theme_gtsummary_compact()
preds <- c("CRS3.4","Product", "LDH pre-LD","ALC pre-LD", "Largest lesion", "Age", "Male sex", "CMV", "Bridging category") 

data0 <- dataset %>%
  mutate(
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    "Largest lesion" = Largest.lesion,
    "HCT-CI" = HCT.CI,
    "ALC pre-LD" = ALC.preLD,
    "LDH pre-LD" = LDH.preLD/1000,
    "Male sex" = ifelse(Sex == "M",1,0),
    CRS3.4=ifelse(CRS.grade == 3 | CRS.grade == 4,1,0),
    "Bridging category" = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD"), levels = c("No bridging","CR/PR","SD/PD"))
  )

data1 <- IPTW.data %>%
  mutate(
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    "Largest lesion" = Largest.lesion,
    "HCT-CI" = HCT.CI,
    "ALC pre-LD" = ALC.preLD,
    "LDH pre-LD" = LDH.preLD/1000,
    "Male sex" = ifelse(Sex == "M",1,0),
    CRS3.4=ifelse(CRS.grade == 3 | CRS.grade == 4,1,0),
    "Bridging category" = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD"), levels = c("No bridging","CR/PR","SD/PD"))
  )

data2 <- m.data %>%
  mutate(
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    "Largest lesion" = Largest.lesion,
    "HCT-CI" = HCT.CI,
    "ALC pre-LD" = ALC.preLD,
    "LDH pre-LD" = LDH.preLD/1000,
    "Male sex" = ifelse(Sex == "M",1,0),
    CRS3.4=ifelse(CRS.grade == 3 | CRS.grade == 4,1,0),
    "Bridging category" = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD"), levels = c("No bridging","CR/PR","SD/PD"))
  )

uv_tab <- tbl_uvregression(
  data0[c(preds)],
  method = glm,
  y = CRS3.4,
  method.args = list(family = binomial),
  exponentiate = TRUE
)

mv_tab<-glm( CRS3.4 ~ Product + `Largest lesion` + `ALC pre-LD` + Age + `Male sex` + `LDH pre-LD` + `Bridging category`, data0, family = binomial ) %>% tbl_regression(exponentiate=TRUE) 

uv_tab_IPTW <- tbl_uvregression(
  data1[c(preds)],
  method = glm,
  y = CRS3.4,
  method.args = list(family = binomial, weights = data1$weights),
  exponentiate = TRUE
)

mv_tab_IPTW<-glm( CRS3.4 ~ Product + `Largest lesion` + `ALC pre-LD` + Age + `Male sex` + `LDH pre-LD` + `Bridging category`, data1, family = binomial, weights=weights ) %>%
  tbl_regression(exponentiate=TRUE) 

uv_tab_PSM <- tbl_uvregression(
  data2[c(preds)],
  method = glm,
  y = CRS3.4,
  method.args = list(family = binomial, weights = data2$weights),
  exponentiate = TRUE
)

mv_tab_PSM<-glm( CRS3.4 ~ Product + `Largest lesion` + `ALC pre-LD` + Age + `Male sex` + `LDH pre-LD` + `Bridging category`, data2, family = binomial, weights=weights ) %>%
  tbl_regression(exponentiate=TRUE) 

row1 <- tbl_merge(list(uv_tab, mv_tab), tab_spanner = c("**Univariate**", "**Multivariable**"))
row2 <- tbl_merge(list(uv_tab_IPTW, mv_tab_IPTW))
row3 <- tbl_merge(list(uv_tab_PSM, mv_tab_PSM))
tbl_stack(list(row1, row2, row3), group_header = c("UNWEIGHTED ANALYSIS", "IPTW ANALYSIS", "PSM ANALYSIS"), quiet=TRUE)
```

## Medication administration

### Tocilizumab
```{r, warning=FALSE, message=FALSE}
theme_gtsummary_compact()
preds <- c("toci.doses","Product", "LDH pre-LD","ALC pre-LD", "Largest lesion", "Age", "Male sex", "CMV", "Bridging category") 

data0 <- dataset %>%
  mutate(
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    "Largest lesion" = Largest.lesion,
    "HCT-CI" = HCT.CI,
    "ALC pre-LD" = ALC.preLD,
    "LDH pre-LD" = LDH.preLD/1000,
    "Male sex" = ifelse(Sex == "M",1,0),
    CRS2.4=ifelse(CRS.grade == 0 | CRS.grade == 1 ,0,1),
    "Bridging category" = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD"), levels = c("No bridging","CR/PR","SD/PD"))
  )

data1 <- IPTW.data %>%
  mutate(
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    "Largest lesion" = Largest.lesion,
    "HCT-CI" = HCT.CI,
    "ALC pre-LD" = ALC.preLD,
    "LDH pre-LD" = LDH.preLD/1000,
    "Male sex" = ifelse(Sex == "M",1,0),
    CRS2.4=ifelse(CRS.grade == 0 | CRS.grade == 1 ,0,1),
    "Bridging category" = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD"), levels = c("No bridging","CR/PR","SD/PD"))
  )

data2 <- m.data %>%
  mutate(
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    "Largest lesion" = Largest.lesion,
    "HCT-CI" = HCT.CI,
    "ALC pre-LD" = ALC.preLD,
    "LDH pre-LD" = LDH.preLD/1000,
    "Male sex" = ifelse(Sex == "M",1,0),
    CRS2.4=ifelse(CRS.grade == 0 | CRS.grade == 1 ,0,1),
    "Bridging category" = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD"), levels = c("No bridging","CR/PR","SD/PD"))
  )

uv_tab <- tbl_uvregression(
  data0[c(preds)],
  method = lm,
  y = toci.doses
)

mv_tab<-lm( toci.doses ~ Product + `Largest lesion` + `ALC pre-LD` + Age + `Male sex` + `LDH pre-LD` + `Bridging category`, data0) %>% tbl_regression() 

uv_tab_IPTW <- tbl_uvregression(
  data1[c(preds)],
  method = lm,
  y = toci.doses,
  method.args = list(weights = data1$weights)
)

mv_tab_IPTW<-lm( toci.doses ~ Product + `Largest lesion` + `ALC pre-LD` + Age + `Male sex` + `LDH pre-LD` + `Bridging category`, data1, weights=weights ) %>%
  tbl_regression() 

uv_tab_PSM <- tbl_uvregression(
  data2[c(preds)],
  method = lm,
  y = toci.doses,
  method.args = list(weights = data2$weights)
)

mv_tab_PSM<-lm( toci.doses ~ Product + `Largest lesion` + `ALC pre-LD` + Age + `Male sex` + `LDH pre-LD` + `Bridging category`, data2, weights=weights ) %>%
  tbl_regression() 

row1 <- tbl_merge(list(uv_tab, mv_tab), tab_spanner = c("**Univariate**", "**Multivariable**"))
row2 <- tbl_merge(list(uv_tab_IPTW, mv_tab_IPTW))
row3 <- tbl_merge(list(uv_tab_PSM, mv_tab_PSM))
tbl_stack(list(row1, row2, row3), group_header = c("UNWEIGHTED ANALYSIS", "IPTW ANALYSIS", "PSM ANALYSIS"), quiet=TRUE)
```


### Cefepime
```{r, warning=FALSE, message=FALSE}
theme_gtsummary_compact()
preds <- c("cefepime.doses","Product", "LDH pre-LD","ALC pre-LD", "Largest lesion", "Age", "Male sex", "CMV", "Bridging category") 

data0 <- dataset %>%
  mutate(
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    "Largest lesion" = Largest.lesion,
    "HCT-CI" = HCT.CI,
    "ALC pre-LD" = ALC.preLD,
    "LDH pre-LD" = LDH.preLD/1000,
    "Male sex" = ifelse(Sex == "M",1,0),
    CRS2.4=ifelse(CRS.grade == 0 | CRS.grade == 1 ,0,1),
    "Bridging category" = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD"), levels = c("No bridging","CR/PR","SD/PD"))
  )

data1 <- IPTW.data %>%
  mutate(
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    "Largest lesion" = Largest.lesion,
    "HCT-CI" = HCT.CI,
    "ALC pre-LD" = ALC.preLD,
    "LDH pre-LD" = LDH.preLD/1000,
    "Male sex" = ifelse(Sex == "M",1,0),
    CRS2.4=ifelse(CRS.grade == 0 | CRS.grade == 1 ,0,1),
    "Bridging category" = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD"), levels = c("No bridging","CR/PR","SD/PD"))
  )

data2 <- m.data %>%
  mutate(
    Product = factor(recode(CAR.T.Product.Type, "Yescarta" = "Axi-cel","Breyanzi" = "Liso-cel"), levels = c("Liso-cel","Axi-cel") ),
    "Largest lesion" = Largest.lesion,
    "HCT-CI" = HCT.CI,
    "ALC pre-LD" = ALC.preLD,
    "LDH pre-LD" = LDH.preLD/1000,
    "Male sex" = ifelse(Sex == "M",1,0),
    CRS2.4=ifelse(CRS.grade == 0 | CRS.grade == 1 ,0,1),
    "Bridging category" = factor(recode(Bridging.response.category, "0" = "No bridging", "1" = "CR/PR", "2" = "SD/PD"), levels = c("No bridging","CR/PR","SD/PD"))
  )

uv_tab <- tbl_uvregression(
  data0[c(preds)],
  method = lm,
  y = cefepime.doses
)

mv_tab<-lm( cefepime.doses ~ Product + `Largest lesion` + `ALC pre-LD` + Age + `Male sex` + `LDH pre-LD` + `Bridging category`, data0) %>% tbl_regression() 

uv_tab_IPTW <- tbl_uvregression(
  data1[c(preds)],
  method = lm,
  y = cefepime.doses,
  method.args = list(weights = data1$weights)
)

mv_tab_IPTW<-lm( cefepime.doses ~ Product + `Largest lesion` + `ALC pre-LD` + Age + `Male sex` + `LDH pre-LD` + `Bridging category`, data1, weights=weights ) %>%
  tbl_regression() 

uv_tab_PSM <- tbl_uvregression(
  data2[c(preds)],
  method = lm,
  y = cefepime.doses,
  method.args = list(weights = data2$weights)
)

mv_tab_PSM<-lm( cefepime.doses ~ Product + `Largest lesion` + `ALC pre-LD` + Age + `Male sex` + `LDH pre-LD` + `Bridging category`, data2, weights=weights ) %>%
  tbl_regression() 

row1 <- tbl_merge(list(uv_tab, mv_tab), tab_spanner = c("**Univariate**", "**Multivariable**"))
row2 <- tbl_merge(list(uv_tab_IPTW, mv_tab_IPTW))
row3 <- tbl_merge(list(uv_tab_PSM, mv_tab_PSM))
tbl_stack(list(row1, row2, row3), group_header = c("UNWEIGHTED ANALYSIS", "IPTW ANALYSIS", "PSM ANALYSIS"), quiet=TRUE)
```

# PROBABILITY PLOTS

## Response based on labs and imaging

### Probability of CR: LDH pre-LD, stratified by product

```{r}
data1 <- filter(dataset, Infused == 1) %>%
  mutate(
    CAR.T.Product.Type = recode(CAR.T.Product.Type, "Breyanzi"="Liso-cel","Yescarta"="Axi-cel")
  )

dd <- datadist(data1)
options(datadist='dd')

fit <- lrm(Best.CR ~ CAR.T.Product.Type * LDH.preLD, data=data1)

data.frame(Predict(fit,LDH.preLD,CAR.T.Product.Type,fun = plogis)) %>%
  ggplot() +
  geom_line(aes(x=LDH.preLD,y=yhat,col=CAR.T.Product.Type)) +
  geom_ribbon(aes(x=LDH.preLD,ymin=lower, ymax=upper,fill=CAR.T.Product.Type),alpha=0.10)+
  labs(x = "LDH pre-LD (U/L)",
       y = "Probability of CR")+
  #scale_x_continuous(labels = alc_breaks,breaks = c(-.5,-.25,0,.25))+
  #ggtitle("Figure.")+
  theme_bw() +
  theme(title = element_text(size=16,face="bold"),legend.title=element_blank()) + 
  ylim(0,1)
```

### Probability of CR: largest lesion, stratified by product

```{r}
data1 <- filter(dataset, Infused == 1) %>%
  mutate(
    CAR.T.Product.Type = recode(CAR.T.Product.Type, "Breyanzi"="Liso-cel","Yescarta"="Axi-cel")
  )

dd <- datadist(data1)
options(datadist='dd')

fit <- lrm(Best.CR ~ CAR.T.Product.Type*Largest.lesion, data=data1)

data.frame(Predict(fit,Largest.lesion,CAR.T.Product.Type,fun = plogis)) %>%
  ggplot() +
  geom_line(aes(x=Largest.lesion,y=yhat,col=CAR.T.Product.Type)) +
  geom_ribbon(aes(x=Largest.lesion,ymin=lower, ymax=upper,fill=CAR.T.Product.Type),alpha=0.10)+
  labs(x = "Largest lesion (cm)",
       y = "Probability of CR")+
  #scale_x_continuous(labels = alc_breaks,breaks = c(-.5,-.25,0,.25))+
  #ggtitle("Figure.")+
  theme_bw() +
  theme(title = element_text(size=16,face="bold"),legend.title=element_blank()) + 
  ylim(0,1)
```

### Probability of CR and PD: ALC (RCS)

```{r}
data1 <- filter(dataset, Infused == 1)

dd <- datadist(data1)
options(datadist='dd')

fit <- lrm(Best.CR ~ rcs(ALC.preLD,3), data=data1)
df1 <- data.frame(Predict(fit,ALC.preLD,fun = plogis))

fit2 <- lrm(Best.PD ~ rcs(ALC.preLD,3), data=data1)
df2 <- data.frame(Predict(fit2,ALC.preLD,fun = plogis))

ggplot() + 
  geom_line(data=df1, aes(x=ALC.preLD,y=yhat, color = "CR")) + geom_ribbon( data=df1, aes(x=ALC.preLD,ymin=lower, ymax=upper),alpha=0.10)+
  geom_line(data=df2, aes(x=ALC.preLD,y=yhat, color ="PD" )) + geom_ribbon(data = df2, aes(x=ALC.preLD,ymin=lower, ymax=upper),alpha=0.10)+
  labs(x = "ALC pre-LD (10\U00B3/\U00B5L)",
       y = "Probability")+
  theme_bw() +
  scale_y_continuous(breaks=c(0,0.2,0.4,0.6,0.8,1.0), limits=c(0, 1)) + 
  scale_x_continuous(breaks=c(0.25,0.5,0.75,1.0,1.25,1.5,1.75), limits=c(0.25, 1.75)) + 
  theme(legend.position = c(0, 1),legend.justification = c(-9, 1.1))+
  scale_color_manual(values = c ("steelblue","coral2")) + 
  theme(title = element_text(size=20,face="bold"),legend.title=element_blank())
```

### Hazard of PFS: LDH pre-LD

```{r}
data1 <- filter(dataset, Infused == 1)

S <- Surv(data1$Days.to.relapse.death.or.DLC, data1$Relapse.or.death)
f <- cph(S ~ LDH.preLD * CAR.T.Product.Type, x=TRUE, y=TRUE,surv=TRUE,data=data1)

model <- Predict(f, CAR.T.Product.Type, LDH.preLD, fun=function(x) exp(x) )

ggplot(as.data.frame(model),aes(x=LDH.preLD, y=yhat, z = CAR.T.Product.Type)) + 
  geom_line(
    aes(col = CAR.T.Product.Type)
  ) + 
  geom_ribbon(data = model, aes(ymin=lower, ymax=upper), alpha=0.2, linetype=0) + 
  theme_bw() + 
  labs(
    #title = "Survival by product and LDH pre-LD",
    x = "LDH pre-LD (U/L)",
    y = "PFS (hazard)") +
  theme(title = element_text(size=16,face="bold"),legend.title=element_blank())
```

### Probability of CR and PD: LDH pre-LD

```{r}
data1 <- filter(dataset, Infused == 1)

dd <- datadist(data1)
options(datadist='dd')

fit <- lrm(Best.CR ~ LDH.preLD, data=data1)

df1 <- data.frame(Predict(fit,LDH.preLD,fun = plogis))



fit2 <- lrm(Best.PD ~ LDH.preLD, data=data1)
df2 <- data.frame(Predict(fit2,LDH.preLD,fun = plogis))

ggplot() + 
  geom_line(data=df1, aes(x=LDH.preLD,y=yhat, color = "CR")) + geom_ribbon( data=df1, aes(x=LDH.preLD,ymin=lower, ymax=upper),alpha=0.10)+
  geom_line(data=df2, aes(x=LDH.preLD,y=yhat, color ="PD" )) + geom_ribbon(data = df2, aes(x=LDH.preLD,ymin=lower, ymax=upper),alpha=0.10)+
  labs(x = "LDH pre-LD (U/L)",
       y = "Probability")+
  theme_classic() +
  scale_y_continuous(breaks=c(0,0.2,0.4,0.6,0.8,1.0), limits=c(0, 1)) + 
  #scale_x_continuous(breaks=c(0.25,0.5,0.75,1.0,1.25,1.5,1.75), limits=c(0.25, 1.75)) + 
  theme(legend.position = c(0, 1),legend.justification = c(-9, 1.1))+
  scale_color_manual(values = c ("steelblue","coral2")) + 
  theme(title = element_text(size=20,face="bold"),legend.title=element_blank())
```

### Probability of CR: LDH pre-LD

```{r}
data1 <- filter(dataset, Infused == 1)

dd <- datadist(data1)
options(datadist='dd')

fit <- lrm(Best.CR ~ rcs(LDH.preLD,3), data=data1)

data.frame(Predict(fit,LDH.preLD,fun = plogis)) %>%
  ggplot() +
  geom_line(aes(x=LDH.preLD,y=yhat)) +
  geom_ribbon(aes(x=LDH.preLD,ymin=lower, ymax=upper),alpha=0.10)+
  labs(x = "LDH pre-LD (U/L)",
       y = "Probability of CR")+
  #scale_x_continuous(labels = alc_breaks,breaks = c(-.5,-.25,0,.25))+
  #ggtitle("Figure.")+
  ylim(0,1) +
  theme_classic() +
  theme(title = element_text(size=16,face="bold"),legend.title=element_blank())
```

### Probability of CR: largest Lesion size, stratified by product

```{r}
data1 <- filter(dataset, Infused == 1)

dd <- datadist(data1)
options(datadist='dd')

fit <- lrm(Best.CR ~ CAR.T.Product.Type * rcs(Largest.lesion,3), data=data1)

data.frame(Predict(fit,Largest.lesion,CAR.T.Product.Type,fun = plogis)) %>%
  ggplot() +
  geom_line(aes(x=Largest.lesion ,y=yhat,col=CAR.T.Product.Type)) +
  geom_ribbon(aes(x=Largest.lesion ,ymin=lower, ymax=upper,fill=CAR.T.Product.Type),alpha=0.10)+
  labs(x = "Largest lesion (cm)",
       y = "Probability of CR")+
  theme_bw() +
  theme(title = element_text(size=16,face="bold"),legend.title=element_blank())
```

### Probability of CR: Largest Lesion size (RCS)

```{r}
data1 <- filter(dataset, Infused == 1)

dd <- datadist(data1)
options(datadist='dd')

fit <- lrm(Best.CR ~ rcs(Largest.lesion,3), data=data1)

data.frame(Predict(fit,Largest.lesion,fun = plogis)) %>%
  ggplot() +
  geom_line(aes(x=Largest.lesion ,y=yhat)) +
  geom_ribbon(aes(x=Largest.lesion ,ymin=lower, ymax=upper),alpha=0.10)+
  labs(x = "Largest lesion (cm)",
       y = "Probability of CR")+
  ylim(0,1) +
  theme_classic() +
  theme(title = element_text(size=16,face="bold"),legend.title=element_blank())
```

## Ferritin!

### Probability of ICANS based on day 3 ferritin

```{r}
data1 <- filter(dataset, Infused == 1) %>%
  mutate(
    ICANS0 = ifelse( ICANS.grade==0,1,0),
    ICANS1.2 = ifelse( ICANS.grade==1 | ICANS.grade == 2,1,0),
    ICANS.any.grade = ifelse( ICANS.grade != 0 ,1,0),
    ICANS3.4 = ifelse( ICANS.grade==3 | ICANS.grade == 4,1,0),
    ferritin.ratio = log(ferritin.d3 / ferritin.d0),
    ferritin.d3 = log10(ferritin.d3)
  )

dd <- datadist(data1)
options(datadist='dd')

fit <- lrm(ICANS0 ~ ferritin.d3 + CAR.T.Product.Type, data=data1)
df1 <- data.frame(Predict(fit,ferritin.d3,fun = plogis))


fit2 <- lrm(ICANS1.2 ~ ferritin.d3 + CAR.T.Product.Type, data=data1)
df2 <- data.frame(Predict(fit2,ferritin.d3,fun = plogis))

fit3 <- lrm(ICANS3.4 ~ ferritin.d3 + CAR.T.Product.Type, data=data1)
df3 <- data.frame(Predict(fit3,ferritin.d3,fun = plogis))

ggplot() + 
  geom_line(data=df1, aes(x=ferritin.d3,y=yhat, color = "G0 ICANS")) + geom_ribbon( data=df1, aes(x=ferritin.d3,ymin=lower, ymax=upper),alpha=0.10)+
  geom_line(data=df2, aes(x=ferritin.d3,y=yhat, color ="G1-2 ICANS" )) + geom_ribbon(data = df2, aes(x=ferritin.d3,ymin=lower, ymax=upper),alpha=0.10)+
    geom_line(data=df3, aes(x=ferritin.d3,y=yhat, color ="G\u22653 ICANS" )) + geom_ribbon(data = df3, aes(x=ferritin.d3,ymin=lower, ymax=upper),alpha=0.10)+
  labs(x = "log(ferritin, day 3) (ng/mL)",
       y = "Probability")+
  theme_bw() +
  scale_y_continuous(breaks=c(0,0.2,0.4,0.6,0.8,1.0), limits=c(0, 1)) + 
  #theme(legend.position = c(0, 1),legend.justification = c(-4.5, 1.1))+
  scale_color_manual(values = c ("steelblue","coral2","purple")) + 
  theme(title = element_text(size=20,face="bold"),legend.title=element_blank())
```

### Probability of CRS based on day 3 ferritin

```{r}
data1 <- filter(dataset, Infused == 1) %>%
  mutate(
    ICANS0 = ifelse( ICANS.grade==0,1,0),
    ICANS1.2 = ifelse( ICANS.grade==1 | ICANS.grade == 2,1,0),
    ICANS.any.grade = ifelse( ICANS.grade != 0 ,1,0),
    ICANS3.4 = ifelse( ICANS.grade==3 | ICANS.grade == 4,1,0),
    CRS0 = ifelse( CRS.grade==0,1,0),
    CRS1.2 = ifelse( CRS.grade==1 | CRS.grade == 2,1,0),
    CRS.any.grade = ifelse( CRS.grade != 0 ,1,0),
    CRS3.4 = ifelse( CRS.grade==3 | CRS.grade == 4,1,0),
    
    ferritin.ratio = log(ferritin.d3 / ferritin.d0),
    ferritin.d3 = log10(ferritin.d3)
  )

dd <- datadist(data1)
options(datadist='dd')

fit <- lrm(CRS0 ~ ferritin.d3 + CAR.T.Product.Type, data=data1)
df1 <- data.frame(Predict(fit,ferritin.d3,fun = plogis))


fit2 <- lrm(CRS1.2 ~ ferritin.d3 + CAR.T.Product.Type, data=data1)
df2 <- data.frame(Predict(fit2,ferritin.d3,fun = plogis))

fit3 <- lrm(CRS3.4 ~ ferritin.d3 + CAR.T.Product.Type, data=data1)
df3 <- data.frame(Predict(fit3,ferritin.d3,fun = plogis))

ggplot() + 
  geom_line(data=df1, aes(x=ferritin.d3,y=yhat, color = "G0 CRS")) + geom_ribbon( data=df1, aes(x=ferritin.d3,ymin=lower, ymax=upper),alpha=0.10)+
  geom_line(data=df2, aes(x=ferritin.d3,y=yhat, color ="G1-2 CRS" )) + geom_ribbon(data = df2, aes(x=ferritin.d3,ymin=lower, ymax=upper),alpha=0.10)+
    geom_line(data=df3, aes(x=ferritin.d3,y=yhat, color ="G\u22653 CRS" )) + geom_ribbon(data = df3, aes(x=ferritin.d3,ymin=lower, ymax=upper),alpha=0.10)+
  labs(x = "log(ferritin, day 3) (ng/mL)",
       y = "Probability")+
  theme_bw() +
  scale_y_continuous(breaks=c(0,0.2,0.4,0.6,0.8,1.0), limits=c(0, 1)) + 
  #theme(legend.position = c(0, 1),legend.justification = c(-4.5, 1.1))+
  scale_color_manual(values = c ("steelblue","coral2","purple")) + 
  theme(title = element_text(size=20,face="bold"),legend.title=element_blank())
```

### Probability of RESPONSE based on day 3 ferritin

```{r}
data1 <- filter(dataset, Infused == 1) %>%
  mutate(
    ICANS0 = ifelse( ICANS.grade==0,1,0),
    ICANS1.2 = ifelse( ICANS.grade==1 | ICANS.grade == 2,1,0),
    ICANS.any.grade = ifelse( ICANS.grade != 0 ,1,0),
    ICANS3.4 = ifelse( ICANS.grade==3 | ICANS.grade == 4,1,0),
    CRS0 = ifelse( CRS.grade==0,1,0),
    CRS1.2 = ifelse( CRS.grade==1 | CRS.grade == 2,1,0),
    CRS.any.grade = ifelse( CRS.grade != 0 ,1,0),
    CRS3.4 = ifelse( CRS.grade==3 | CRS.grade == 4,1,0),
    
    ferritin.ratio = log(ferritin.d3 / ferritin.d0),
    ferritin.d3 = log10(ferritin.d3)
  )

dd <- datadist(data1)
options(datadist='dd')

fit <- lrm(Best.CR ~ ferritin.d3 + CAR.T.Product.Type, data=data1)
df1 <- data.frame(Predict(fit,ferritin.d3,fun = plogis))


fit2 <- lrm(Best.PR ~ ferritin.d3 + CAR.T.Product.Type, data=data1)
df2 <- data.frame(Predict(fit2,ferritin.d3,fun = plogis))

fit3 <- lrm(Best.PD ~ ferritin.d3 + CAR.T.Product.Type, data=data1)
df3 <- data.frame(Predict(fit3,ferritin.d3,fun = plogis))

ggplot() + 
  geom_line(data=df1, aes(x=ferritin.d3,y=yhat, color = "CR")) + geom_ribbon( data=df1, aes(x=ferritin.d3,ymin=lower, ymax=upper),alpha=0.10)+
  geom_line(data=df2, aes(x=ferritin.d3,y=yhat, color ="PR" )) + geom_ribbon(data = df2, aes(x=ferritin.d3,ymin=lower, ymax=upper),alpha=0.10)+
    geom_line(data=df3, aes(x=ferritin.d3,y=yhat, color ="PD" )) + geom_ribbon(data = df3, aes(x=ferritin.d3,ymin=lower, ymax=upper),alpha=0.10)+
  labs(x = "log(ferritin, day 3) (ng/mL)",
       y = "Probability")+
  theme_bw() +
  scale_y_continuous(breaks=c(0,0.2,0.4,0.6,0.8,1.0), limits=c(0, 1)) + 
  #theme(legend.position = c(0, 1),legend.justification = c(-8.5, 1.1))+
  scale_color_manual(values = c ("steelblue","coral2","purple")) + 
  theme(title = element_text(size=20,face="bold"),legend.title=element_blank())
```

### Probability of CR or PD based on day 3 ferritin - RESTRICTED CUBIC SPLINES model

```{r}
data1 <- filter(dataset, Infused == 1) %>%
  mutate(
    ICANS0.2 = ifelse( as.numeric(ICANS.grade)<=2,1,0),
    ICANS.any.grade = ifelse( ICANS.grade != 0 ,1,0),
    ICANS3.4 = ifelse( ICANS.grade ==3 | ICANS.grade == 4,1,0),
    ferritin.ratio = ferritin.d3 / ferritin.d0
    #ferritin.d3 = log(ferritin.d3)
  )

dd <- datadist(data1)
options(datadist='dd')

fit <- lrm(Best.CR ~ rcs(ferritin.d3,3), data=data1)

df1 <- data.frame(Predict(fit,ferritin.d3,fun = plogis))



fit2 <- lrm(Best.PD ~ rcs(ferritin.d3,3), data=data1)
df2 <- data.frame(Predict(fit2,ferritin.d3,fun = plogis))

ggplot() + 
  geom_line(data=df1, aes(x=ferritin.d3,y=yhat, color = "CR")) + geom_ribbon( data=df1, aes(x=ferritin.d3,ymin=lower, ymax=upper),alpha=0.10)+
  geom_line(data=df2, aes(x=ferritin.d3,y=yhat, color ="PD" )) + geom_ribbon(data = df2, aes(x=ferritin.d3,ymin=lower, ymax=upper),alpha=0.10)+
  labs(x = "Ferritin, day 3 (ng/mL)",
       y = "Probability")+
  theme_bw() +
  scale_y_continuous(breaks=c(0,0.2,0.4,0.6,0.8,1.0), limits=c(0, 1)) + 
  #scale_x_continuous(breaks=c(0.25,0.5,0.75,1.0,1.25,1.5,1.75), limits=c(0.25, 1.75)) + 
  #theme(legend.position = c(0, 1),legend.justification = c(-9, 1.1))+
  scale_color_manual(values = c ("steelblue","coral2")) + 
  theme(title = element_text(size=20,face="bold"),legend.title=element_blank())
```

### Hazard of OS and PFS: D3 ferritin

```{r}
data1 <- filter(dataset, Infused == 1) %>%
  mutate(
    ferritin.d3 = log10(ferritin.d3)
  )

dd <- datadist(data1)
options(datadist='dd')

S1 <- Surv(data1$Days.to.DLC, data1$Death)
f1 <- cph(S1 ~ ferritin.d3 , x=TRUE, y=TRUE,surv=TRUE,data=data1)
model1 <- Predict(f1, ferritin.d3, fun=function(x) exp(x) )


S2 <- Surv(data1$Days.to.relapse.death.or.DLC, data1$Relapse.or.death)
f2 <- cph(S2 ~ ferritin.d3 , x=TRUE, y=TRUE,surv=TRUE,data=data1)
model2 <- Predict(f2, ferritin.d3, fun=function(x) exp(x) )

ggplot() + 
  geom_line(data=model1, aes(x=ferritin.d3, y=yhat, color = "OS")) +  geom_ribbon(data = model1, aes(x=ferritin.d3, ymin=lower, ymax=upper), alpha=0.1) + 
  geom_line(data=model2, aes(x=ferritin.d3, y=yhat, color = "PFS")) +  geom_ribbon(data = model2, aes(x=ferritin.d3, ymin=lower, ymax=upper), alpha=0.1) +
  theme_bw() + 
  labs(
    #title = "Survival by product and ferritin at day 3",
    x = "log(ferritin, day 3)",
    y = "Hazard") +
  #theme(legend.position = c(0, 1),legend.justification = c(-0.8, 1.2))+
  scale_color_manual(values = c ("coral2","steelblue")) + 
  theme(title = element_text(size=20,face="bold"),legend.title=element_blank())



```

### Hazard of PFS: D3 ferritin

```{r}
data1 <- filter(dataset, Infused == 1) %>%
  mutate(
    ferritin.d3 = log10(ferritin.d3)
  )

dd <- datadist(data1)
options(datadist='dd')

S <- Surv(data1$Days.to.relapse.death.or.DLC, data1$Relapse.or.death)
f <- cph(S ~ ferritin.d3 , x=TRUE, y=TRUE,surv=TRUE,data=data1)

model <- Predict(f, ferritin.d3, fun=function(x) exp(x) )

ggplot(as.data.frame(model),aes(x=ferritin.d3, y=yhat)) + 
  geom_line(
    aes()
  ) + 
  geom_ribbon(data = model, aes(ymin=lower, ymax=upper), alpha=0.2, linetype=0) + 
  theme_bw() + 
  labs(
    #title = "Survival by product and ferritin at day 3",
    x = "log(ferritin), day 3",
    y = "PFS (hazard)") +
  theme(title = element_text(size=16,face="bold"),legend.title=element_blank())
```

### Hazard of PFS: D3 ferritin - stratified by CAR-T-product

```{r}
data1 <- filter(dataset, Infused == 1) %>%
  mutate(
    ferritin.d3 = log10(ferritin.d3)
  )

dd <- datadist(data1)
options(datadist='dd')

S <- Surv(data1$Days.to.relapse.death.or.DLC, data1$Relapse.or.death)
f <- cph(S ~ ferritin.d3 + CAR.T.Product.Type , x=TRUE, y=TRUE,surv=TRUE,data=data1)

model <- Predict(f, CAR.T.Product.Type, ferritin.d3, fun=function(x) exp(x) )

ggplot(as.data.frame(model),aes(x=ferritin.d3, y=yhat, z = CAR.T.Product.Type)) + 
  geom_line(
    aes(col = CAR.T.Product.Type)
  ) + 
  geom_ribbon(data = model, aes(ymin=lower, ymax=upper), alpha=0.2, linetype=0) + 
  theme_bw() + 
  labs(
    #title = "Survival by product and ferritin at day 3",
    x = "log(ferritin), day 3",
    y = "PFS (hazard)") +
  theme(title = element_text(size=16,face="bold"),legend.title=element_blank())
```

## ICANS/CRS

### Probability of Grade 0-2 and Grade 3-4 ICANS: LDH pre-LD (RCS)

```{r}
data1 <- filter(dataset, Infused == 1) %>%
  mutate(
    ICANS0.2 = ifelse( ICANS.grade == 2 | ICANS.grade == 1 | ICANS.grade == 0,1,0),
    ICANS3.4 = ifelse( ICANS.grade == 3 | ICANS.grade == 4,1,0)
    #ferritin.d3 = log(ferritin.d3)
  )

dd <- datadist(data1)
options(datadist='dd')

fit <- lrm(ICANS0.2 ~ rcs(LDH.preLD,3), data=data1)

df1 <- data.frame(Predict(fit,LDH.preLD,fun = plogis))



fit2 <- lrm(ICANS3.4 ~ rcs(LDH.preLD,3), data=data1)
df2 <- data.frame(Predict(fit2,LDH.preLD,fun = plogis))

ggplot() + 
  geom_line(data=df1, aes(x=LDH.preLD,y=yhat, color = "0-2")) + geom_ribbon( data=df1, aes(x=LDH.preLD,ymin=lower, ymax=upper),alpha=0.10)+
  geom_line(data=df2, aes(x=LDH.preLD,y=yhat, color ="3-4" )) + geom_ribbon(data = df2, aes(x=LDH.preLD,ymin=lower, ymax=upper),alpha=0.10)+
  labs(x = "LDH pre-LD (U/L)",
       y = "Probability")+
  theme_bw() +
  scale_y_continuous(breaks=c(0,0.2,0.4,0.6,0.8,1.0), limits=c(0, 1)) + 
  #scale_x_continuous(breaks=c(0.25,0.5,0.75,1.0,1.25,1.5,1.75), limits=c(0.25, 1.75)) + 
  #theme(legend.position = c(0, 1),legend.justification = c(-9, 1.1))+
  scale_color_manual(values = c ("steelblue","coral2")) + 
  theme(title = element_text(size=20,face="bold"),legend.title=element_blank())
```

### Probability of any grade CRS based on Age

```{r}
data1 <- filter(dataset, Infused == 1) %>%
  select(CRS.grade, ICANS.grade, Age, CAR.T.Product.Type) %>%
  mutate(
    CRS.any = ifelse( CRS.grade != 0,1,0),
    ICANS.any = ifelse( ICANS.grade !=0,1,0)
  )

dd <- datadist(data1)
options(datadist='dd')

fit <- lrm(CRS.any ~ CAR.T.Product.Type *Age, data=data1)

data.frame(Predict(fit,Age,CAR.T.Product.Type,fun = plogis)) %>%
  ggplot() +
  geom_line(aes(x=Age,y=yhat,col=CAR.T.Product.Type)) +
  geom_ribbon(aes(x=Age,ymin=lower, ymax=upper,fill=CAR.T.Product.Type),alpha=0.10)+
  labs(x = "Age (years)",
       y = "Probability of any grade CRS")+
  theme_bw() +
  theme(title = element_text(size=16,face="bold"),legend.title=element_blank())
```

### Probability of any grade ICANS based on Age

```{r}
data1 <- filter(dataset, Infused == 1) %>%
  select(CRS.grade, ICANS.grade, Age, CAR.T.Product.Type) %>%
  mutate(
    CRS.any = ifelse( CRS.grade != 0,1,0),
    ICANS.any = ifelse( ICANS.grade !=0,1,0)
  )
dd <- datadist(data1)
options(datadist='dd')

dd <- datadist(data1)
options(datadist='dd')

fit <- lrm(ICANS.any ~ CAR.T.Product.Type * Age, data=data1)

data.frame(Predict(fit,Age,CAR.T.Product.Type,fun = plogis)) %>%
  ggplot() +
  geom_line(aes(x=Age,y=yhat,col=CAR.T.Product.Type)) +
  geom_ribbon(aes(x=Age,ymin=lower, ymax=upper,fill=CAR.T.Product.Type),alpha=0.10)+
  labs(x = "Age (years)",
       y = "Probability of any grade ICANS")+
  #scale_x_continuous(labels = alc_breaks,breaks = c(-.5,-.25,0,.25))+
  #ggtitle("Figure.")+
  theme_bw() +
  theme(title = element_text(size=16,face="bold"),legend.title=element_blank())
```

### Probability of Any grade and G3+ CRS: Age

```{r}
data1 <- filter(dataset, Infused == 1) %>%
  select(CRS.grade, ICANS.grade, Age, CAR.T.Product.Type) %>%
  mutate(
    CRS3.4 = ifelse( CRS.grade == 3 | CRS.grade == 4,1,0),
    ICANS3.4 = ifelse( ICANS.grade == 3 | ICANS.grade == 4,1,0),
    CRS.any = ifelse( CRS.grade !=0 ,1,0),
    ICANS.any = ifelse( ICANS.grade !=0,1,0)
  )

dd <- datadist(data1)
options(datadist='dd')


fit1 <- lrm(CRS3.4 ~ CAR.T.Product.Type + Age, data=data1)

df1 <- data.frame(Predict(fit1,Age,fun = plogis))



fit2 <- lrm(CRS.any ~ CAR.T.Product.Type + Age, data=data1)
df2 <- data.frame(Predict(fit2,Age,fun = plogis))

ggplot() + 
  geom_line(data=df1, aes(x=Age,y=yhat, color = "\u22653")) + geom_ribbon( data=df1, aes(x=Age,ymin=lower, ymax=upper),alpha=0.10)+
  geom_line(data=df2, aes(x=Age,y=yhat, color ="Any" )) + geom_ribbon(data = df2, aes(x=Age,ymin=lower, ymax=upper),alpha=0.10)+
  labs(x = "Age (years)",
       y = "Probability of CRS")+
  theme_bw() +
  scale_y_continuous(breaks=c(0,0.2,0.4,0.6,0.8,1.0), limits=c(0, 1)) + 
  #scale_x_continuous(breaks=c(0.25,0.5,0.75,1.0,1.25,1.5,1.75), limits=c(0.25, 1.75)) + 
  #theme(legend.position = c(0, 1),legend.justification = c(-8.3, 3))+
  scale_color_manual(values = c ("coral2","steelblue")) + 
  theme(title = element_text(size=20,face="bold"),legend.title=element_blank())
```

### Probability of any grade and 3+ ICANS: Age

```{r}
data1 <- filter(dataset, Infused == 1) %>%
  select(CRS.grade, ICANS.grade, Age, CAR.T.Product.Type) %>%
  mutate(
    CRS3.4 = ifelse( CRS.grade == 3 | CRS.grade == 4,1,0),
    ICANS3.4 = ifelse( ICANS.grade == 3 | ICANS.grade == 4,1,0),
    CRS.any = ifelse( CRS.grade !=0 ,1,0),
    ICANS.any = ifelse( ICANS.grade !=0,1,0)
  )

dd <- datadist(data1)
options(datadist='dd')

fit1 <- lrm(ICANS3.4 ~ CAR.T.Product.Type + Age, data=data1)
df1 <- data.frame(Predict(fit1,Age,fun = plogis))

fit2 <- lrm(ICANS.any ~ CAR.T.Product.Type + Age, data=data1)
df2 <- data.frame(Predict(fit2,Age,fun = plogis))

ggplot() + 
  geom_line(data=df1, aes(x=Age,y=yhat, color = "\u22653")) + geom_ribbon( data=df1, aes(x=Age,ymin=lower, ymax=upper),alpha=0.10)+
  geom_line(data=df2, aes(x=Age,y=yhat, color ="Any" )) + geom_ribbon(data = df2, aes(x=Age,ymin=lower, ymax=upper),alpha=0.10)+
  labs(x = "Age (years)",
       y = "Probability of ICANS")+
  theme_bw() +
  scale_y_continuous(breaks=c(0,0.2,0.4,0.6,0.8,1.0), limits=c(0, 1)) + 
  #scale_x_continuous(breaks=c(0.25,0.5,0.75,1.0,1.25,1.5,1.75), limits=c(0.25, 1.75)) + 
  #theme(legend.position = c(0, 1),legend.justification = c(-8.3, 1.1))+
  scale_color_manual(values = c ("coral2","steelblue")) + 
  theme(title = element_text(size=20,face="bold"),legend.title=element_blank())
```

## PFS & OS

### Hazard of PFS: LDH - stratified by bulky status

```{r}
data1 <- filter(dataset, Infused == 1) %>%
  mutate(
    Bulky = recode(Bulky, "1"="Bulky","0"="Not bulky")
  )

dd <- datadist(data1)
options(datadist='dd')

S <- Surv(data1$Days.to.relapse.death.or.DLC, data1$Relapse.or.death)
f <- cph(S ~ LDH.preLD * Bulky , x=TRUE, y=TRUE,surv=TRUE,data=data1)

med <- Quantile(f)
model <- Predict(f, Bulky, LDH.preLD, fun=function(x) exp(x) )

ggplot(as.data.frame(model),aes(x=LDH.preLD , y=yhat, z = Bulky)) + 
  geom_line(
    aes(col = Bulky)
  ) + 
  geom_ribbon(data = model, aes(ymin=lower, ymax=upper), alpha=0.2, linetype=0) + 
  theme_bw() + 
  labs(
    #title = "Survival by CAR-T product and ALC pre-LD",
     x = "LDH pre-LD (U/L)",
     y = "PFS (hazard)")+
  theme(title = element_text(size=16,face="bold"),legend.title=element_blank())
```

### Hazard of OS: LDH - stratified by bulky status

```{r}
data1 <- filter(dataset, Infused == 1) %>%
  mutate(
    Bulky = recode(Bulky, "1"="Bulky","0"="Not bulky")
  )

dd <- datadist(data1)
options(datadist='dd')

S <- Surv(data1$Days.to.DLC, data1$Death)
f <- cph(S ~ LDH.preLD * Bulky , x=TRUE, y=TRUE,surv=TRUE,data=data1)

med <- Quantile(f)
model <- Predict(f, Bulky, LDH.preLD, fun=function(x) exp(x) )

ggplot(as.data.frame(model),aes(x=LDH.preLD , y=yhat, z = Bulky)) + 
  geom_line(
    aes(col = Bulky)
  ) + 
  geom_ribbon(data = model, aes(ymin=lower, ymax=upper), alpha=0.2, linetype=0) + 
  theme_bw() + 
  labs(
    #title = "Survival by CAR-T product and ALC pre-LD",
     x = "LDH pre-LD (U/L)",
     y = "OS (hazard)")+
  theme(title = element_text(size=16,face="bold"),legend.title=element_blank())
```

### Hazard of OS: LDH, stratified

```{r}
data1 <- filter(dataset, Infused == 1)

dd <- datadist(data1)
options(datadist='dd')

S <- Surv(data1$Days.to.DLC, data1$Death)
f <- cph(S ~ LDH.preLD , x=TRUE, y=TRUE,surv=TRUE,data=data1)

med <- Quantile(f)
model <- Predict(f, LDH.preLD, fun=function(x) exp(x) )

ggplot(as.data.frame(model),aes(x=LDH.preLD , y=yhat)) + 
  geom_line() + 
  geom_ribbon(data = model, aes(ymin=lower, ymax=upper), alpha=0.2, linetype=0) + 
  theme_bw() + 
  labs(
    #title = "Survival by LDH pre-LD",
    x = "LDH pre-LD (U/L)",
    y = "OS (hazard)")+
  theme(title = element_text(size=16,face="bold"),legend.title=element_blank())
```

### Hazard of PFS: LDH, stratified by product

```{r}
data1 <- filter(dataset, Infused == 1) 

dd <- datadist(data1)
options(datadist='dd')

S <- Surv(data1$Days.to.relapse.death.or.DLC, data1$Relapse.or.death)
f <- cph(S ~ LDH.preLD * CAR.T.Product.Type , x=TRUE, y=TRUE,surv=TRUE,data=data1)



model <- Predict(f, CAR.T.Product.Type, LDH.preLD, fun=function(x) exp(x) )

ggplot(as.data.frame(model),aes(x=LDH.preLD, y=yhat, z = CAR.T.Product.Type)) + 
  geom_line(
    aes(col = CAR.T.Product.Type)
  ) + 
  geom_ribbon(data = model, aes(ymin=lower, ymax=upper), alpha=0.2, linetype=0) + 
  theme_bw() + 
  labs(
    #title = "Survival by product and LDH pre-LD",
    x = "LDH pre-LD (U/L)",
    y = "PFS (hazard)") +
  theme(title = element_text(size=16,face="bold"),legend.title=element_blank())
```

### Hazard of PFS: LDH, stratified by bulky status

```{r}
data1 <- filter(dataset, Infused == 1) %>%
  mutate(
    Bulky = recode(Bulky,"1"="Bulky","0"="Not bulky")
  )

dd <- datadist(data1)
options(datadist='dd')

S <- Surv(data1$Days.to.relapse.death.or.DLC, data1$Relapse.or.death)
f <- cph(S ~ LDH.preLD * Bulky , x=TRUE, y=TRUE,surv=TRUE,data=data1)

model <- Predict(f, Bulky, LDH.preLD, fun=function(x) exp(x) )

ggplot(as.data.frame(model),aes(x=LDH.preLD, y=yhat, z = Bulky)) + 
  geom_line(
    aes(col = Bulky)
  ) + 
  geom_ribbon(data = model, aes(ymin=lower, ymax=upper), alpha=0.2, linetype=0) + 
  theme_bw() + 
  labs(
    #title = "Survival by product and LDH pre-LD",
    x = "LDH pre-LD (U/L)",
    y = "PFS (hazard)") +
  theme(title = element_text(size=16,face="bold"),legend.title=element_blank())
```

### Hazard of OS: LDH, stratified by bulky status

```{r}
data1 <- filter(dataset, Infused == 1)%>%
  mutate(
    Bulky = recode(Bulky,"1"="Bulky","0"="Not bulky")
  )

dd <- datadist(data1)
options(datadist='dd')

S <- Surv(data1$Days.to.DLC, data1$Death)
f <- cph(S ~ LDH.preLD * Bulky , x=TRUE, y=TRUE,surv=TRUE,data=data1)

model <- Predict(f, Bulky, LDH.preLD, fun=function(x) exp(x) )

ggplot(as.data.frame(model),aes(x=LDH.preLD, y=yhat, z = Bulky)) + 
  geom_line(
    aes(col = Bulky)
  ) + 
  geom_ribbon(data = model, aes(ymin=lower, ymax=upper), alpha=0.2, linetype=0) + 
  theme_bw() + 
  labs(
    #title = "Survival by product and LDH pre-LD",
    x = "LDH pre-LD (U/L)",
    y = "OS (hazard)") +
  theme(title = element_text(size=16,face="bold"),legend.title=element_blank())
```

### Hazard of PFS: LDH

```{r}
data1 <- filter(dataset, Infused == 1)

dd <- datadist(data1)
options(datadist='dd')

S <- Surv(data1$Days.to.relapse.death.or.DLC, data1$Relapse.or.death)
f <- cph(S ~ LDH.preLD , x=TRUE, y=TRUE,surv=TRUE,data=data1)

model <- Predict(f, LDH.preLD, fun=function(x) exp(x) )

ggplot(as.data.frame(model),aes(x=LDH.preLD, y=yhat)) + 
  geom_line(
    aes()
  ) + 
  geom_ribbon(data = model, aes(ymin=lower, ymax=upper), alpha=0.2, linetype=0) + 
  theme_bw() + 
  labs(
    #title = "Survival by product and LDH pre-LD",
    x = "LDH pre-LD (U/L)",
    y = "PFS (hazard)") +
  theme(title = element_text(size=16,face="bold"),legend.title=element_blank())
```

### Hazard of OS: Largest lesion

```{r}
data1 <- dataset

dd <- datadist(data1)
options(datadist='dd')

S <- Surv(data1$Days.to.DLC, data1$Death)
f <- cph(S ~ Largest.lesion, x=TRUE, y=TRUE,surv=TRUE,data=data1)

med <- Quantile(f)
model <- Predict(f, Largest.lesion, fun=function(x) exp(x) )

ggplot(as.data.frame(model),aes(x=Largest.lesion , y=yhat)) + 
  geom_line() + 
  geom_ribbon(data = model, aes(ymin=lower, ymax=upper), alpha=0.2, linetype=0) + 
  theme_bw() + 
  labs(
    #title = "Survival by LDH pre-LD",
    x = "Largest lesion (cm)",
    y = "OS (hazard)")+
  theme(title = element_text(size=16,face="bold"),legend.title=element_blank())
```

### Hazard of OS: Cr

```{r}
data1 <- filter(dataset, Infused == 1) 

dd <- datadist(data1)
options(datadist='dd')

S <- Surv(data1$Days.to.DLC, data1$Death)
f <- cph(S ~ rcs(cre.preLD,3) , x=TRUE, y=TRUE,surv=TRUE,data=data1)



model <- Predict(f, cre.preLD, fun=function(x) exp(x) )

ggplot(as.data.frame(model),aes(x=cre.preLD, y=yhat)) + 
  geom_line(
    aes()
  ) + 
  geom_ribbon(data = model, aes(ymin=lower, ymax=upper), alpha=0.2, linetype=0) + 
  theme_bw() + 
  labs(
    #title = "Survival by product and pre-LD Cr",
    x = "Pre-LD Cr (U/L)",
    y = "OS (hazard)") +
  theme(title = element_text(size=16,face="bold"),legend.title=element_blank())
```

# CURVE SMOOTHING

## ANC Loess modeling -- stratified by product

```{r}

data1 <- CBCdata %>%
  mutate(
    CAR.T.Product.Type = recode(CAR.T.Product.Type, "Breyanzi" = "Liso-cel", "Yescarta" = "Axi-cel")
  )

ggplot() + 
  geom_smooth(data = filter(data1, CAR.T.Product.Type == "Liso-cel"), aes(x = day, y = ancx, color = "Liso-cel"), method = "loess", formula = y~x, fill = "#69b3a2", se = TRUE, na.rm = TRUE) + 
  geom_smooth(data = filter(data1, CAR.T.Product.Type == "Axi-cel"), aes(x = day, y = ancx, color = "Axi-cel"), method = "loess", formula = y~x, fill = "#69b3a2", se = TRUE, na.rm = TRUE) + 
  labs(
    x = "Time relative to infusion (days)",
    y = "Absolute neutrophil count (cells/µL)",
    color = "Legend"
  ) + 
  scale_y_continuous(breaks = c(0, 1000, 2000, 3000, 4000, 5000, 6000)) +
  xlim(-5, 50) +
  theme_classic() + 
  theme(legend.position = c(0.8, 0.9)) +
  scale_color_manual(values = c("steelblue", "coral2")) +
  theme(text = element_text(size = 16))
```

## Plt Loess modeling -- stratified by product

```{r}
data1 <- CBCdata %>%
  mutate(
    CAR.T.Product.Type = recode(CAR.T.Product.Type, "Breyanzi" = "Liso-cel", "Yescarta" = "Axi-cel")
  )

ggplot() + 
  geom_smooth(data = filter(data1, CAR.T.Product.Type == "Liso-cel"), aes(x=day, y=TotPlateletCnt/1000, color = "Liso-cel"), method="loess" , formula = y~x, fill="#69b3a2", se=TRUE, na.rm = TRUE) + 
  geom_smooth(data = filter(data1, CAR.T.Product.Type == "Axi-cel"), aes(x=day, y=TotPlateletCnt/1000, color = "Axi-cel"),method="loess" , formula = y~x , fill="#69b3a2", se=TRUE, na.rm = TRUE) + 
  labs(x = "Time relative to infusion (days)",
       y = "Platelet count (10\u00B3/\u00B5L)",
       color = "Legend") + 
  theme_classic() + 
  xlim(-5,50) +
  scale_color_manual(values = c ("steelblue","coral2")) + 
  theme(legend.position=c(.8,.9)) +
  theme(text = element_text(size = 16))  
```

## Ferritin Loess modeling -- stratified by CRS
```{r}
ferritin.data = filter(labs, day >=-5 & day <=30) %>%
  select(day, time, ferritin_ng_ml, uwid) %>%
  mutate(
    time.percent = sapply( strsplit(time,":"),
                           function(x) {
                             x <- as.numeric(x)
                             x[1]/24
                           }
    ),
    day = ifelse(day>=0, day + time.percent, day - time.percent),
    ferritin = log10(ferritin_ng_ml)
  )

ferritin.data <-
  left_join(
    x = ferritin.data,
    y = dataset %>%
      select(CAR.T.Product.Type, CRS.grade, uwid, Study.No),
    by = "uwid"
  )

ggplot() + 
    geom_smooth(data = filter(ferritin.data, CRS.grade == "3" | CRS.grade == "4"), aes(x=day, y=ferritin_ng_ml, color = "G\u22653 CRS"),method="loess" , formula = y~x , fill="#69b3a2", se=TRUE, na.rm = TRUE) + 
  geom_smooth(data = filter(ferritin.data, CRS.grade == "1" | CRS.grade == "2"), aes(x=day, y=ferritin_ng_ml, color = "G1-2 CRS"),method="loess" , formula = y~x , fill="#69b3a2", se=TRUE, na.rm = TRUE) + 
    geom_smooth(data = filter(ferritin.data, CRS.grade == "0"), aes(x=day, y=ferritin_ng_ml, color = "G0 CRS"),method="loess" , formula = y~x , fill="#69b3a2", se=TRUE, na.rm = TRUE) + 
  labs(x = "Time relative to infusion (days)",
       y = "Ferritin (ng/mL)",
       color = "Legend") +
  theme_classic() + 
  theme(legend.position=c(.8,.8)) +
  theme(text = element_text(size = 16))  +
  scale_color_manual(values = c ("coral2","purple","steelblue")) +
  coord_cartesian(ylim = c(0, 9000), xlim = c(0, 30))
```

## Ferritin Loess modeling -- stratified by ICANS

```{r}
ferritin.data = filter(labs, day >=-5 & day <=30) %>%
  select(day, time, ferritin_ng_ml, uwid) %>%
  mutate(
    time.percent = sapply( strsplit(time,":"),
                           function(x) {
                             x <- as.numeric(x)
                             x[1]/24
                           }
    ),
    day = ifelse(day>=0, day + time.percent, day - time.percent),
    ferritin = log10(ferritin_ng_ml)
  )

ferritin.data <-
  left_join(
    x = ferritin.data,
    y = dataset %>%
      select(CAR.T.Product.Type, CRS.grade, ICANS.grade, uwid, Study.No),
    by = "uwid"
  )

ggplot() + 
    geom_smooth(data = filter(ferritin.data, ICANS.grade == "3" | CRS.grade == "4"), aes(x=day, y=ferritin_ng_ml, color = "G\u22653 ICANS"),method="loess" , formula = y~x , fill="#69b3a2", se=TRUE, na.rm = TRUE) + 
  geom_smooth(data = filter(ferritin.data, ICANS.grade == "1" | CRS.grade == "2"), aes(x=day, y=ferritin_ng_ml, color = "G1-2 ICANS"),method="loess" , formula = y~x , fill="#69b3a2", se=TRUE, na.rm = TRUE) + 
    geom_smooth(data = filter(ferritin.data, ICANS.grade == "0"), aes(x=day, y=ferritin_ng_ml, color = "G0 ICANS"),method="loess" , formula = y~x , fill="#69b3a2", se=TRUE, na.rm = TRUE) + 
  labs(x = "Time relative to infusion (days)",
       y = "Ferritin (ng/mL)",
       color = "Legend") + 
  theme_classic() + 
  theme(legend.position=c(.2,.8)) +
  theme(text = element_text(size = 16))  +
  scale_color_manual(values = c ("coral2","purple","steelblue")) +
  coord_cartesian(ylim = c(0, 9000), xlim = c(0, 30))

```

## Ferritin Loess modeling -- stratified by response

```{r}
ferritin.data = filter(labs, day >=-5 & day <=30) %>%
  select(day, time, ferritin_ng_ml, uwid) %>%
  mutate(
    time.percent = sapply( strsplit(time,":"),
                           function(x) {
                             x <- as.numeric(x)
                             x[1]/24
                           }
    ),
    day = ifelse(day>=0, day + time.percent, day - time.percent),
    ferritin = log10(ferritin_ng_ml)
  )

ferritin.data <-
  left_join(
    x = ferritin.data,
    y = dataset %>%
      select(CAR.T.Product.Type, CRS.grade, ICANS.grade, uwid, Study.No, Best.CR, Best.PR, Best.PD),
    by = "uwid"
  )

ggplot() + 
    geom_smooth(data = filter(ferritin.data, Best.CR == 1), aes(x=day, y=ferritin_ng_ml, color = "CR"),method="loess" , formula = y~x , fill="#69b3a2", se=TRUE, na.rm = TRUE) + 
  geom_smooth(data = filter(ferritin.data, Best.PR == 1), aes(x=day, y=ferritin_ng_ml, color = "PR"),method="loess" , formula = y~x , fill="#69b3a2", se=TRUE, na.rm = TRUE) + 
    geom_smooth(data = filter(ferritin.data, Best.PD == 1), aes(x=day, y=ferritin_ng_ml, color = "PD"),method="loess" , formula = y~x , fill="#69b3a2", se=TRUE, na.rm = TRUE) + 
  labs(x = "Time relative to infusion (days)",
       y = "Ferritin (ng/mL)",
       color = "Legend") + 
  theme_classic() + 
  theme(legend.position=c(.2,.8)) +
  theme(text = element_text(size = 16))  +
  scale_color_manual(values = c ("coral2","purple","steelblue")) +
  coord_cartesian(ylim = c(0, 9000), xlim = c(0, 30))
```

## Ferritin Loess modeling -- stratified by product

```{r}
ferritin.data = filter(labs, day >=-5 & day <=30) %>%
  select(day, time, ferritin_ng_ml, uwid) %>%
  mutate(
    time.percent = sapply( strsplit(time,":"),
                           function(x) {
                             x <- as.numeric(x)
                             x[1]/24
                           }
    ),
    day = ifelse(day>=0, day + time.percent, day - time.percent),
    ferritin = log10(ferritin_ng_ml)
  )

ferritin.data <-
  left_join(
    x = ferritin.data,
    y = dataset %>%
      select(CAR.T.Product.Type, CRS.grade, ICANS.grade, uwid, Study.No, Best.CR, Best.PR, Best.PD),
    by = "uwid"
  )

ggplot() + 
    geom_smooth(data = filter(ferritin.data, CAR.T.Product.Type == "Breyanzi"), aes(x=day, y=ferritin_ng_ml, color = "Liso-cel"),method="loess" , formula = y~x , fill="#69b3a2", se=TRUE, na.rm = TRUE) + 
  geom_smooth(data = filter(ferritin.data, CAR.T.Product.Type == "Yescarta"), aes(x=day, y=ferritin_ng_ml, color = "Axi-cel"),method="loess" , formula = y~x , fill="#69b3a2", se=TRUE, na.rm = TRUE) + 
  labs(x = "Time relative to infusion (days)",
       y = "Ferritin (ng/mL)",
       color = "Legend") + 
  theme_classic() + 
  theme(legend.position=c(.2,.8)) +
  theme(text = element_text(size = 16))  +
  scale_color_manual(values = c ("coral2","purple","steelblue")) +
  coord_cartesian(ylim = c(0, 5000), xlim = c(0, 30))
```
  
# CONTOUR PLOTS

## Contour plot for largest lesion and LDH pre-LD

```{r}
data1 <- filter(dataset, CAR.T.Product.Type == "Breyanzi")
dd <- datadist(data1)
options(datadist='dd')

S <- Surv(data1$Days.to.DLC/30, data1$Death)
f <- cph(S ~ Largest.lesion * LDH.preLD , x=TRUE, y=TRUE,surv=TRUE,data=data1)


med <- Quantile(f)
data.frame(Predict(f,Largest.lesion,LDH.preLD,fun=function(x) med(lp=x))) %>%
  ggplot() +
  geom_contour_filled(aes(Largest.lesion,LDH.preLD, z = yhat)) +
  theme_classic() +
  labs(title = "Liso-cel",
       x = "Largest lesion (cm)",
       y = "LDH pre-LD (U/L)",
       fill="Median survival (months)")  +
  coord_cartesian(xlim = c(0, 10), ylim = c(100, 700))

data1 <- filter(dataset, CAR.T.Product.Type == "Yescarta") %>%
  select(Largest.lesion, LDH.preLD, Days.to.DLC, Death
  )
dd <- datadist(data1)
options(datadist='dd')

S <- Surv(data1$Days.to.DLC/30, data1$Death)
f <- cph(S ~ Largest.lesion * LDH.preLD , x=TRUE, y=TRUE,surv=TRUE,data=data1)

med <- Quantile(f)
data.frame(Predict(f,Largest.lesion,LDH.preLD,fun=function(x) med(lp=x))) %>%
  ggplot() +
  geom_contour_filled(aes(Largest.lesion,LDH.preLD, z = yhat)) +
  theme_classic() +
  labs(title = "Axi-cel",
       x = "Largest lesion (cm)",
       y = "LDH pre-LD (U/L)",
       fill="Median survival (months)") +
  coord_cartesian(xlim = c(0, 10), ylim = c(100, 700))
```

## Contour plot for Age and ALC pre-LD

```{r}
data1 <- filter(dataset, Infused == 1)
dd <- datadist(data1)
options(datadist='dd')

S <- Surv(data1$Days.to.DLC, data1$Death)
f <- cph(S ~ Age * ALC.preLD , x=TRUE, y=TRUE,surv=TRUE,data=data1)

med <- Quantile(f)
data.frame(Predict(f,Age,ALC.preLD,fun=function(x) med(lp=x)/365.25)) %>%
  ggplot() +
  geom_contour_filled(aes(Age,ALC.preLD, z = yhat)) +
  theme_classic() +
  labs(title = "Survival: ALC pre-LD and Age",
       x = "Age (years)",
       y = "ALC pre-LD (10\U00B3/\U00B5L)",
       fill="Median survival (years)") 
```


# Swimmer's plot
## Swimmer plot
```{r}
swimmer_data = as.data.frame(read_excel(path = "Swimmer.xlsx")) %>%
  mutate(
    Response_start = Response_start/30,
    Response_end = Response_end/30,
    Time = Time/30,
    Product = recode(Product, "Breyanzi" = "Liso-cel","Yescarta"="Axi-cel"),
    Response = factor(Response, levels = c("CR","PR","SD", "PD"))
  )

pastel1_palette <- brewer.pal(4, "Pastel1")[c(3,2,4,1)]


swimmer <- swimmer_plot(df=filter(swimmer_data, !is.na(Response) ), 
            id="Number",
            end= "Response_end", 
            name_fill="Response",
            stratify = "Product",
            ) +
  scale_fill_manual(values = pastel1_palette) +
  swimmer_arrows(df_arrows = filter(swimmer_data,!is.na(Continued_response) ),
                 id="Number",
                 arrow_start="Response_end", 
                 name_col = 'Response', 
                 type = "closed", cex=.5, 
                 arrow_positions = c(1,6)
                 )+ 
  scale_color_manual(name="Response",values=pastel1_palette,drop=FALSE) +
  swimmer_points(df_points= filter(swimmer_data,!is.na(Event) ) ,id='Number',name_shape = "Event", time='Time',size=1,fill='white',col="black") +
  scale_y_continuous(name = "Time since infusion (Months)",breaks = seq(0,10000,by=12)) +
  guides(fill = guide_legend(title = "Response"), colour = FALSE)  # Hide the legend for arrows
swimmer
```

